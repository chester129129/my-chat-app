<!DOCTYPE html>
<html>
<head>
  <title>ì±„íŒ… í”„ë¡œê·¸ë¨ / Programa de chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: linear-gradient(135deg, #e0eafc, #cfdef3); 
      margin: 0; 
      padding: 10px; 
      animation: backgroundShift 10s infinite alternate; 
    }
    @keyframes backgroundShift { 
      0% { background: linear-gradient(135deg, #e0eafc, #cfdef3); } 
      100% { background: linear-gradient(135deg, #cfdef3, #e0eafc); } 
    }
    .container { max-width: 1000px; margin: 0 auto; }
    .tabs { 
      display: flex; 
      flex-wrap: wrap; 
      background: #a3cffa; 
      border-radius: 15px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      overflow: hidden; 
    }
    .tabs button { 
      flex: 1; 
      padding: 12px; 
      border: none; 
      background: #a3cffa; 
      color: #333; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      font-size: 16px; 
    }
    .tabs button:hover { background: #89bffa; }
    .tabs button.active { background: #6bafff; color: white; }
    .tab-content { 
      display: none; 
      padding: 15px; 
      background: white; 
      border-radius: 15px; 
      margin-top: 10px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      animation: fadeIn 0.3s ease; 
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #chat-messages, #all-chat-messages { 
      height: 60vh; 
      overflow-y: auto; 
      border: 1px solid #e0e0e0; 
      padding: 10px; 
      background: #fafafa; 
      border-radius: 10px; 
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); 
    }
    #chat-room button, #all-chat button { 
      background: #ffd1dc; 
      border: none; 
      padding: 10px 15px; 
      margin: 5px; 
      border-radius: 10px; 
      cursor: pointer; 
      color: #333; 
      transition: all 0.3s ease; 
      font-size: 16px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    #chat-room button:hover, #all-chat button:hover { background: #ffb6c1; transform: scale(1.05); }
    #users button, #friends button, #settings-content button { 
      background: linear-gradient(135deg, #ffd1dc, #a3cffa); 
      border: none; 
      padding: 12px 18px; 
      margin: 8px; 
      border-radius: 12px; 
      cursor: pointer; 
      color: #333; 
      transition: all 0.3s ease; 
      font-size: 16px; 
      box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
    }
    #users button:hover, #friends button:hover, #settings-content button:hover { 
      transform: scale(1.05); 
      box-shadow: 0 5px 12px rgba(0,0,0,0.2); 
    }
    img.profile-pic { width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
    img.message-media, video { max-width: 200px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .unread { color: #ff6b6b; font-weight: 600; }
    #emoji-picker, #emoji-picker-all { 
      display: none; 
      position: absolute; 
      background: white; 
      border: 1px solid #ddd; 
      padding: 8px; 
      border-radius: 10px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
    }
    input[type="text"], input[type="file"] { 
      padding: 10px; 
      margin: 5px; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      width: calc(100% - 22px); 
      box-sizing: border-box; 
      font-size: 16px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    
    #message, #all-message {
      color: black;
      font-weight: normal;
      transition: color 0.3s ease;
    }
    
    /* Theme-specific colors for inputs */
    .theme-dark #message, .theme-dark #all-message {
      background-color: #333;
      color: white;
      border-color: #555;
    }
    
    .theme-pastel #message, .theme-pastel #all-message {
      background-color: #fff5f5;
      border-color: #ffcdd2;
    }
    #login { 
      background: #fff3e6; 
      padding: 30px; 
      border-radius: 20px; 
      box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
      text-align: center; 
      margin: 40px auto; 
      max-width: 400px; 
      position: relative; 
      overflow: hidden; 
    }
    #login::before { 
      content: 'ğŸŒŸâœ¨ğŸ˜Š Bienvenido / í™˜ì˜í•©ë‹ˆë‹¤ ğŸ˜Šâœ¨ğŸŒŸ'; 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      text-align: center; 
      font-size: 18px; 
      color: #ff6b6b; 
      animation: sparkle 2s infinite; 
    }
    @keyframes sparkle { 
      0%, 100% { opacity: 1; } 
      50% { opacity: 0.5; } 
    }
    #login input[type="text"], #login input[type="password"] { 
      background: #fff; 
      border: 2px solid #ffd1dc; 
      padding: 12px; 
      font-size: 16px; 
    }
    #login button { 
      background: linear-gradient(135deg, #ffd1dc, #a3cffa); 
      padding: 12px 20px; 
      border: none; 
      border-radius: 12px; 
      color: #333; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
    }
    #login button:hover { transform: scale(1.05); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }
    #login label { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      margin: 10px 0; 
      font-size: 14px; 
      color: #666; 
    }
    #login input[type="checkbox"] { 
      margin-right: 8px; 
    }
    #settings-profile { 
      display: flex; 
      align-items: center; 
      padding: 15px; 
      background: linear-gradient(135deg, #a3cffa, #ffd1dc); 
      border-radius: 10px; 
      margin-bottom: 15px; 
      box-shadow: 0 3px 8px rgba(0,0,0,0.1); 
    }
    #settings-profile img { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; }
    #settings-profile span { font-size: 1.2em; font-weight: bold; color: #333; }
    .settings-sub { 
      background: linear-gradient(135deg, #ffd1dc, #a3cffa); 
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
      text-align: center; 
    }
    .settings-sub button { 
      background: #fff3e6; 
      color: #333; 
      font-weight: 600; 
      padding: 12px 20px; 
      border-radius: 12px; 
      margin: 10px; 
      font-size: 16px; 
      transition: all 0.3s ease; 
      box-shadow: 0 3px 8px rgba(0,0,0,0.1); 
    }
    .settings-sub button:hover { transform: scale(1.05); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }
    .settings-sub p { font-size: 1em; color: #333; }
    .sound-table { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 10px; 
      margin: 15px 0; 
    }
    .sound-table button { 
      padding: 10px; 
      font-size: 16px; 
    }
    .message { padding: 8px; margin: 5px 0; border-radius: 8px; background: #f0f4f8; font-size: 14px; }
    .timestamp { font-size: 0.7em; color: #666; }
    .settings-btn { 
      background: linear-gradient(135deg, #ffebcc, #cce5ff); 
      border: none; 
      padding: 15px 25px; 
      margin: 10px; 
      border-radius: 15px; 
      cursor: pointer; 
      color: #333; 
      font-weight: 600; 
      font-size: 18px; 
      transition: all 0.3s ease; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    .settings-btn:hover { 
      transform: scale(1.05); 
      box-shadow: 0 6px 15px rgba(0,0,0,0.2); 
    }
    .online-users, .offline-users { 
      margin-top: 10px; 
      padding: 10px; 
      background: #e6f7ff; 
      border-radius: 10px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    .offline-users { background: #f0f0f0; }
    .section-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
    
    /* Monera System Styles */
    .monera-display {
      background: linear-gradient(135deg, #ffd700, #ffb6c1);
      padding: 10px;
      border-radius: 10px;
      margin-left: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-weight: bold;
      display: inline-flex;
      align-items: center;
    }
    .monera-icon {
      margin-right: 5px;
      font-size: 1.2em;
    }
    .color-picker, .emoji-categories {
      display: flex;
      flex-wrap: wrap;
      margin: 5px 0;
    }
    .color-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin: 3px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    .color-btn.selected {
      border-color: #333;
      transform: scale(1.1);
    }
    .emoji-category-btn {
      padding: 5px 10px;
      margin: 3px;
      border-radius: 10px;
      background: #f0f4f8;
      cursor: pointer;
      border: 1px solid #ddd;
    }
    .emoji-category-btn.active {
      background: #a3cffa;
      color: white;
    }
    .premium-item {
      position: relative;
      opacity: 0.7;
    }
    .premium-item::after {
      content: 'ğŸ’°';
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 12px;
    }
    .emoji-container {
      position: relative;
      max-width: 300px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 100;
    }
    
    #emoji-picker, #emoji-picker-all {
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 300px;
    }
    
    .emoji-close-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      background: #ff5c5c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      z-index: 101;
    }
    
    .emoji-close-btn:hover {
      background: #ff3333;
      transform: scale(1.1);
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
      margin-top: 5px;
    }
    .emoji-btn {
      font-size: 20px;
      padding: 5px;
      cursor: pointer;
      background: none;
      border: 1px solid #eee;
      border-radius: 5px;
      transition: all 0.2s ease;
    }
    .emoji-btn:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }
    .transfer-monera {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }
    .transfer-monera input {
      width: 60px;
      margin-right: 5px;
    }
    #admin-password {
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    .message-colored {
      color: black;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 300px;
      width: 90%;
      text-align: center;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }
    .modal-buttons button {
      margin: 0 5px;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .confirm-btn {
      background: #4CAF50;
      color: white;
    }
    .cancel-btn {
      background: #f44336;
      color: white;
    }
    .color-preview {
      padding: 5px 10px;
      border-radius: 5px;
      margin: 5px 0;
      font-weight: bold;
      text-align: center;
    }
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 10px;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    
    .color-preview {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      text-align: center;
    }
    
    .admin-section {
      background: #fff;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    .users-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    .user-item {
      display: flex;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .user-item:last-child {
      border-bottom: none;
    }

    @media (max-width: 600px) {
      body { padding: 5px; }
      .tabs { flex-direction: column; }
      .tabs button { padding: 14px; font-size: 18px; }
      #chat-messages, #all-chat-messages { height: 50vh; }
      #chat-room button, #all-chat button { padding: 12px 18px; font-size: 18px; }
      #users button, #friends button, #settings-content button { padding: 14px 20px; font-size: 18px; }
      input[type="text"], input[type="file"] { font-size: 18px; }
      #login { padding: 25px; max-width: 90%; }
      #login::before { font-size: 16px; top: 5px; }
      #settings-profile img { width: 50px; height: 50px; }
      #settings-profile span { font-size: 1em; }
      .settings-sub button { padding: 14px 20px; font-size: 18px; }
      .message { font-size: 16px; }
      .sound-table { grid-template-columns: 1fr; }
      .settings-btn { padding: 12px 20px; font-size: 16px; }
      
      /* Mobile styles for new elements */
      .emoji-container {
        max-width: 95%;
        left: 2.5% !important;
        right: 2.5%;
        top: auto !important;
        bottom: 80px;
        position: fixed;
      }
      .emoji-grid {
        grid-template-columns: repeat(5, 1fr);
        max-height: 180px;
      }
      .emoji-btn {
        font-size: 24px;
        padding: 10px;
      }
      .emoji-category-btn {
        padding: 8px;
        font-size: 14px;
      }
      .emoji-close-btn {
        width: 30px;
        height: 30px;
        font-size: 18px;
      }
      .color-picker {
        justify-content: center;
      }
      .color-btn {
        width: 36px;
        height: 36px;
        margin: 5px;
      }
      .modal-content {
        width: 90%;
        padding: 15px;
      }
      .modal-buttons button {
        padding: 10px 18px;
        font-size: 16px;
      }
      .color-preview {
        margin: 8px 0;
        padding: 8px;
        font-size: 16px;
      }
      .notification {
        width: 90%;
        left: 5%;
        transform: none;
        font-size: 16px;
        text-align: center;
      }
      .users-list {
        max-height: 150px;
      }
      .transfer-monera {
        flex-direction: column;
        align-items: flex-start;
      }
      .transfer-monera input {
        width: 100%;
        margin-bottom: 5px;
      }
    }
    
    .user-monera-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      background: #f5f5f5;
      margin: 5px 0;
      border-radius: 6px;
    }
    
    .user-id {
      font-weight: bold;
    }
    
    .user-monera {
      color: #6b6b6b;
    }
    
    .users-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
    }
    
    .transfer-monera {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    /* Theme styles */
    .theme-light {
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      color: #333;
    }
    
    .theme-dark {
      background: linear-gradient(135deg, #2c3e50, #4a5568);
      color: #f5f5f5;
    }
    
    .theme-dark .tab-content {
      background: #1a202c;
      color: #f5f5f5;
    }
    
    .theme-dark .message {
      background: #2d3748;
      color: #e2e8f0;
    }
    
    .theme-dark .settings-btn,
    .theme-dark #chat-room button,
    .theme-dark #all-chat button,
    .theme-dark .settings-sub button {
      background: #4a5568;
      color: #f5f5f5;
    }
    
    .theme-pastel {
      background: linear-gradient(135deg, #ffafbd, #ffc3a0);
      color: #333;
    }
    
    .theme-pastel .tab-content {
      background: #fff5f5;
    }
    
    .theme-pastel .message {
      background: #ffeef2;
    }
    
    .theme-pastel .settings-btn,
    .theme-pastel #chat-room button,
    .theme-pastel #all-chat button,
    .theme-pastel .settings-sub button {
      background: linear-gradient(135deg, #ffafbd, #ffc3a0);
      color: #333;
    }
  </style>
  <link rel="shortcut icon" href="#" />
</head>
<body>
  <div id="login">
    <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ / ContraseÃ±a">
    <input id="userId" type="text" placeholder="ì•„ì´ë”” / ID">
    <label><input id="rememberMe" type="checkbox"> ë‚˜ ê¸°ì–µí•˜ê¸° / Recordarme</label>
    <button onclick="login()">ë¡œê·¸ì¸ / Iniciar sesiÃ³n</button>
  </div>
  <div id="main" style="display: none;" class="container">
    <div class="tabs">
      <button onclick="showTab('users')">ğŸ‘¥ ì ‘ì† ì¤‘ì¸ ì‚¬ëŒë“¤ / Personas conectadas</button>
      <button onclick="showTab('friends')">ğŸŒŸ ë‚´ ì¹œêµ¬ë“¤ / Mis amigos</button>
      <button onclick="showTab('chat')">ğŸ’¬ ë‚´ ì±„íŒ… / Mi Chat</button>
      <button onclick="showTab('all-chat')">ğŸŒ ì „ì²´ ì±„íŒ… / Chat general</button>
      <button onclick="showTab('settings')">âš™ï¸ ì„¤ì • / ConfiguraciÃ³n</button>
      <div class="monera-display"><span class="monera-icon">ğŸ’°</span> <span id="monera-count">0</span></div>
    </div>
    <div id="users" class="tab-content" style="display: block;">
      <div class="online-users">
        <div class="section-title">ì˜¨ë¼ì¸ / En lÃ­nea</div>
        <div id="online-users-list"></div>
      </div>
      <div class="offline-users">
        <div class="section-title">ì˜¤í”„ë¼ì¸ / Fuera de lÃ­nea</div>
        <div id="offline-users-list"></div>
      </div>
    </div>
    <div id="friends" class="tab-content" style="display: none;"></div>
    <div id="chat" class="tab-content" style="display: none;">
      <div id="room-list" style="display: block;"></div>
      <div id="chat-room" style="display: none;">
        <button onclick="backToRooms()">â¬…ï¸ ë’¤ë¡œê°€ê¸° / Volver</button>
        <button onclick="clearRoom()">ğŸ—‘ï¸ ëŒ€í™” ì§€ìš°ê¸° / Borrar chat</button>
        <div id="chat-messages"></div>
        <input id="message" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥ / Escribe un mensaje" onkeypress="if(event.key === 'Enter') sendMessage()" oninput="updateMessagePreview()">
        <div class="color-preview" id="message-preview" style="display: none;"></div>
        <div class="color-picker">
          <div class="color-btn selected" style="background-color: black;" onclick="setMessageColor('black', false)"></div>
          <div class="color-btn" style="background-color: #FF0000;" onclick="setMessageColor('#FF0000', true)"></div>
          <div class="color-btn" style="background-color: #0000FF;" onclick="setMessageColor('#0000FF', true)"></div>
          <div class="color-btn" style="background-color: #008000;" onclick="setMessageColor('#008000', true)"></div>
          <div class="color-btn" style="background-color: #800080;" onclick="setMessageColor('#800080', true)"></div>
          <div class="color-btn" style="background-color: #FFA500;" onclick="setMessageColor('#FFA500', true)"></div>
          <div class="color-btn" style="background-color: #FFFF00;" onclick="setMessageColor('#FFFF00', true)"></div>
        </div>
        <button onclick="showEmojiPicker()">ğŸ˜Š</button>
        <div id="emoji-picker"></div>
        <input type="file" id="fileInput" accept="image/*,video/*" onchange="sendFile()">
        <button onclick="startRecording()">ğŸ™ï¸</button>
        <button onclick="stopRecording()" disabled>â¹ï¸</button>
        <button onclick="sendMessage()">âœˆï¸ ë³´ë‚´ê¸° / Enviar</button>
      </div>
    </div>
    <div id="all-chat" class="tab-content" style="display: none;">
      <div id="all-chat-messages"></div>
      <input id="all-message" type="text" placeholder="ì „ì²´ ì±„íŒ… ë©”ì‹œì§€ / Mensaje para todos" onkeypress="if(event.key === 'Enter') sendAllMessage()" oninput="updateAllMessagePreview()">
      <div class="color-preview" id="all-message-preview" style="display: none;"></div>
      <div class="color-picker">
        <div class="color-btn selected" style="background-color: black;" onclick="setAllMessageColor('black', false)"></div>
        <div class="color-btn" style="background-color: #FF0000;" onclick="setAllMessageColor('#FF0000', true)"></div>
        <div class="color-btn" style="background-color: #0000FF;" onclick="setAllMessageColor('#0000FF', true)"></div>
        <div class="color-btn" style="background-color: #008000;" onclick="setAllMessageColor('#008000', true)"></div>
        <div class="color-btn" style="background-color: #800080;" onclick="setAllMessageColor('#800080', true)"></div>
        <div class="color-btn" style="background-color: #FFA500;" onclick="setAllMessageColor('#FFA500', true)"></div>
        <div class="color-btn" style="background-color: #FFFF00;" onclick="setAllMessageColor('#FFFF00', true)"></div>
      </div>
      <button onclick="showEmojiPickerAll()">ğŸ˜Š</button>
      <div id="emoji-picker-all"></div>
      <input type="file" id="all-fileInput" accept="image/*,video/*" onchange="sendAllFile()">
      <button onclick="startAllRecording()">ğŸ™ï¸</button>
      <button onclick="stopAllRecording()" disabled>â¹ï¸</button>
      <button onclick="sendAllMessage()">âœˆï¸ ë³´ë‚´ê¸° / Enviar</button>
    </div>
    <div id="settings" class="tab-content" style="display: none;">
      <div id="settings-profile"></div>
      <div id="settings-content" style="display: block;">
        <button class="settings-btn" onclick="showSettingsSubmenu('profile')">ğŸ“¸ í”„ë¡œí•„ ì‚¬ì§„ ì„¤ì • / ConfiguraciÃ³n de foto de perfil</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('sound')">ğŸ¶ ì†Œë¦¬ ì„¤ì • / ConfiguraciÃ³n de sonido</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('theme')">ğŸ¨ í…Œë§ˆ / Tema</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('credits')">ğŸ‘©â€ğŸ’» ì œì‘ì / Creadores</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('guide')">ğŸ“– ì‚¬ìš©ë²• / Instrucciones</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('admin')">ğŸ”’ ê´€ë¦¬ì / Administrador</button>
      </div>
      
      <div id="settings-profile-sub" class="settings-sub" style="display: none;">
        <h3>í”„ë¡œí•„ ì‚¬ì§„ ì„¤ì • / ConfiguraciÃ³n de foto de perfil</h3>
        <input type="file" id="profileInput" accept="image/*" onchange="uploadProfile()">
        <button onclick="backToSettings()">â¬…ï¸ ë’¤ë¡œê°€ê¸° / Volver</button>
      </div>
      
      <div id="settings-sound" class="settings-sub" style="display: none;">
        <h3>ì†Œë¦¬ ì„¤ì • / ConfiguraciÃ³n de sonido</h3>
        
        <div>
          <label for="sound-toggle">ì†Œë¦¬ í™œì„±í™” / Activar sonido:</label>
          <input type="checkbox" id="sound-toggle" checked onchange="toggleSound()">
        </div>
        
        <button onclick="setSound('default')">ê¸°ë³¸ ì•Œë¦¼ìŒ / Sonido por defecto</button>
        <button onclick="setSound('bell')">ì¢…ì†Œë¦¬ / Campana</button>
        <button onclick="setSound('ping')">í•‘ ì†Œë¦¬ / Ping</button>
        
        <button onclick="backToSettings()">â¬…ï¸ ë’¤ë¡œê°€ê¸° / Volver</button>
      </div>
      
      <div id="settings-theme" class="settings-sub" style="display: none;">
        <h3>í…Œë§ˆ ì„¤ì • / ConfiguraciÃ³n de tema</h3>
        
        <div>
          <button onclick="setTheme('light')">ğŸŒ ë°ì€ í…Œë§ˆ / Tema claro</button>
          <button onclick="setTheme('dark')">ğŸŒ™ ì–´ë‘ìš´ í…Œë§ˆ / Tema oscuro</button>
          <button onclick="setTheme('pastel')">ğŸ§ íŒŒìŠ¤í…” í…Œë§ˆ / Tema pastel</button>
        </div>
        
        <button onclick="backToSettings()">â¬…ï¸ ë’¤ë¡œê°€ê¸° / Volver</button>
      </div>
      
      <div id="settings-credits" class="settings-sub" style="display: none;">
        <h3>ì œì‘ì / Creadores</h3>
        <p>âœ¨ Gunil & Noelia âœ¨<br>by xAI Corporation</p>
        <button onclick="backToSettings()">â¬…ï¸ ë’¤ë¡œê°€ê¸° / Volver</button>
      </div>
      
      <div id="settings-guide" class="settings-sub" style="display: none;">
        <h3>ì‚¬ìš©ë²• / Instrucciones</h3>
        <p>ì´ í”„ë¡œê·¸ë¨ ì‚¬ìš©ë²• / Instrucciones del programa:<br>
          1. ë¡œê·¸ì¸ í›„ íƒ­ì„ ì„ íƒí•´ / Inicia sesiÃ³n y elige una pestaÃ±a.<br>
          2. ì¹œêµ¬ ì¶”ê°€ í›„ ì±„íŒ… ì‹œì‘ / AÃ±ade amigos y empieza a chatear.<br>
          3. ì „ì²´ ì±„íŒ…ì€ 30ê°œë§Œ ìœ ì§€ / El chat general mantiene 30 mensajes.<br>
          4. ì„¤ì •ì—ì„œ ì‚¬ì§„, ì†Œë¦¬ ë³€ê²½ / Cambia foto y sonido en configuraciÃ³n.<br>
          5. ìš©ëŸ‰ 400MB ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì‚­ì œ / Mensajes antiguos se borran si supera 400MB.<br>
          6. ë¯¸ë””ì–´ëŠ” 7ì¼ í›„ ì‚­ì œ / Medios se borran tras 7 dÃ­as.<br>
          7. ëª¨ë„¤ë¼ëŠ” 1:1 ì±„íŒ…ì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œë§ˆë‹¤ 1ì”© ì–»ì„ ìˆ˜ ìˆì–´ìš” / Puedes ganar 1 Monera cada vez que recibes un mensaje en chat privado.<br>
          8. ëª¨ë„¤ë¼ë¡œ ìƒ‰ìƒê³¼ ì´ëª¨ì§€ë¥¼ êµ¬ë§¤í•  ìˆ˜ ìˆì–´ìš” (5ëª¨ë„¤ë¼) / Puedes comprar colores y emojis con Monera (5 Monera).<br>
          9. ì¹œêµ¬ì—ê²Œ ëª¨ë„¤ë¼ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš” / Puedes enviar Monera a tus amigos.<br>
          10. ìƒ‰ìƒì€ ë©”ì‹œì§€ ë³´ë‚¼ ë•Œë§ˆë‹¤ ë‹¤ì‹œ ê²€ì€ìƒ‰ìœ¼ë¡œ ëŒì•„ê°€ìš” / El color vuelve a negro despuÃ©s de enviar cada mensaje.
        </p>
        <button onclick="backToSettings()">â¬…ï¸ ë’¤ë¡œê°€ê¸° / Volver</button>
      </div>
      
      <div id="settings-admin" class="settings-sub" style="display: none;">
        <h3>ê´€ë¦¬ì ì„¤ì • / ConfiguraciÃ³n de administrador</h3>
        <div>
          <label for="admin-password">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ / ContraseÃ±a de administrador:</label>
          <input type="password" id="admin-password">
        </div>
        <button onclick="verifyAdminPassword()">í™•ì¸ / Verificar</button>
        
        <div id="admin-panel" style="display:none;">
          <h4>ê´€ë¦¬ì íŒ¨ë„ / Panel de administrador</h4>
          
          <!-- Admin Monera Management -->
          <div class="admin-section">
            <h5>ëª¨ë„¤ë¼ ê´€ë¦¬ / GestiÃ³n de Monera</h5>
            <div>
              <label for="admin-user-id">ì‚¬ìš©ì ID / ID de usuario:</label>
              <input type="text" id="admin-user-id">
            </div>
            <div>
              <label for="admin-monera-amount">ëª¨ë„¤ë¼ ê¸ˆì•¡ / Cantidad de Monera:</label>
              <input type="number" id="admin-monera-amount">
            </div>
            <button onclick="adminAddMonera()">ëª¨ë„¤ë¼ ì¶”ê°€ / AÃ±adir Monera</button>
          </div>
          
          <!-- All users Monera display -->
          <div class="admin-section">
            <h5>ëª¨ë“  ì‚¬ìš©ì ëª¨ë„¤ë¼ / Monera de todos los usuarios</h5>
            <div id="all-users-monera" class="users-list">
              <!-- User Monera data will be populated here -->
            </div>
            <button onclick="loadAllUsersMonera()">ìƒˆë¡œê³ ì¹¨ / Actualizar</button>
          </div>
        </div>
        
        <button onclick="backToSettings()">â¬…ï¸ ë’¤ë¡œê°€ê¸° / Volver</button>
      </div>
    </div>
  </div>
  <audio id="notification"></audio>
  <script>
    // Global variables
    let token;
    let myId;
    let userMonera = 0;
    let currentRoom;
    let soundEnabled = true;
    let userProfilePic = 'default-profile.png';
    let pollingInterval;
    let allChatInterval;
    let mediaRecorder;
    let audioChunks = [];
    let lastMessageCount = 0;
    let lastAllMessageCount = 0;
    let isPollingPaused = false;
    let selectedColor = 'black';
    let allSelectedColor = 'black';
    let selectedCategory = 'basic';

    const emojiCategories = {
      basic: ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ˜¢', 'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰'],
      faces: ['ğŸ˜€', 'ğŸ˜', 'ğŸ¤£', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜‡', 'ğŸ¤©', 'ğŸ˜‹', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤«', 'ğŸ˜´', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¥³', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ¥º', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ '],
      animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦', 'ğŸ¯', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”', 'ğŸ¦„', 'ğŸ™', 'ğŸ¦‹', 'ğŸ', 'ğŸ¦‚', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ¬', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸ¦', 'ğŸ˜', 'ğŸ¦', 'ğŸª', 'ğŸ¦’', 'ğŸ¦“'],
      faces: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‡', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‹', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ¤ª', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ˜›', 'ğŸ¤‘', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ¤ ', 'ğŸ¥³'],
      animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„'],
      food: ['ğŸ', 'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸ¥¬', 'ğŸ¥’', 'ğŸŒ¶', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ§„', 'ğŸ§…', 'ğŸ¥”', 'ğŸ ', 'ğŸ¥'],
      activities: ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ›¹', 'ğŸ›·', 'â›¸', 'ğŸ¥Œ', 'ğŸ¿'],
      travel: ['âœˆï¸', 'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸ', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸ¦¯', 'ğŸ¦½', 'ğŸ¦¼', 'ğŸ›´', 'ğŸš²', 'ğŸ›µ', 'ğŸ', 'ğŸ›º', 'ğŸš¨', 'ğŸš”', 'ğŸš', 'ğŸš˜', 'ğŸš–', 'ğŸš¡', 'ğŸš ', 'ğŸšŸ']
    };

    window.onload = function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.body.className = '';  // ê¸°ì¡´ í´ë˜ìŠ¤ ëª¨ë‘ ì œê±°
        document.body.classList.add(`theme-${savedTheme}`);
      }
      
      const savedUserId = localStorage.getItem('savedUserId');
      const savedPassword = localStorage.getItem('savedPassword');
      if (savedUserId && savedPassword) {
        document.getElementById('userId').value = savedUserId;
        document.getElementById('password').value = savedPassword;
        document.getElementById('rememberMe').checked = true;
      }
    }

    async function login() {
      const password = document.getElementById('password').value;
      const userId = document.getElementById('userId').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password, userId })
      });
      const data = await res.json();
      if (data.success) {
        myId = userId;
        token = data.token;
        localStorage.setItem('token', token);
        if (rememberMe) {
          localStorage.setItem('savedUserId', userId);
          localStorage.setItem('savedPassword', password);
        } else {
          localStorage.removeItem('savedUserId');
          localStorage.removeItem('savedPassword');
        }
        document.getElementById('login').style.display = 'none';
        document.getElementById('main').style.display = 'block';
        updateUserList();
        getMyMonera();
        updateSettingsProfile();
        loadSound();
        window.onbeforeunload = logout;
      } else {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”! / Â¡ContraseÃ±a incorrecta!');
      }
    }

    async function logout() {
      await fetch('/logout', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ userId: myId })
      });
      localStorage.removeItem('token');
    }

    async function updateUserList() {
      const res = await fetch('/users', {
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Cache-Control': 'no-cache' // ìºì‹œ ë°©ì§€
        }
      });
      const onlineUsers = await res.json();
      const resAll = await fetch('/all-users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const allUsers = await resAll.json();
      const onlineUserIds = onlineUsers.map(u => u.userId);
      const offlineUsers = allUsers.filter(u => !onlineUserIds.includes(u.userId) && u.userId !== myId);
      const onlineUsersDiv = document.getElementById('online-users-list');
      const offlineUsersDiv = document.getElementById('offline-users-list');
      onlineUsersDiv.innerHTML = '';
      offlineUsersDiv.innerHTML = '';
      onlineUsers
        .filter(user => user.userId !== myId)
        .forEach(user => {
          const div = document.createElement('div');
          div.className = 'message';
          div.innerHTML = `<img src="${user.profilePic}" class="profile-pic"><span>${user.userId}</span>`;
          const addButton = document.createElement('button');
          addButton.innerText = 'ì¹œêµ¬ ì¶”ê°€ / AÃ±adir amigo';
          addButton.onclick = () => addFriend(user.userId);
          div.appendChild(addButton);
          onlineUsersDiv.appendChild(div);
        });
      offlineUsers.forEach(user => {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<img src="${user.profilePic}" class="profile-pic"><span>${user.userId}</span>`;
        const addButton = document.createElement('button');
        addButton.innerText = 'ì¹œêµ¬ ì¶”ê°€ / AÃ±adir amigo';
        addButton.onclick = () => addFriend(user.userId);
        div.appendChild(addButton);
        offlineUsersDiv.appendChild(div);
      });
      updateFriendsList();
    }

    async function addFriend(friendId) {
      const res = await fetch('/friends', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ userId: myId, friendId })
      });
      const data = await res.json();
      if (data.success) {
        updateFriendsList();
        showNotification(`${friendId}ë‹˜ì´ ì¹œêµ¬ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! / Â¡${friendId} ha sido aÃ±adido como amigo!`);
      }
      else if (data.message) alert(`${friendId}ëŠ” ì´ë¯¸ ì¹œêµ¬ì•¼! / Â¡${friendId} ya es amigo!`);
    }

    async function removeFriend(friendId) {
      const res = await fetch('/friends', {
        method: 'DELETE',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ userId: myId, friendId })
      });
      const data = await res.json();
      if (data.success) updateFriendsList();
    }

    async function updateFriendsList() {
      const resFriends = await fetch(`/friends/${myId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const friends = await resFriends.json();
      const resUsers = await fetch('/all-users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const allUsers = await resUsers.json();
      const friendsDiv = document.getElementById('friends');
      friendsDiv.innerHTML = '';
      friends.forEach(friend => {
        const friendData = allUsers.find(u => u.userId === friend);
        const profilePic = friendData ? friendData.profilePic : '/uploads/default-profile.png';
        const div = document.createElement('div');
        div.className = 'message';
        const chatButton = document.createElement('button');
        chatButton.innerText = friend;
        const roomId = [myId, friend].sort().join('-');
        chatButton.onclick = () => startChat(roomId);
        const removeButton = document.createElement('button');
        removeButton.innerText = 'ì‚­ì œ / Eliminar';
        removeButton.onclick = () => removeFriend(friend);
        
        // Add Monera transfer functionality
        const transferDiv = document.createElement('div');
        transferDiv.className = 'transfer-monera';
        const transferInput = document.createElement('input');
        transferInput.type = 'number';
        transferInput.min = '1';
        transferInput.placeholder = 'ëª¨ë„¤ë¼ / Monera';
        const transferButton = document.createElement('button');
        transferButton.innerText = 'ëª¨ë„¤ë¼ ë³´ë‚´ê¸° / Enviar Monera';
        transferButton.onclick = () => {
          const amount = parseInt(transferInput.value);
          if (isNaN(amount) || amount <= 0) {
            alert('ìœ íš¨í•œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”. / Ingrese una cantidad vÃ¡lida.');
            return;
          }
          if (amount > userMonera) {
            alert('ëª¨ë„¤ë¼ê°€ ë¶€ì¡±í•´ìš”! / Â¡No tienes suficiente Monera!');
            return;
          }
          transferMonera(friend, amount);
        };
        transferDiv.appendChild(transferInput);
        transferDiv.appendChild(transferButton);
        
        div.innerHTML = `<img src="${profilePic}" class="profile-pic">`;
        div.appendChild(chatButton);
        div.appendChild(removeButton);
        div.appendChild(transferDiv);
        friendsDiv.appendChild(div);
      });
    }

    async function updateRoomList() {
      const resRooms = await fetch(`/rooms/${myId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const roomData = await resRooms.json();
      const resUsers = await fetch('/all-users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const allUsers = await resUsers.json();
      const roomList = document.getElementById('room-list');
      roomList.innerHTML = '';
      roomData.forEach(({ roomId, lastMessage, unreadCount }) => {
        const participants = roomId.split('-').filter(id => id !== '');
        const roomName = participants.filter(id => id !== myId).join(', ');
        const friendId = participants.find(id => id !== myId);
        const friendData = allUsers.find(u => u.userId === friendId);
        const profilePic = friendData ? friendData.profilePic : '/uploads/default-profile.png';
        const roomButton = document.createElement('button');
        roomButton.innerHTML = `<img src="${profilePic}" class="profile-pic">${roomName}ì™€ì˜ ëŒ€í™” / Chat con ${roomName}`;
        if (unreadCount > 0) roomButton.classList.add('unread');
        roomButton.onclick = () => startChat(roomId);
        const preview = document.createElement('div');
        preview.innerText = lastMessage ? lastMessage.message.split('\n')[0] : 'ëŒ€í™” ì—†ìŒ / Sin mensajes';
        const div = document.createElement('div');
        div.className = 'message';
        div.appendChild(roomButton);
        div.appendChild(preview);
        roomList.appendChild(div);
      });
    }

    async function updateSettingsProfile() {
      try {
        const res = await fetch('/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await res.json();
        const me = users.find(u => u.userId === myId);
        
        // í”„ë¡œí•„ ì •ë³´ ì €ì¥
        if (me) {
          userProfilePic = me.profilePic;
        }
        
        // ì‚¬ìš©ì í”„ë¡œí•„ ì˜ì—­ ì—…ë°ì´íŠ¸
        const userProfileDiv = document.getElementById('user-profile');
        if (userProfileDiv) {
          userProfileDiv.innerHTML = `
            <div class="profile-image-container">
              <img class="profile-pic" src="${userProfilePic || 'default-profile.png'}" alt="Profile">
            </div>
            <div class="profile-info">
              <p class="profile-id">${myId}</p>
              <p class="profile-monera">ëª¨ë„¤ë¼: ${userMonera} / Monera: ${userMonera}</p>
            </div>
          `;
        }
        
        // ì„¤ì • í”„ë¡œí•„ ì—…ë°ì´íŠ¸
        const profileDiv = document.getElementById('settings-profile');
        if (profileDiv) {
          profileDiv.innerHTML = `
            <img src="${userProfilePic || 'default-profile.png'}" class="profile-pic">
            <span>${myId}</span>
            <div class="monera-display">
              <span class="monera-icon">ğŸ’°</span>
              <span id="settings-monera-count">${userMonera}</span> ëª¨ë„¤ë¼ / Monera
            </div>
          `;
        }
      } catch (error) {
        console.error('í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
      }
    }

    async function startChat(roomId) {
      currentRoom = roomId;
      const tabs = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabs.length; i++) tabs[i].style.display = 'none';
      document.getElementById('chat').style.display = 'block';
      document.getElementById('room-list').style.display = 'none';
      document.getElementById('chat-room').style.display = 'block';
      loadChatHistory();
      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = setInterval(() => {
        if (!isPollingPaused) loadChatHistory();
      }, 2000);
    }

    async function loadChatHistory() {
      if (!currentRoom) return;
      try {
        const res = await fetch(`/chat/${currentRoom}/${myId}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Cache-Control': 'no-cache'
          }
        });
        if (!res.ok) {
          throw new Error(`ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨: ${res.status}`);
        }
        const messages = await res.json();
        const resUsers = await fetch('/all-users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const allUsers = await resUsers.json();
        const chat = document.getElementById('chat-messages');
        const messageCount = messages.length;
        
        // Check if user is already at the bottom before new message
        const isAtBottom = chat.scrollHeight - chat.scrollTop === chat.clientHeight;
        
        if (messageCount > lastMessageCount && soundEnabled && messages[messages.length - 1].from !== myId) {
          const audio = document.getElementById('notification');
          audio.play().catch(err => console.log('ì•Œë¦¼ ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨ / Error al reproducir sonido:', err));
          
          // Earn Monera when receiving a message (only for private chats)
          if (currentRoom !== 'all-chat' && messages[messages.length - 1].from !== myId) {
            // ì‹ ê·œ ë©”ì‹œì§€ ê°¯ìˆ˜ë§Œí¼ ëª¨ë„¤ë¼ ì ë¦½
            const newMessageCount = messageCount - lastMessageCount;
            earnMonera(newMessageCount);
          }
        }
        lastMessageCount = messageCount;
        chat.innerHTML = '';
        messages.forEach(data => {
          const user = allUsers.find(u => u.userId === data.from);
          const profilePic = user ? user.profilePic : '/uploads/default-profile.png';
          const p = document.createElement('p');
          p.className = 'message';
          const timestamp = new Date(data.timestamp).toLocaleString('ko-KR');
          
          const messageColor = data.color || 'black';
          
          if (data.type === 'text') {
            p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${data.from}:</strong> <span style="color: ${messageColor}">${data.message.replace(/\n/g, '<br>')}</span> <span class="timestamp">${timestamp}</span>`;
          } else if (data.type === 'image') {
            p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${data.from}:</strong> <img src="${data.message}" class="message-media"> <span class="timestamp">${timestamp}</span>`;
          } else if (data.type === 'video') {
            p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${data.from}:</strong> <video src="${data.message}" controls class="message-media"></video> <span class="timestamp">${timestamp}</span>`;
          } else if (data.type === 'voice') {
            p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${data.from}:</strong> <audio src="${data.message}" controls onplay="pausePolling()" onended="resumePolling()"></audio> <span class="timestamp">${timestamp}</span>`;
          }
          chat.appendChild(p);
        });
        
        // Only scroll to bottom if user was already at bottom before new message
        if (isAtBottom) {
          chat.scrollTop = chat.scrollHeight;
        }
      } catch (error) {
        console.error('ì±„íŒ… ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì±„íŒ… ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. / No se pudo cargar el historial de chat. Por favor, verifica el estado del servidor.');
      }
    }

    function pausePolling() {
      isPollingPaused = true;
    }

    function resumePolling() {
      isPollingPaused = false;
    }

    async function loadAllChat() {
      const resMessages = await fetch('/all-chat', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const messages = await resMessages.json();
      const resUsers = await fetch('/all-users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const allUsers = await resUsers.json();
      const chat = document.getElementById('all-chat-messages');
      const messageCount = messages.length;
      if (messageCount > lastAllMessageCount && soundEnabled && messages[messages.length - 1].from !== myId) {
        const audio = document.getElementById('notification');
        audio.play().catch(err => console.log('ì•Œë¦¼ ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨ / Error al reproducir sonido:', err));
      }
      lastAllMessageCount = messageCount;
      chat.innerHTML = '';
      messages.forEach(data => {
        const user = allUsers.find(u => u.userId === data.from);
        const profilePic = user ? user.profilePic : '/uploads/default-profile.png';
        const p = document.createElement('p');
        p.className = 'message';
        const timestamp = new Date(data.timestamp).toLocaleString('ko-KR');
        
        const messageColor = data.color || 'black';
        
        if (data.type === 'text') {
          p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${data.from}:</strong> <span style="color: ${messageColor}">${data.message.replace(/\n/g, '<br>')}</span> <span class="timestamp">${timestamp}</span>`;
        } else if (data.type === 'image') {
          p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${data.from}:</strong> <img src="${data.message}" class="message-media"> <span class="timestamp">${timestamp}</span>`;
        } else if (data.type === 'video') {
          p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${data.from}:</strong> <video src="${data.message}" controls class="message-media"></video> <span class="timestamp">${timestamp}</span>`;
        } else if (data.type === 'voice') {
          p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${data.from}:</strong> <audio src="${data.message}" controls onplay="pausePolling()" onended="resumePolling()"></audio> <span class="timestamp">${timestamp}</span>`;
        }
        chat.appendChild(p);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const message = document.getElementById('message').value;
      if (!currentRoom || !message) return;
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ 
            roomId: currentRoom, 
            from: myId, 
            message,
            color: selectedColor
          })
        });
        if (!res.ok) {
          throw new Error(`ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨: ${res.status}`);
        }
        const data = await res.json();
        if (data.success) {
          document.getElementById('message').value = '';
          // Reset color to black after sending
          setMessageColor('black', false);
          // Reset input style
          document.getElementById('message').style.color = 'black';
          loadChatHistory();
        } else {
          alert(data.message || 'ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨ / Error al enviar mensaje');
        }
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
        alert('ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ ëª»í–ˆì–´ìš”. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. / No se pudo enviar el mensaje. Por favor, verifica el estado del servidor.');
      }
    }

    async function sendAllMessage() {
      const message = document.getElementById('all-message').value;
      if (!message) return;
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ 
          roomId: 'all-chat', 
          from: myId, 
          message,
          color: allSelectedColor
        })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('all-message').value = '';
        // Reset color to black after sending
        setAllMessageColor('black', false);
        // Reset input style
        document.getElementById('all-message').style.color = 'black';
        loadAllChat();
      }
    }

    async function sendFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!currentRoom || !file) return;
      const formData = new FormData();
      formData.append('file', file);
      formData.append('roomId', currentRoom);
      formData.append('from', myId);
      const res = await fetch('/upload', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      const data = await res.json();
      if (data.success) {
        fileInput.value = '';
        loadChatHistory();
      }
    }

    async function sendAllFile() {
      const fileInput = document.getElementById('all-fileInput');
      const file = fileInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      formData.append('roomId', 'all-chat');
      formData.append('from', myId);
      const res = await fetch('/upload', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      const data = await res.json();
      if (data.success) {
        fileInput.value = '';
        loadAllChat();
      }
    }

    async function uploadProfile() {
      const fileInput = document.getElementById('profileInput');
      const file = fileInput.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('profile', file);
      formData.append('userId', myId);
      
      try {
        const res = await fetch('/upload/profile', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();
        if (data.success) {
          alert('í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆì–´ìš”! / Â¡Foto de perfil cambiada!');
          updateUserList();
          updateFriendsList();
          updateRoomList();
          updateSettingsProfile();
          loadChatHistory();
          loadAllChat();
        } else {
          alert(data.message || 'í”„ë¡œí•„ ì‚¬ì§„ì„ ë³€ê²½í•˜ì§€ ëª»í–ˆì–´ìš”. / No se pudo cambiar la foto de perfil.');
        }
      } catch (error) {
        console.error('í”„ë¡œí•„ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('í”„ë¡œí•„ ì‚¬ì§„ì„ ë³€ê²½í•˜ì§€ ëª»í–ˆì–´ìš”. / No se pudo cambiar la foto de perfil.');
      }
    }

    function showEmojiPicker() {
      const picker = document.getElementById('emoji-picker');
      picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      if (picker.style.display !== 'block') return;
      
      picker.innerHTML = '';
      
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'emoji-close-btn';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = () => {
        picker.style.display = 'none';
      };
      picker.appendChild(closeBtn);
      
      // Create category selection
      const categories = document.createElement('div');
      categories.className = 'emoji-categories';
      Object.keys(emojiCategories).forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'emoji-category-btn' + (category === selectedCategory ? ' active' : '');
        btn.innerText = category === 'basic' ? 'ê¸°ë³¸ / BÃ¡sico' : 
                        category === 'faces' ? 'í‘œì • / Caras' : 
                        category === 'animals' ? 'ë™ë¬¼ / Animales' : 
                        category === 'food' ? 'ìŒì‹ / Comida' : 
                        category === 'activities' ? 'í™œë™ / Actividades' : 'ì—¬í–‰ / Viajes';
        btn.onclick = (e) => {
          e.stopPropagation();
          
          // Update active class for categories
          document.querySelectorAll('.emoji-category-btn').forEach(b => {
            b.classList.remove('active');
          });
          btn.classList.add('active');
          
          selectedCategory = category;
          
          // Update emoji grid without closing picker
          updateEmojiGrid(picker);
        };
        categories.appendChild(btn);
      });
      picker.appendChild(categories);
      
      // Create emoji grid
      updateEmojiGrid(picker);
      
      picker.style.left = '50%';
      picker.style.top = '80%';
    }
    
    function updateEmojiGrid(picker) {
      // ê¸°ì¡´ ê·¸ë¦¬ë“œ ì œê±°
      const existingGrid = picker.querySelector('.emoji-grid');
      if (existingGrid) {
        picker.removeChild(existingGrid);
      }
      
      const grid = document.createElement('div');
      grid.className = 'emoji-grid';
      
      emojiCategories[selectedCategory].forEach((emoji, index) => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn' + (selectedCategory !== 'basic' && index >= 8 ? ' premium-item' : '');
        btn.innerText = emoji;
        btn.onclick = () => {
          const messageInput = document.getElementById('message');
          const cursorPos = messageInput.selectionStart;
          const textBefore = messageInput.value.substring(0, cursorPos);
          const textAfter = messageInput.value.substring(cursorPos);
          
          if (selectedCategory !== 'basic' && index >= 8) {
            // í”„ë¦¬ë¯¸ì—„ ì´ëª¨ì§€
            if (userMonera >= 5) {
              showConfirmDialog(
                `ëª¨ë„¤ë¼ 5ê°œë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? / Â¿Quieres usar 5 Monera para usar este emoji?`,
                () => {
                  spendMonera(5).then(success => {
                    if (success) {
                      // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
                      messageInput.value = textBefore + emoji + textAfter;
                      
                      // ì»¤ì„œ ìœ„ì¹˜ë¥¼ ì´ëª¨ì§€ ë’¤ë¡œ ì´ë™
                      messageInput.selectionStart = cursorPos + emoji.length;
                      messageInput.selectionEnd = cursorPos + emoji.length;
                      messageInput.focus();
                      
                      // í”¼ì»¤ ë‹«ê¸°
                      picker.style.display = 'none';
                    }
                  });
                }
              );
            } else {
              alert('ëª¨ë„¤ë¼ê°€ ë¶€ì¡±í•´ìš”! / Â¡No tienes suficiente Monera!');
            }
          } else {
            // ë¬´ë£Œ ì´ëª¨ì§€
            // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
            messageInput.value = textBefore + emoji + textAfter;
            
            // ì»¤ì„œ ìœ„ì¹˜ë¥¼ ì´ëª¨ì§€ ë’¤ë¡œ ì´ë™
            messageInput.selectionStart = cursorPos + emoji.length;
            messageInput.selectionEnd = cursorPos + emoji.length;
            messageInput.focus();
            
            // í”¼ì»¤ ë‹«ê¸°
            picker.style.display = 'none';
          }
        };
        grid.appendChild(btn);
      });
      
      picker.appendChild(grid);
    }

    function showEmojiPickerAll() {
      const picker = document.getElementById('emoji-picker-all');
      picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      if (picker.style.display !== 'block') return;
      
      picker.innerHTML = '';
      
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'emoji-close-btn';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = () => {
        picker.style.display = 'none';
      };
      picker.appendChild(closeBtn);
      
      // Create category selection
      const categories = document.createElement('div');
      categories.className = 'emoji-categories';
      Object.keys(emojiCategories).forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'emoji-category-btn' + (category === selectedCategory ? ' active' : '');
        btn.innerText = category === 'basic' ? 'ê¸°ë³¸ / BÃ¡sico' : 
                        category === 'faces' ? 'í‘œì • / Caras' : 
                        category === 'animals' ? 'ë™ë¬¼ / Animales' : 
                        category === 'food' ? 'ìŒì‹ / Comida' : 
                        category === 'activities' ? 'í™œë™ / Actividades' : 'ì—¬í–‰ / Viajes';
        btn.onclick = (e) => {
          e.stopPropagation();
          
          // Update active class for categories
          document.querySelectorAll('#emoji-picker-all .emoji-category-btn').forEach(b => {
            b.classList.remove('active');
          });
          btn.classList.add('active');
          
          selectedCategory = category;
          
          // Update emoji grid without closing picker
          updateEmojiGridAll(picker);
        };
        categories.appendChild(btn);
      });
      picker.appendChild(categories);
      
      // Create emoji grid
      updateEmojiGridAll(picker);
      
      picker.style.left = '50%';
      picker.style.top = '80%';
    }
    
    function updateEmojiGridAll(picker) {
      // ê¸°ì¡´ ê·¸ë¦¬ë“œ ì œê±°
      const existingGrid = picker.querySelector('.emoji-grid');
      if (existingGrid) {
        picker.removeChild(existingGrid);
      }
      
      const grid = document.createElement('div');
      grid.className = 'emoji-grid';
      
      emojiCategories[selectedCategory].forEach((emoji, index) => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn' + (selectedCategory !== 'basic' && index >= 8 ? ' premium-item' : '');
        btn.innerText = emoji;
        btn.onclick = () => {
          const messageInput = document.getElementById('all-message');
          const cursorPos = messageInput.selectionStart;
          const textBefore = messageInput.value.substring(0, cursorPos);
          const textAfter = messageInput.value.substring(cursorPos);
          
          if (selectedCategory !== 'basic' && index >= 8) {
            // í”„ë¦¬ë¯¸ì—„ ì´ëª¨ì§€
            if (userMonera >= 5) {
              showConfirmDialog(
                `ëª¨ë„¤ë¼ 5ê°œë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? / Â¿Quieres usar 5 Monera para usar este emoji?`,
                () => {
                  spendMonera(5).then(success => {
                    if (success) {
                      // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
                      messageInput.value = textBefore + emoji + textAfter;
                      
                      // ì»¤ì„œ ìœ„ì¹˜ë¥¼ ì´ëª¨ì§€ ë’¤ë¡œ ì´ë™
                      messageInput.selectionStart = cursorPos + emoji.length;
                      messageInput.selectionEnd = cursorPos + emoji.length;
                      messageInput.focus();
                      
                      // í”¼ì»¤ ë‹«ê¸°
                      picker.style.display = 'none';
                    }
                  });
                }
              );
            } else {
              alert('ëª¨ë„¤ë¼ê°€ ë¶€ì¡±í•´ìš”! / Â¡No tienes suficiente Monera!');
            }
          } else {
            // ë¬´ë£Œ ì´ëª¨ì§€
            // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
            messageInput.value = textBefore + emoji + textAfter;
            
            // ì»¤ì„œ ìœ„ì¹˜ë¥¼ ì´ëª¨ì§€ ë’¤ë¡œ ì´ë™
            messageInput.selectionStart = cursorPos + emoji.length;
            messageInput.selectionEnd = cursorPos + emoji.length;
            messageInput.focus();
            
            // í”¼ì»¤ ë‹«ê¸°
            picker.style.display = 'none';
          }
        };
        grid.appendChild(btn);
      });
      
      picker.appendChild(grid);
    }

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = sendVoiceMessage;
      mediaRecorder.start();
      document.querySelector('button[onclick="startRecording()"]').disabled = true;
      document.querySelector('button[onclick="stopRecording()"]').disabled = false;
    }

    function stopRecording() {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      document.querySelector('button[onclick="startRecording()"]').disabled = false;
      document.querySelector('button[onclick="stopRecording()"]').disabled = true;
    }

    async function sendVoiceMessage() {
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      const formData = new FormData();
      formData.append('voice', audioBlob, 'voice.wav');
      formData.append('roomId', currentRoom);
      formData.append('from', myId);
      const res = await fetch('/upload/voice', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      const data = await res.json();
      if (data.success) {
        loadChatHistory();
      }
    }

    async function startAllRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = sendAllVoiceMessage;
      mediaRecorder.start();
      document.querySelector('button[onclick="startAllRecording()"]').disabled = true;
      document.querySelector('button[onclick="stopAllRecording()"]').disabled = false;
    }

    function stopAllRecording() {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      document.querySelector('button[onclick="startAllRecording()"]').disabled = false;
      document.querySelector('button[onclick="stopAllRecording()"]').disabled = true;
    }

    async function sendAllVoiceMessage() {
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      const formData = new FormData();
      formData.append('voice', audioBlob, 'voice.wav');
      formData.append('roomId', 'all-chat');
      formData.append('from', myId);
      const res = await fetch('/upload/voice', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      const data = await res.json();
      if (data.success) {
        loadAllChat();
      }
    }

    async function clearRoom() {
      if (!currentRoom || !confirm('ëŒ€í™” ê¸°ë¡ì„ ì§€ìš¸ê¹Œìš”? / Â¿Borrar historial de chat?')) return;
      if (pollingInterval) clearInterval(pollingInterval);
      const res = await fetch(`/chat/delete/${currentRoom}/${myId}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success) {
        await loadChatHistory();
        pollingInterval = setInterval(() => {
          if (!isPollingPaused) loadChatHistory();
        }, 2000);
      } else {
        alert(data.message || 'ëŒ€í™” ì§€ìš°ê¸° ì‹¤íŒ¨ / No se pudo borrar el chat');
        pollingInterval = setInterval(() => {
          if (!isPollingPaused) loadChatHistory();
        }, 2000);
      }
    }

    function showTab(tabName) {
      const tabs = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabs.length; i++) tabs[i].style.display = 'none';
      document.getElementById(tabName).style.display = 'block';
      if (tabName === 'chat') {
        document.getElementById('room-list').style.display = 'block';
        document.getElementById('chat-room').style.display = 'none';
        updateRoomList();
        if (pollingInterval) clearInterval(pollingInterval);
      } else if (tabName === 'friends') {
        updateFriendsList();
      } else if (tabName === 'users') {
        updateUserList();
      } else if (tabName === 'all-chat') {
        loadAllChat();
        if (allChatInterval) clearInterval(allChatInterval);
        allChatInterval = setInterval(loadAllChat, 2000);
      } else if (tabName === 'settings') {
        // Hide all settings submenu divs
        document.querySelectorAll('.settings-sub').forEach(el => {
          el.style.display = 'none';
        });
        
        // Show the main settings content
        document.getElementById('settings-content').style.display = 'block';
        getMyMonera();
        updateSettingsProfile();
      }
    }

    function backToRooms() {
      document.getElementById('chat-room').style.display = 'none';
      document.getElementById('room-list').style.display = 'block';
      currentRoom = null;
      if (pollingInterval) clearInterval(pollingInterval);
      updateRoomList();
    }

    function showSettingsSubmenu(submenu) {
      // Hide all settings submenu divs
      document.querySelectorAll('.settings-sub').forEach(el => {
        el.style.display = 'none';
      });
      
      // Hide main settings content
      document.getElementById('settings-content').style.display = 'none';
      
      // Show the requested submenu
      if (submenu === 'profile') {
        document.getElementById('settings-profile-sub').style.display = 'block';
      } else {
        document.getElementById(`settings-${submenu}`).style.display = 'block';
      }
    }
    
    function backToSettings() {
      // Hide all settings submenu divs
      document.querySelectorAll('.settings-sub').forEach(el => {
        el.style.display = 'none';
      });
      
      // Show the main settings content
      document.getElementById('settings-content').style.display = 'block';
      getMyMonera();
      updateSettingsProfile();
    }

    function toggleSound() {
      soundEnabled = document.getElementById('sound-toggle').checked;
      localStorage.setItem('soundEnabled', soundEnabled);
      alert(`ì†Œë¦¬ê°€ ${soundEnabled ? 'ì¼œì¡Œì–´ìš” / Sonido activado' : 'êº¼ì¡Œì–´ìš” / Sonido desactivado'}`);
    }

    function loadSound() {
      const sound = localStorage.getItem('notificationSound') || 'default';
      const audio = document.getElementById('notification');
      
      // ì†Œë¦¬ URL ì„¤ì •
      if (sound === 'default') {
        audio.src = 'https://cdn.pixabay.com/audio/2024/11/29/audio_0b4f12f995.mp3';
      } else if (sound === 'bell') {
        audio.src = 'https://www.myinstants.com/media/sounds/bell.mp3';
      } else if (sound === 'ping') {
        audio.src = 'https://cdn.pixabay.com/audio/2024/11/29/audio_538916a9ed.mp3';
      }
      
      // ì†Œë¦¬ í™œì„±í™” ìƒíƒœ ë¡œë“œ
      const soundEnabledStr = localStorage.getItem('soundEnabled');
      if (soundEnabledStr !== null) {
        soundEnabled = soundEnabledStr === 'true';
      }
      
      // Sound toggle checkbox ìƒíƒœ ì´ˆê¸°í™”
      const soundToggle = document.getElementById('sound-toggle');
      if (soundToggle) {
        soundToggle.checked = soundEnabled;
      }
    }

    function setSound(type) {
      localStorage.setItem('notificationSound', type);
      loadSound();
      
      // ì†Œë¦¬ ë¯¸ë¦¬ë“£ê¸°
      const audio = document.getElementById('notification');
      if (soundEnabled) {
        audio.play().catch(err => console.log('ì•Œë¦¼ ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨:', err));
      }
      
      alert(`ì•Œë¦¼ìŒì´ ${type}ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆì–´ìš”! / Â¡Sonido de notificaciÃ³n cambiado a ${type}!`);
    }

    function previewSound(type) {
      const audio = document.getElementById('notification');
      if (type === 'soft') audio.src = 'https://cdn.pixabay.com/audio/2024/11/29/audio_0b4f12f995.mp3';
      else if (type === 'bell') audio.src = 'https://www.myinstants.com/media/sounds/bell.mp3';
      else if (type === 'chime') audio.src = 'https://cdn.pixabay.com/audio/2024/11/29/audio_538916a9ed.mp3';
      audio.play();
    }

    // RGB ê°’ì„ HEX ê°’ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function RGB2HEX(rgb) {
      if (!rgb) return '';
      if (rgb.startsWith('#')) return rgb;
      
      rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
      if (!rgb) return '';
      
      function hex(x) {
        return ("0" + parseInt(x).toString(16)).slice(-2);
      }
      return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
    }

    function setMessageColor(color, isPremium) {
      if (isPremium) {
        if (userMonera < 5) {
          alert('ëª¨ë„¤ë¼ê°€ ë¶€ì¡±í•´ìš”! / Â¡No tienes suficiente Monera!');
          return;
        }
        
        showConfirmDialog(
          `ëª¨ë„¤ë¼ 5ê°œë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒ‰ìƒì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? / Â¿Quieres usar 5 Monera para cambiar el color?`,
          () => {
            spendMonera(5).then(success => {
              if (success) {
                // ìƒ‰ìƒ ì§ì ‘ ì„¤ì •
                selectedColor = color;
                
                // ì…ë ¥ì°½ì— ì§ì ‘ ìƒ‰ìƒ ì ìš©
                const messageInput = document.getElementById('message');
                messageInput.style.color = color;
                
                // ë²„íŠ¼ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
                const colorButtons = document.querySelectorAll('#chat .color-btn');
                colorButtons.forEach(btn => {
                  btn.classList.remove('selected');
                });
                
                // ì„ íƒëœ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
                const selectedButton = Array.from(colorButtons).find(btn => {
                  return btn.style.backgroundColor.toLowerCase() === color.toLowerCase() || 
                         btn.style.backgroundColor === color ||
                         RGB2HEX(btn.style.backgroundColor) === color;
                });
                
                if (selectedButton) {
                  selectedButton.classList.add('selected');
                }
                
                // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
                document.getElementById('message-preview').style.display = 'none';
              }
            });
          }
        );
      } else {
        // ìƒ‰ìƒ ì§ì ‘ ì„¤ì •
        selectedColor = color;
        
        // ì…ë ¥ì°½ì— ì§ì ‘ ìƒ‰ìƒ ì ìš©
        const messageInput = document.getElementById('message');
        messageInput.style.color = color;
        
        // ë²„íŠ¼ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        const colorButtons = document.querySelectorAll('#chat .color-btn');
        colorButtons.forEach(btn => {
          btn.classList.remove('selected');
        });
        
        // ì„ íƒëœ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
        const selectedButton = Array.from(colorButtons).find(btn => {
          return btn.style.backgroundColor.toLowerCase() === color.toLowerCase() || 
                 btn.style.backgroundColor === color ||
                 RGB2HEX(btn.style.backgroundColor) === color;
        });
        
        if (selectedButton) {
          selectedButton.classList.add('selected');
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
        document.getElementById('message-preview').style.display = 'none';
      }
    }
    
    function updateEmojiGrid(picker) {
      // ê¸°ì¡´ ê·¸ë¦¬ë“œ ì œê±°
      const existingGrid = picker.querySelector('.emoji-grid');
      if (existingGrid) {
        picker.removeChild(existingGrid);
      }
      
      const grid = document.createElement('div');
      grid.className = 'emoji-grid';
      
      emojiCategories[selectedCategory].forEach((emoji, index) => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn' + (selectedCategory !== 'basic' && index >= 8 ? ' premium-item' : '');
        btn.innerText = emoji;
        btn.onclick = () => {
          const messageInput = document.getElementById('message');
          const cursorPos = messageInput.selectionStart;
          const textBefore = messageInput.value.substring(0, cursorPos);
          const textAfter = messageInput.value.substring(cursorPos);
          
          if (selectedCategory !== 'basic' && index >= 8) {
            // í”„ë¦¬ë¯¸ì—„ ì´ëª¨ì§€
            if (userMonera >= 5) {
              showConfirmDialog(
                `ëª¨ë„¤ë¼ 5ê°œë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? / Â¿Quieres usar 5 Monera para usar este emoji?`,
                () => {
                  spendMonera(5).then(success => {
                    if (success) {
                      // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
                      messageInput.value = textBefore + emoji + textAfter;
                      
                      // ì»¤ì„œ ìœ„ì¹˜ë¥¼ ì´ëª¨ì§€ ë’¤ë¡œ ì´ë™
                      messageInput.selectionStart = cursorPos + emoji.length;
                      messageInput.selectionEnd = cursorPos + emoji.length;
                      messageInput.focus();
                      
                      // í”¼ì»¤ ë‹«ê¸°
                      picker.style.display = 'none';
                    }
                  });
                }
              );
            } else {
              alert('ëª¨ë„¤ë¼ê°€ ë¶€ì¡±í•´ìš”! / Â¡No tienes suficiente Monera!');
            }
          } else {
            // ë¬´ë£Œ ì´ëª¨ì§€
            // ì»¤ì„œ ìœ„ì¹˜ì— ì´ëª¨ì§€ ì‚½ì…
            messageInput.value = textBefore + emoji + textAfter;
            
            // ì»¤ì„œ ìœ„ì¹˜ë¥¼ ì´ëª¨ì§€ ë’¤ë¡œ ì´ë™
            messageInput.selectionStart = cursorPos + emoji.length;
            messageInput.selectionEnd = cursorPos + emoji.length;
            messageInput.focus();
            
            // í”¼ì»¤ ë‹«ê¸°
            picker.style.display = 'none';
          }
        };
        grid.appendChild(btn);
      });
      
      picker.appendChild(grid);
    }
    
    function updateMessagePreview() {
      // ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•˜ì—¬ ì…ë ¥ì°½ì— ì§ì ‘ ìƒ‰ìƒì´ ì ìš©ë˜ë„ë¡ í•¨
      document.getElementById('message-preview').style.display = 'none';
    }

    function setAllMessageColor(color, isPremium) {
      if (isPremium && userMonera < 5) {
        alert('ëª¨ë„¤ë¼ê°€ ë¶€ì¡±í•´ìš”! / Â¡No tienes suficiente Monera!');
        return;
      }
      
      if (isPremium) {
        showConfirmDialog(
          `ëª¨ë„¤ë¼ 5ê°œë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒ‰ìƒì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? / Â¿Quieres usar 5 Monera para cambiar el color?`,
          () => {
            spendMonera(5).then(success => {
              if (success) {
                applyAllMessageColor(color);
              }
            });
          }
        );
      } else {
        applyAllMessageColor(color);
      }
    }
    
    function applyAllMessageColor(color) {
      allSelectedColor = color;
      
      // Update all-message input color directly
      const allMessageInput = document.getElementById('all-message');
      allMessageInput.style.color = color;
      
      // Update button selection
      const colorButtons = document.querySelectorAll('#all-chat .color-btn');
      colorButtons.forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // ì„ íƒëœ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
      const selectedButton = Array.from(colorButtons).find(btn => {
        return btn.style.backgroundColor.toLowerCase() === color.toLowerCase() || 
               btn.style.backgroundColor === color ||
               RGB2HEX(btn.style.backgroundColor) === color;
      });
      
      if (selectedButton) {
        selectedButton.classList.add('selected');
      }
      
      // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
      document.getElementById('all-message-preview').style.display = 'none';
    }
    
    function updateAllMessagePreview() {
      // ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•˜ì—¬ ì…ë ¥ì°½ì— ì§ì ‘ ìƒ‰ìƒì´ ì ìš©ë˜ë„ë¡ í•¨
      document.getElementById('all-message-preview').style.display = 'none';
    }

    async function getMyMonera() {
      const res = await fetch(`/monera/${myId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success) {
        userMonera = data.monera;
        // monera-count ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì—…ë°ì´íŠ¸
        const moneraCountElement = document.getElementById('monera-count');
        if (moneraCountElement) {
          moneraCountElement.innerText = userMonera;
        }
      }
    }

    async function earnMonera(amount) {
      try {
        const res = await fetch('/monera/earn', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId: myId, amount })
        });
        const data = await res.json();
        if (data.success) {
          userMonera += amount;
          // monera-count ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì—…ë°ì´íŠ¸
          const moneraCountElement = document.getElementById('monera-count');
          if (moneraCountElement) {
            moneraCountElement.innerText = userMonera;
          }
        }
      } catch (error) {
        console.error('ëª¨ë„¤ë¼ íšë“ ì¤‘ ì˜¤ë¥˜:', error);
      }
    }

    async function spendMonera(amount) {
      try {
        const res = await fetch('/monera/spend', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId: myId, amount })
        });
        const data = await res.json();
        if (data.success) {
          userMonera -= amount;
          // monera-count ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì—…ë°ì´íŠ¸
          const moneraCountElement = document.getElementById('monera-count');
          if (moneraCountElement) {
            moneraCountElement.innerText = userMonera;
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('ëª¨ë„¤ë¼ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜:', error);
        return false;
      }
    }

    async function transferMonera(toUserId, amount) {
      try {
        const res = await fetch('/monera/transfer', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ fromUserId: myId, toUserId, amount })
        });
        const data = await res.json();
        if (data.success) {
          userMonera -= amount;
          // monera-count ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì—…ë°ì´íŠ¸
          const moneraCountElement = document.getElementById('monera-count');
          if (moneraCountElement) {
            moneraCountElement.innerText = userMonera;
          }
          alert(`${amount} ëª¨ë„¤ë¼ë¥¼ ${toUserId}ì—ê²Œ ë³´ëƒˆìŠµë‹ˆë‹¤! / Â¡Has enviado ${amount} Monera a ${toUserId}!`);
          return true;
        } else {
          alert(data.message || 'ëª¨ë„¤ë¼ ì „ì†¡ ì‹¤íŒ¨ / Error al enviar Monera');
          return false;
        }
      } catch (error) {
        console.error('ëª¨ë„¤ë¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:', error);
        alert('ëª¨ë„¤ë¼ë¥¼ ë³´ë‚´ì§€ ëª»í–ˆì–´ìš”. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. / No se pudo enviar Monera. Por favor, verifica el estado del servidor.');
        return false;
      }
    }

    function verifyAdminPassword() {
      const adminPassword = document.getElementById('admin-password').value;
      if (!adminPassword) {
        alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” / Por favor, ingrese la contraseÃ±a de administrador');
        return;
      }
      
      // ì§ì ‘ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (ì„œë²„ API ëŒ€ì‹ )
      if (adminPassword === '1210') {
        document.getElementById('admin-panel').style.display = 'block';
        showNotification('ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ / AutenticaciÃ³n de administrador exitosa');
        // ëª¨ë„¤ë¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadAllUsersMonera();
      } else {
        alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤ / ContraseÃ±a de administrador incorrecta');
      }
    }
    
    async function loadAllUsersMonera() {
      try {
        const res = await fetch('/all-users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await res.json();
        
        const usersListDiv = document.getElementById('all-users-monera');
        usersListDiv.innerHTML = '';
        
        // ê° ì‚¬ìš©ìì˜ ëª¨ë„¤ë¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜´
        for (const user of users) {
          const moneraRes = await fetch(`/monera/${user.userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const moneraData = await moneraRes.json();
          const moneraAmount = moneraData.success ? moneraData.monera : 0;
          
          const userDiv = document.createElement('div');
          userDiv.className = 'user-monera-item';
          userDiv.innerHTML = `
            <span class="user-id">${user.userId}</span>
            <span class="user-monera">ëª¨ë„¤ë¼: ${moneraAmount} / Monera: ${moneraAmount}</span>
          `;
          usersListDiv.appendChild(userDiv);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('ì‚¬ìš©ì ëª¨ë„¤ë¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ / Error al cargar la informaciÃ³n de Monera del usuario');
      }
    }
    
    async function adminAddMonera() {
      const adminPassword = document.getElementById('admin-password').value;
      const userId = document.getElementById('admin-user-id').value;
      const amount = parseInt(document.getElementById('admin-monera-amount').value);
      
      if (!adminPassword || !userId || isNaN(amount)) {
        alert('ëª¨ë“  í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš” / Por favor, rellene todos los campos');
        return;
      }
      
      if (adminPassword !== '1210') {
        alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤ / ContraseÃ±a de administrador incorrecta');
        return;
      }
      
      try {
        const res = await fetch('/monera/admin/add', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId, amount })
        });
        
        const data = await res.json();
        if (data.success) {
          showNotification(`${userId}ë‹˜ì—ê²Œ ${amount} ëª¨ë„¤ë¼ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! / Â¡Se han aÃ±adido ${amount} Monera a ${userId}!`);
          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadAllUsersMonera();
        } else {
          alert(data.message || 'ëª¨ë„¤ë¼ ì¶”ê°€ ì‹¤íŒ¨ / Error al aÃ±adir Monera');
        }
      } catch (error) {
        console.error('ëª¨ë„¤ë¼ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error);
        alert('ëª¨ë„¤ë¼ë¥¼ ì¶”ê°€í•˜ì§€ ëª»í–ˆì–´ìš”. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. / No se pudo aÃ±adir Monera. Por favor, verifica el estado del servidor.');
      }
    }
    
    function setTheme(theme) {
      document.body.className = '';  // ê¸°ì¡´ í´ë˜ìŠ¤ ëª¨ë‘ ì œê±°
      document.body.classList.add(`theme-${theme}`);
      localStorage.setItem('theme', theme);
      showNotification(`í…Œë§ˆê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤: ${theme} / Tema cambiado: ${theme}`);
    }

    // Helper functions for UI
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    function showConfirmDialog(message, onConfirm) {
      // Remove any existing modal
      const existingModal = document.querySelector('.modal-overlay');
      if (existingModal) {
        document.body.removeChild(existingModal);
      }
      
      // Create modal elements
      const modalOverlay = document.createElement('div');
      modalOverlay.className = 'modal-overlay';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      
      const messageElement = document.createElement('p');
      messageElement.textContent = message;
      
      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'modal-buttons';
      
      const confirmButton = document.createElement('button');
      confirmButton.className = 'confirm-btn';
      confirmButton.textContent = 'í™•ì¸ / Confirmar';
      confirmButton.onclick = () => {
        document.body.removeChild(modalOverlay);
        onConfirm();
      };
      
      const cancelButton = document.createElement('button');
      cancelButton.className = 'cancel-btn';
      cancelButton.textContent = 'ì·¨ì†Œ / Cancelar';
      cancelButton.onclick = () => {
        document.body.removeChild(modalOverlay);
      };
      
      // Assemble modal
      buttonsContainer.appendChild(confirmButton);
      buttonsContainer.appendChild(cancelButton);
      modalContent.appendChild(messageElement);
      modalContent.appendChild(buttonsContainer);
      modalOverlay.appendChild(modalContent);
      
      // Show modal
      document.body.appendChild(modalOverlay);
    }
  </script>
</body>
</html>