<!DOCTYPE html>
<html>
<head>
  <title>Ï±ÑÌåÖ ÌîÑÎ°úÍ∑∏Îû® / Programa de chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: linear-gradient(135deg, #e0eafc, #cfdef3); 
      margin: 0; 
      padding: 10px; 
      animation: backgroundShift 10s infinite alternate; 
    }
    @keyframes backgroundShift { 
      0% { background: linear-gradient(135deg, #e0eafc, #cfdef3); } 
      100% { background: linear-gradient(135deg, #cfdef3, #e0eafc); } 
    }
    .container { max-width: 1000px; margin: 0 auto; }
    .tabs { 
      display: flex; 
      flex-wrap: wrap; 
      background: #a3cffa; 
      border-radius: 15px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      overflow: hidden; 
    }
    .tabs button { 
      flex: 1; 
      padding: 12px; 
      border: none; 
      background: #a3cffa; 
      color: #333; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      font-size: 16px; 
    }
    .tabs button:hover { background: #89bffa; }
    .tabs button.active { background: #6bafff; color: white; }
    .tab-content { 
      display: none; 
      padding: 15px; 
      background: white; 
      border-radius: 15px; 
      margin-top: 10px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      animation: fadeIn 0.3s ease; 
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #chat-messages, #all-chat-messages { 
      height: 60vh; 
      overflow-y: auto; 
      border: 1px solid #e0e0e0; 
      padding: 10px; 
      background: #fafafa; 
      border-radius: 10px; 
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); 
    }
    #chat-room button, #all-chat button { 
      background: #ffd1dc; 
      border: none; 
      padding: 10px 15px; 
      margin: 5px; 
      border-radius: 10px; 
      cursor: pointer; 
      color: #333; 
      transition: all 0.3s ease; 
      font-size: 16px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    #chat-room button:hover, #all-chat button:hover { background: #ffb6c1; transform: scale(1.05); }
    #users button, #friends button, #settings-content button { 
      background: linear-gradient(135deg, #ffd1dc, #a3cffa); 
      border: none; 
      padding: 12px 18px; 
      margin: 8px; 
      border-radius: 12px; 
      cursor: pointer; 
      color: #333; 
      transition: all 0.3s ease; 
      font-size: 16px; 
      box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
    }
    #users button:hover, #friends button:hover, #settings-content button:hover { 
      transform: scale(1.05); 
      box-shadow: 0 5px 12px rgba(0,0,0,0.2); 
    }
    img.profile-pic { width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
    img.message-media, video { max-width: 200px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .unread { color: #ff6b6b; font-weight: 600; }
    #emoji-picker, #emoji-picker-all { 
      display: none; 
      position: absolute; 
      background: white; 
      border: 1px solid #ddd; 
      padding: 8px; 
      border-radius: 10px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
    }
    input[type="text"], input[type="file"] { 
      padding: 10px; 
      margin: 5px; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      width: calc(100% - 22px); 
      box-sizing: border-box; 
      font-size: 16px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    
    #message, #all-message {
      color: black;
      font-weight: normal;
      transition: color 0.3s ease;
    }
    
    /* Theme-specific colors for inputs */
    .theme-dark #message, .theme-dark #all-message {
      background-color: #333;
      color: white;
      border-color: #555;
    }
    
    .theme-pastel #message, .theme-pastel #all-message {
      background-color: #fff5f5;
      border-color: #ffcdd2;
    }
    #login { 
      background: #fff3e6; 
      padding: 30px; 
      border-radius: 20px; 
      box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
      text-align: center; 
      margin: 40px auto; 
      max-width: 400px; 
      position: relative; 
      overflow: hidden; 
    }
    #login::before { 
      content: 'üåü‚ú®üòä Bienvenido / ÌôòÏòÅÌï©ÎãàÎã§ üòä‚ú®üåü'; 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      text-align: center; 
      font-size: 18px; 
      color: #ff6b6b; 
      animation: sparkle 2s infinite; 
    }
    @keyframes sparkle { 
      0%, 100% { opacity: 1; } 
      50% { opacity: 0.5; } 
    }
    #login input[type="text"], #login input[type="password"] { 
      background: #fff; 
      border: 2px solid #ffd1dc; 
      padding: 12px; 
      font-size: 16px; 
    }
    #login button { 
      background: linear-gradient(135deg, #ffd1dc, #a3cffa); 
      padding: 12px 20px; 
      border: none; 
      border-radius: 12px; 
      color: #333; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
    }
    #login button:hover { transform: scale(1.05); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }
    #login label { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      margin: 10px 0; 
      font-size: 14px; 
      color: #666; 
    }
    #login input[type="checkbox"] { 
      margin-right: 8px; 
    }
    #settings-profile { 
      display: flex; 
      align-items: center; 
      padding: 15px; 
      background: linear-gradient(135deg, #a3cffa, #ffd1dc); 
      border-radius: 10px; 
      margin-bottom: 15px; 
      box-shadow: 0 3px 8px rgba(0,0,0,0.1); 
    }
    #settings-profile img { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; }
    #settings-profile span { font-size: 1.2em; font-weight: bold; color: #333; }
    .settings-sub { 
      background: linear-gradient(135deg, #ffd1dc, #a3cffa); 
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
      text-align: center; 
    }
    .settings-sub button { 
      background: #fff3e6; 
      color: #333; 
      font-weight: 600; 
      padding: 12px 20px; 
      border-radius: 12px; 
      margin: 10px; 
      font-size: 16px; 
      transition: all 0.3s ease; 
      box-shadow: 0 3px 8px rgba(0,0,0,0.1); 
    }
    .settings-sub button:hover { transform: scale(1.05); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }
    .settings-sub p { font-size: 1em; color: #333; }
    .sound-table { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 10px; 
      margin: 15px 0; 
    }
    .sound-table button { 
      padding: 10px; 
      font-size: 16px; 
    }
    .message { padding: 8px; margin: 5px 0; border-radius: 8px; background: #f0f4f8; font-size: 14px; }
    .timestamp { font-size: 0.7em; color: #666; }
    .settings-btn { 
      background: linear-gradient(135deg, #ffebcc, #cce5ff); 
      border: none; 
      padding: 15px 25px; 
      margin: 10px; 
      border-radius: 15px; 
      cursor: pointer; 
      color: #333; 
      font-weight: 600; 
      font-size: 18px; 
      transition: all 0.3s ease; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    .settings-btn:hover { 
      transform: scale(1.05); 
      box-shadow: 0 6px 15px rgba(0,0,0,0.2); 
    }
    .online-users, .offline-users { 
      margin-top: 10px; 
      padding: 10px; 
      background: #e6f7ff; 
      border-radius: 10px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    .offline-users { background: #f0f0f0; }
    .section-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
    
    /* Monera System Styles */
    .monera-display {
      background: linear-gradient(135deg, #ffd700, #ffb6c1);
      padding: 10px;
      border-radius: 10px;
      margin-left: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-weight: bold;
      display: inline-flex;
      align-items: center;
    }
    .monera-icon {
      margin-right: 5px;
      font-size: 1.2em;
    }
    .color-picker, .emoji-categories {
      display: flex;
      flex-wrap: wrap;
      margin: 5px 0;
    }
    .color-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin: 3px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    .color-btn.selected {
      border-color: #333;
      transform: scale(1.1);
    }
    .emoji-category-btn {
      padding: 5px 10px;
      margin: 3px;
      border-radius: 10px;
      background: #f0f4f8;
      cursor: pointer;
      border: 1px solid #ddd;
    }
    .emoji-category-btn.active {
      background: #a3cffa;
      color: white;
    }
    .premium-item {
      position: relative;
      opacity: 0.7;
    }
    .premium-item::after {
      content: 'üí∞';
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 12px;
    }
    .emoji-container {
      position: relative;
      max-width: 300px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 100;
    }
    
    #emoji-picker, #emoji-picker-all {
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 300px;
    }
    
    .emoji-close-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      background: #ff5c5c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      z-index: 101;
    }
    
    .emoji-close-btn:hover {
      background: #ff3333;
      transform: scale(1.1);
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
      margin-top: 5px;
    }
    .emoji-btn {
      font-size: 20px;
      padding: 5px;
      cursor: pointer;
      background: none;
      border: 1px solid #eee;
      border-radius: 5px;
      transition: all 0.2s ease;
    }
    .emoji-btn:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }
    .transfer-monera {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }
    .transfer-monera input {
      width: 60px;
      margin-right: 5px;
    }
    #admin-password {
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    .message-colored {
      color: black;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 300px;
      width: 90%;
      text-align: center;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }
    .modal-buttons button {
      margin: 0 5px;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .confirm-btn {
      background: #4CAF50;
      color: white;
    }
    .cancel-btn {
      background: #f44336;
      color: white;
    }
    .color-preview {
      padding: 5px 10px;
      border-radius: 5px;
      margin: 5px 0;
      font-weight: bold;
      text-align: center;
    }
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 10px;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    
    .color-preview {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      text-align: center;
    }
    
    .admin-section {
      background: #fff;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    .users-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    .user-item {
      display: flex;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .user-item:last-child {
      border-bottom: none;
    }

    @media (max-width: 600px) {
      body { padding: 5px; }
      .tabs { flex-direction: column; }
      .tabs button { padding: 14px; font-size: 18px; }
      #chat-messages, #all-chat-messages { height: 50vh; }
      #chat-room button, #all-chat button { padding: 12px 18px; font-size: 18px; }
      #users button, #friends button, #settings-content button { padding: 14px 20px; font-size: 18px; }
      input[type="text"], input[type="file"] { font-size: 18px; }
      #login { padding: 25px; max-width: 90%; }
      #login::before { font-size: 16px; top: 5px; }
      #settings-profile img { width: 50px; height: 50px; }
      #settings-profile span { font-size: 1em; }
      .settings-sub button { padding: 14px 20px; font-size: 18px; }
      .message { font-size: 16px; }
      .sound-table { grid-template-columns: 1fr; }
      .settings-btn { padding: 12px 20px; font-size: 16px; }
      
      /* Mobile styles for new elements */
      .emoji-container {
        max-width: 95%;
        left: 2.5% !important;
        right: 2.5%;
        top: auto !important;
        bottom: 80px;
        position: fixed;
      }
      .emoji-grid {
        grid-template-columns: repeat(5, 1fr);
        max-height: 180px;
      }
      .emoji-btn {
        font-size: 24px;
        padding: 10px;
      }
      .emoji-category-btn {
        padding: 8px;
        font-size: 14px;
      }
      .emoji-close-btn {
        width: 30px;
        height: 30px;
        font-size: 18px;
      }
      .color-picker {
        justify-content: center;
      }
      .color-btn {
        width: 36px;
        height: 36px;
        margin: 5px;
      }
      .modal-content {
        width: 90%;
        padding: 15px;
      }
      .modal-buttons button {
        padding: 10px 18px;
        font-size: 16px;
      }
      .color-preview {
        margin: 8px 0;
        padding: 8px;
        font-size: 16px;
      }
      .notification {
        width: 90%;
        left: 5%;
        transform: none;
        font-size: 16px;
        text-align: center;
      }
      .users-list {
        max-height: 150px;
      }
      .transfer-monera {
        flex-direction: column;
        align-items: flex-start;
      }
      .transfer-monera input {
        width: 100%;
        margin-bottom: 5px;
      }
    }
    
    .user-monera-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      background: #f5f5f5;
      margin: 5px 0;
      border-radius: 6px;
    }
    
    .user-id {
      font-weight: bold;
    }
    
    .user-monera {
      color: #6b6b6b;
    }
    
    .users-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
    }
    
    .transfer-monera {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    /* Theme styles */
    .theme-light {
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      color: #333;
    }
    
    .theme-dark {
      background: linear-gradient(135deg, #2c3e50, #4a5568);
      color: #f5f5f5;
    }
    
    .theme-dark .tab-content {
      background: #1a202c;
      color: #f5f5f5;
    }
    
    .theme-dark .message {
      background: #2d3748;
      color: #e2e8f0;
    }
    
    .theme-dark .settings-btn,
    .theme-dark #chat-room button,
    .theme-dark #all-chat button,
    .theme-dark .settings-sub button {
      background: #4a5568;
      color: #f5f5f5;
    }
    
    .theme-pastel {
      background: linear-gradient(135deg, #ffafbd, #ffc3a0);
      color: #333;
    }
    
    .theme-pastel .tab-content {
      background: #fff5f5;
    }
    
    .theme-pastel .message {
      background: #ffeef2;
    }
    
    .theme-pastel .settings-btn,
    .theme-pastel #chat-room button,
    .theme-pastel #all-chat button,
    .theme-pastel .settings-sub button {
      background: linear-gradient(135deg, #ffafbd, #ffc3a0);
      color: #333;
    }
  </style>
  <link rel="shortcut icon" href="#" />
</head>
<body>
  <div id="login">
    <input id="password" type="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ / Contrase√±a">
    <input id="userId" type="text" placeholder="ÏïÑÏù¥Îîî / ID">
    <label><input id="rememberMe" type="checkbox"> ÎÇò Í∏∞ÏñµÌïòÍ∏∞ / Recordarme</label>
    <button onclick="login()">Î°úÍ∑∏Ïù∏ / Iniciar sesi√≥n</button>
  </div>
  <div id="main" style="display: none;" class="container">
    <div class="tabs">
      <button onclick="showTab('users')">üë• Ï†ëÏÜç Ï§ëÏù∏ ÏÇ¨ÎûåÎì§ / Personas conectadas</button>
      <button onclick="showTab('friends')">üåü ÎÇ¥ ÏπúÍµ¨Îì§ / Mis amigos</button>
      <button onclick="showTab('chat')">üí¨ ÎÇ¥ Ï±ÑÌåÖ / Mi Chat</button>
      <button onclick="showTab('all-chat')">üåê Ï†ÑÏ≤¥ Ï±ÑÌåÖ / Chat general</button>
      <button onclick="showTab('settings')">‚öôÔ∏è ÏÑ§Ï†ï / Configuraci√≥n</button>
      <div class="monera-display"><span class="monera-icon">üí∞</span> <span id="monera-count">0</span></div>
    </div>
    <div id="users" class="tab-content" style="display: block;">
      <div class="online-users">
        <div class="section-title">Ïò®ÎùºÏù∏ / En l√≠nea</div>
        <div id="online-users-list"></div>
      </div>
      <div class="offline-users">
        <div class="section-title">Ïò§ÌîÑÎùºÏù∏ / Fuera de l√≠nea</div>
        <div id="offline-users-list"></div>
      </div>
    </div>
    <div id="friends" class="tab-content" style="display: none;"></div>
    <div id="chat" class="tab-content" style="display: none;">
      <div id="room-list" style="display: block;"></div>
      <div id="chat-room" style="display: none;">
        <button onclick="backToRooms()">‚¨ÖÔ∏è Îí§Î°úÍ∞ÄÍ∏∞ / Volver</button>
        <button onclick="clearRoom()">üóëÔ∏è ÎåÄÌôî ÏßÄÏö∞Í∏∞ / Borrar chat</button>
        <div id="chat-messages"></div>
        <input id="message" type="text" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†• / Escribe un mensaje" onkeypress="if(event.key === 'Enter') sendMessage()" oninput="updateMessagePreview()">
        <div class="color-preview" id="message-preview" style="display: none;"></div>
        <div class="color-picker">
          <div class="color-btn selected" style="background-color: black;" onclick="setMessageColor('black', false)"></div>
          <div class="color-btn" style="background-color: #FF0000;" onclick="setMessageColor('#FF0000', true)"></div>
          <div class="color-btn" style="background-color: #0000FF;" onclick="setMessageColor('#0000FF', true)"></div>
          <div class="color-btn" style="background-color: #008000;" onclick="setMessageColor('#008000', true)"></div>
          <div class="color-btn" style="background-color: #800080;" onclick="setMessageColor('#800080', true)"></div>
          <div class="color-btn" style="background-color: #FFA500;" onclick="setMessageColor('#FFA500', true)"></div>
          <div class="color-btn" style="background-color: #FFFF00;" onclick="setMessageColor('#FFFF00', true)"></div>
        </div>
        <button onclick="showEmojiPicker()">üòä</button>
        <div id="emoji-picker"></div>
        <input type="file" id="fileInput" accept="image/*,video/*" onchange="sendFile()">
        <button onclick="startRecording()">üéôÔ∏è</button>
        <button onclick="stopRecording()" disabled>‚èπÔ∏è</button>
        <button onclick="sendMessage()">‚úàÔ∏è Î≥¥ÎÇ¥Í∏∞ / Enviar</button>
      </div>
    </div>
    <div id="all-chat" class="tab-content" style="display: none;">
      <div id="all-chat-messages"></div>
      <input id="all-message" type="text" placeholder="Ï†ÑÏ≤¥ Ï±ÑÌåÖ Î©îÏãúÏßÄ / Mensaje para todos" onkeypress="if(event.key === 'Enter') sendAllMessage()" oninput="updateAllMessagePreview()">
      <div class="color-preview" id="all-message-preview" style="display: none;"></div>
      <div class="color-picker">
        <div class="color-btn selected" style="background-color: black;" onclick="setAllMessageColor('black', false)"></div>
        <div class="color-btn" style="background-color: #FF0000;" onclick="setAllMessageColor('#FF0000', true)"></div>
        <div class="color-btn" style="background-color: #0000FF;" onclick="setAllMessageColor('#0000FF', true)"></div>
        <div class="color-btn" style="background-color: #008000;" onclick="setAllMessageColor('#008000', true)"></div>
        <div class="color-btn" style="background-color: #800080;" onclick="setAllMessageColor('#800080', true)"></div>
        <div class="color-btn" style="background-color: #FFA500;" onclick="setAllMessageColor('#FFA500', true)"></div>
        <div class="color-btn" style="background-color: #FFFF00;" onclick="setAllMessageColor('#FFFF00', true)"></div>
      </div>
      <button onclick="showEmojiPickerAll()">üòä</button>
      <div id="emoji-picker-all"></div>
      <input type="file" id="all-fileInput" accept="image/*,video/*" onchange="sendAllFile()">
      <button onclick="startAllRecording()">üéôÔ∏è</button>
      <button onclick="stopAllRecording()" disabled>‚èπÔ∏è</button>
      <button onclick="sendAllMessage()">‚úàÔ∏è Î≥¥ÎÇ¥Í∏∞ / Enviar</button>
    </div>
    <div id="settings" class="tab-content" style="display: none;">
      <div id="settings-profile"></div>
      <div id="settings-content" style="display: block;">
        <button class="settings-btn" onclick="showSettingsSubmenu('profile')">üì∏ ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏÑ§Ï†ï / Configuraci√≥n de foto de perfil</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('sound')">üé∂ ÏÜåÎ¶¨ ÏÑ§Ï†ï / Configuraci√≥n de sonido</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('theme')">üé® ÌÖåÎßà / Tema</button>
        <button id="push-toggle-btn" class="settings-btn" onclick="togglePushNotifications()">üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('credits')">üë©‚Äçüíª Ï†úÏûëÏûê / Creadores</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('guide')">üìñ ÏÇ¨Ïö©Î≤ï / Instrucciones</button>
        <button class="settings-btn" onclick="showSettingsSubmenu('admin')">üîí Í¥ÄÎ¶¨Ïûê / Administrador</button>
      </div>
      
      <div id="settings-profile-sub" class="settings-sub" style="display: none;">
        <h3>ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏÑ§Ï†ï / Configuraci√≥n de foto de perfil</h3>
        <input type="file" id="profileInput" accept="image/*" onchange="uploadProfile()">
        <button onclick="backToSettings()">‚¨ÖÔ∏è Îí§Î°úÍ∞ÄÍ∏∞ / Volver</button>
      </div>
      
      <div id="settings-sound" class="settings-sub" style="display: none;">
        <h3>ÏÜåÎ¶¨ ÏÑ§Ï†ï / Configuraci√≥n de sonido</h3>
        
        <div>
          <label for="sound-toggle">ÏÜåÎ¶¨ ÌôúÏÑ±Ìôî / Activar sonido:</label>
          <input type="checkbox" id="sound-toggle" checked onchange="toggleSound()">
        </div>
        
        <button onclick="setSound('default')">Í∏∞Î≥∏ ÏïåÎ¶ºÏùå / Sonido por defecto</button>
        <button onclick="setSound('bell')">Ï¢ÖÏÜåÎ¶¨ / Campana</button>
        <button onclick="setSound('ping')">Ìïë ÏÜåÎ¶¨ / Ping</button>
        
        <button onclick="backToSettings()">‚¨ÖÔ∏è Îí§Î°úÍ∞ÄÍ∏∞ / Volver</button>
      </div>
      
      <div id="settings-theme" class="settings-sub" style="display: none;">
        <h3>ÌÖåÎßà ÏÑ§Ï†ï / Configuraci√≥n de tema</h3>
        
        <div>
          <button onclick="setTheme('light')">üåû Î∞ùÏùÄ ÌÖåÎßà / Tema claro</button>
          <button onclick="setTheme('dark')">üåô Ïñ¥ÎëêÏö¥ ÌÖåÎßà / Tema oscuro</button>
          <button onclick="setTheme('pastel')">üßÅ ÌååÏä§ÌÖî ÌÖåÎßà / Tema pastel</button>
        </div>
        
        <button onclick="backToSettings()">‚¨ÖÔ∏è Îí§Î°úÍ∞ÄÍ∏∞ / Volver</button>
      </div>
      
      <div id="settings-credits" class="settings-sub" style="display: none;">
        <h3>Ï†úÏûëÏûê / Creadores</h3>
        <p>‚ú® Gunil & Noelia ‚ú®<br>by xAI Corporation</p>
        <button onclick="backToSettings()">‚¨ÖÔ∏è Îí§Î°úÍ∞ÄÍ∏∞ / Volver</button>
      </div>
      
      <div id="settings-guide" class="settings-sub" style="display: none;">
        <h3>ÏÇ¨Ïö©Î≤ï / Instrucciones</h3>
        <p>Ïù¥ ÌîÑÎ°úÍ∑∏Îû® ÏÇ¨Ïö©Î≤ï / Instrucciones del programa:<br>
          1. Î°úÍ∑∏Ïù∏ ÌõÑ ÌÉ≠ÏùÑ ÏÑ†ÌÉùÌï¥ / Inicia sesi√≥n y elige una pesta√±a.<br>
          2. ÏπúÍµ¨ Ï∂îÍ∞Ä ÌõÑ Ï±ÑÌåÖ ÏãúÏûë / A√±ade amigos y empieza a chatear.<br>
          3. Ï†ÑÏ≤¥ Ï±ÑÌåÖÏùÄ 30Í∞úÎßå Ïú†ÏßÄ / El chat general mantiene 30 mensajes.<br>
          4. ÏÑ§Ï†ïÏóêÏÑú ÏÇ¨ÏßÑ, ÏÜåÎ¶¨ Î≥ÄÍ≤Ω / Cambia foto y sonido en configuraci√≥n.<br>
          5. Ïö©Îüâ 400MB Ï¥àÍ≥º Ïãú Ïò§ÎûòÎêú Î©îÏãúÏßÄ ÏÇ≠Ï†ú / Mensajes antiguos se borran si supera 400MB.<br>
          6. ÎØ∏ÎîîÏñ¥Îäî 7Ïùº ÌõÑ ÏÇ≠Ï†ú / Medios se borran tras 7 d√≠as.<br>
          7. Î™®ÎÑ§ÎùºÎäî 1:1 Ï±ÑÌåÖÏóêÏÑú Î©îÏãúÏßÄÎ•º Î∞õÏùÑ ÎïåÎßàÎã§ 1Ïî© ÏñªÏùÑ Ïàò ÏûàÏñ¥Ïöî / Puedes ganar 1 Monera cada vez que recibes un mensaje en chat privado.<br>
          8. Î™®ÎÑ§ÎùºÎ°ú ÏÉâÏÉÅÍ≥º Ïù¥Î™®ÏßÄÎ•º Íµ¨Îß§Ìï† Ïàò ÏûàÏñ¥Ïöî (5Î™®ÎÑ§Îùº) / Puedes comprar colores y emojis con Monera (5 Monera).<br>
          9. ÏπúÍµ¨ÏóêÍ≤å Î™®ÎÑ§ÎùºÎ•º Î≥¥ÎÇº Ïàò ÏûàÏñ¥Ïöî / Puedes enviar Monera a tus amigos.<br>
          10. ÏÉâÏÉÅÏùÄ Î©îÏãúÏßÄ Î≥¥ÎÇº ÎïåÎßàÎã§ Îã§Ïãú Í≤ÄÏùÄÏÉâÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏöî / El color vuelve a negro despu√©s de enviar cada mensaje.
        </p>
        <button onclick="backToSettings()">‚¨ÖÔ∏è Îí§Î°úÍ∞ÄÍ∏∞ / Volver</button>
      </div>
      
      <div id="settings-admin" class="settings-sub" style="display: none;">
        <h3>Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï / Configuraci√≥n de administrador</h3>
        <div>
          <label for="admin-password">Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ / Contrase√±a de administrador:</label>
          <input type="password" id="admin-password">
        </div>
        <button onclick="verifyAdminPassword()">ÌôïÏù∏ / Verificar</button>
        
        <div id="admin-panel" style="display:none;">
          <h4>Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê / Panel de administrador</h4>
          
          <!-- Admin Monera Management -->
          <div class="admin-section">
            <h5>Î™®ÎÑ§Îùº Í¥ÄÎ¶¨ / Gesti√≥n de Monera</h5>
            <div>
              <label for="admin-user-id">ÏÇ¨Ïö©Ïûê ID / ID de usuario:</label>
              <input type="text" id="admin-user-id">
            </div>
            <div>
              <label for="admin-monera-amount">Î™®ÎÑ§Îùº Í∏àÏï° / Cantidad de Monera:</label>
              <input type="number" id="admin-monera-amount">
            </div>
            <button onclick="adminAddMonera()">Î™®ÎÑ§Îùº Ï∂îÍ∞Ä / A√±adir Monera</button>
          </div>
          
          <!-- All users Monera display -->
          <div class="admin-section">
            <h5>Î™®Îì† ÏÇ¨Ïö©Ïûê Î™®ÎÑ§Îùº / Monera de todos los usuarios</h5>
            <div id="all-users-monera" class="users-list">
              <!-- User Monera data will be populated here -->
            </div>
            <button onclick="loadAllUsersMonera()">ÏÉàÎ°úÍ≥†Ïπ® / Actualizar</button>
          </div>
        </div>
        
        <button onclick="backToSettings()">‚¨ÖÔ∏è Îí§Î°úÍ∞ÄÍ∏∞ / Volver</button>
      </div>
    </div>
  </div>
  <audio id="notification"></audio>
  <script>
    // Global variables
    let token;
    let myId;
    let userMonera = 0;
    let currentRoom;
    let soundEnabled = true;
    let userProfilePic = 'default-profile.png';
    let pollingInterval;
    let allChatInterval;
    let mediaRecorder;
    let audioChunks = [];
    let isPollingPaused = false;
    let selectedColor = 'black';
    let allSelectedColor = 'black';
    let selectedCategory = 'basic';
    
    // Ï±ÑÌåÖ Î©îÏãúÏßÄ Ï∂îÏ†Å Î≥ÄÏàòÎì§ (Ï†ÑÏó≠ ÏÑ†Ïñ∏)
    let latestMessageTimestamps = {};
    let oldestMessageTimestamps = {};
    let displayedMessageIds = {};
    let isLoadingOlderMessages = {};
    
    // Ï†ÑÏ≤¥ Ï±ÑÌåÖÏùò ÎßàÏßÄÎßâ Î©îÏãúÏßÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
    let latestAllChatMessageTimestamp = null;
    
    // Ïù¥ÎØ∏ Î™®ÎÑ§ÎùºÍ∞Ä Ï†ÅÎ¶ΩÎêú Î©îÏãúÏßÄ IDÎ•º Ï†ÄÏû•ÌïòÎäî Í∞ùÏ≤¥
    let processedMessageIds = {};
    
    // ÏïåÎ¶º ÏÜåÎ¶¨Î•º Ïû¨ÏÉùÌïú ÎßàÏßÄÎßâ Î©îÏãúÏßÄÏùò IDÎ•º Ï†ÄÏû•ÌïòÎäî Í∞ùÏ≤¥
    let lastNotifiedMessageIds = {};

    const emojiCategories = {
      basic: ['üòä', 'üòÇ', 'üòç', 'üò¢', 'üëç', 'üëé', '‚ù§Ô∏è', 'üéâ'],
      faces: ['üòÄ', 'üòÅ', 'ü§£', 'üòé', 'ü•∞', 'üòá', 'ü§©', 'üòã', 'ü§ó', 'ü§î', 'ü§´', 'üò¥', 'üò™', 'üòµ', 'ü§Ø', 'ü•≥', 'üò≠', 'üò±', 'ü•∫', 'üò§', 'üò°', 'ü§¨', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†'],
      animals: ['üê∂', 'üê±', 'üê≠', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'ü¶Å', 'üêØ', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'ü¶Ñ', 'üêô', 'ü¶ã', 'üêù', 'ü¶Ç', 'ü¶ñ', 'ü¶ï', 'üê¨', 'üêã', 'ü¶à', 'ü¶ç', 'üêò', 'ü¶è', 'üê™', 'ü¶í', 'ü¶ì'],
      faces: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòá', 'üòâ', 'üòä', 'üôÇ', 'üôÉ', 'üòã', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'ü§™', 'üòú', 'üòù', 'üòõ', 'ü§ë', 'üòé', 'ü§ì', 'üßê', 'ü§†', 'ü•≥'],
      animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ'],
      food: ['üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂', 'üåΩ', 'ü•ï', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê'],
      activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üõπ', 'üõ∑', '‚õ∏', 'ü•å', 'üéø'],
      travel: ['‚úàÔ∏è', 'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèé', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üöú', 'ü¶Ø', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõµ', 'üèç', 'üõ∫', 'üö®', 'üöî', 'üöç', 'üöò', 'üöñ', 'üö°', 'üö†', 'üöü']
    };

    window.onload = function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.body.className = '';  // Í∏∞Ï°¥ ÌÅ¥ÎûòÏä§ Î™®Îëê Ï†úÍ±∞
        document.body.classList.add(`theme-${savedTheme}`);
      }
      
      const savedUserId = localStorage.getItem('savedUserId');
      const savedPassword = localStorage.getItem('savedPassword');
      if (savedUserId && savedPassword) {
        document.getElementById('userId').value = savedUserId;
        document.getElementById('password').value = savedPassword;
        document.getElementById('rememberMe').checked = true;
      }

      // VAPID Í≥µÍ∞ú ÌÇ§ Í∞ÄÏ†∏Ïò§Í∏∞
      loadVapidPublicKey();
    }

    // VAPID Í≥µÍ∞ú ÌÇ§ Í∞ÄÏ†∏Ïò§Í∏∞
    async function loadVapidPublicKey() {
      try {
        const response = await fetch('/vapidPublicKey');
        if (!response.ok) throw new Error('VAPID ÌÇ§ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®');
        vapidPublicKey = await response.text();
        console.log('VAPID Í≥µÍ∞ú ÌÇ§ Î°úÎìú ÏôÑÎ£å / VAPID Public Key loaded:', vapidPublicKey);
      } catch (error) {
        console.error('VAPID Í≥µÍ∞ú ÌÇ§ Î°úÎìú Ïã§Ìå®:', error);
      }
    }

    async function login() {
      const userId = document.getElementById('userId').value;
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      if (!userId || !password) return;
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password, userId })
      });
      const data = await res.json();
      if (data.success) {
        myId = userId;
        token = data.token;
        localStorage.setItem('token', token);
        if (rememberMe) {
          localStorage.setItem('savedUserId', userId);
          localStorage.setItem('savedPassword', password);
        } else {
          localStorage.removeItem('savedUserId');
          localStorage.removeItem('savedPassword');
        }
        document.getElementById('login').style.display = 'none';
        document.getElementById('main').style.display = 'block';
        
        // Î™®ÎÑ§Îùº Ï†ÅÎ¶Ω Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
        processedMessageIds = {};
        lastNotifiedMessageIds = {};
        
        // Ïù¥ÎØ∏ Ï≤òÎ¶¨Îêú Î©îÏãúÏßÄ ID Î∂àÎü¨Ïò§Í∏∞
        try {
          const savedData = localStorage.getItem(`${myId}_processedMessageIds`);
          if (savedData) {
            processedMessageIds = JSON.parse(savedData);
            console.log('[DEBUG] Î°úÍ∑∏Ïù∏ Ïãú Î∂àÎü¨Ïò® Ï≤òÎ¶¨Îêú Î©îÏãúÏßÄ ID Î™©Î°ù:', Object.keys(processedMessageIds).length, 'Í∞ú');
          }
        } catch (e) {
          console.error('Ï†ÄÏû•Îêú Î©îÏãúÏßÄ ID Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', e);
          processedMessageIds = {};
          localStorage.removeItem(`${myId}_processedMessageIds`);
        }
        
        updateUserList();
        getMyMonera();
        updateSettingsProfile();
        loadSound();
        window.onbeforeunload = logout;
        
        // ÏÑúÎπÑÏä§ ÏõåÏª§ Î∞è Ìë∏Ïãú Ï¥àÍ∏∞Ìôî
        if ('serviceWorker' in navigator && 'PushManager' in window) {
          initializePushServiceWorker();
        }
      } else {
        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏Ïñ¥Ïöî! / ¬°Contrase√±a incorrecta!');
      }
    }

    // ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù Î∞è Ìë∏Ïãú ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî Ìï®Ïàò
    async function initializePushServiceWorker() {
      if (!vapidPublicKey) {
        console.warn('VAPID Í≥µÍ∞ú ÌÇ§Í∞Ä ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        try {
          await loadVapidPublicKey();
        } catch (error) {
          console.error('VAPID ÌÇ§ Î°úÎìú Ïû¨ÏãúÎèÑ Ïã§Ìå®:', error);
          return;
        }
      }
      
      console.log('ÏÑúÎπÑÏä§ ÏõåÏª§ Î∞è Ìë∏Ïãú API ÏßÄÏõêÎê® / Service Worker y Push API soportados');
      try {
        swRegistration = await navigator.serviceWorker.register('service-worker.js');
        console.log('ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù ÏÑ±Í≥µ / Service Worker registrado:', swRegistration);
        await initializePushState();
      } catch (error) {
        console.error('ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù Ïã§Ìå® / Error al registrar Service Worker:', error);
        updatePushButton('ÏïåÎ¶º ÏÇ¨Ïö© Î∂àÍ∞Ä / Notificaciones no disponibles', true);
      }
    }

    // Ìë∏Ïãú ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî Î∞è Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
    async function initializePushState() {
      if (!swRegistration) {
        console.error('ÏÑúÎπÑÏä§ ÏõåÏª§Í∞Ä Îì±Î°ùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        updatePushButton('ÏïåÎ¶º Ïò§Î•ò / Error de notificaci√≥n', true);
        return;
      }
      
      // ÌòÑÏû¨ Íµ¨ÎèÖ ÏÉÅÌÉú ÌôïÏù∏
      const subscription = await swRegistration.pushManager.getSubscription();
      isSubscribed = !(subscription === null);

      // SupabaseÏóêÏÑú ÏÇ¨Ïö©ÏûêÏùò pushenabled ÏÉÅÌÉú ÌôïÏù∏
      const pushEnabled = await getUserPushEnabledStatus();

      if (isSubscribed && pushEnabled) {
        console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä Ïù¥ÎØ∏ Íµ¨ÎèÖ Ï§ëÏù¥Í≥† ÌôúÏÑ±ÌôîÌï® / Usuario ya suscrito y habilitado');
        updatePushButton('üîî ÏïåÎ¶º ÎÅÑÍ∏∞ / Desactivar notificaciones', false);
      } else if (isSubscribed && !pushEnabled) {
        // Íµ¨ÎèÖÏùÄ ÎêòÏñ¥ÏûàÏßÄÎßå ÏÑúÎ≤ÑÏóêÏÑú ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉú -> Íµ¨ÎèÖ Ìï¥Ï†ú Î∞è ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
        console.log('Íµ¨ÎèÖÎêòÏñ¥ ÏûàÏßÄÎßå ÏÑúÎ≤ÑÏóêÏÑú ÎπÑÌôúÏÑ±ÌôîÎê®. Íµ¨ÎèÖ Ï∑®ÏÜå Ï§ë... / Suscrito pero deshabilitado en el servidor. Cancelando suscripci√≥n...');
        try {
          await subscription.unsubscribe();
          console.log('Í∏∞Ï°¥ Íµ¨ÎèÖ Ï∑®ÏÜå ÏÑ±Í≥µ / Suscripci√≥n anterior cancelada.');
          isSubscribed = false;
          // ÏÑúÎ≤ÑÏóêÏÑúÎèÑ Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÇ≠Ï†ú
          await removeSubscriptionFromServer();
        } catch(e) {
          console.error('Í∏∞Ï°¥ Íµ¨ÎèÖ Ï∑®ÏÜå Ïã§Ìå®:', e);
        }
        updatePushButton('üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones', false);
      } else {
        console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä Íµ¨ÎèÖÌïòÏßÄ ÏïäÏùå / Usuario no suscrito');
        updatePushButton('üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones', false);
        // ÏÑúÎ≤ÑÏùò pushenabled ÏÉÅÌÉúÎèÑ falseÎ°ú ÎßûÏ∂∞Ï£ºÍ∏∞
        if (pushEnabled) {
          await updatePushEnabledStatus(false);
        }
      }
    }

    // ÏÑúÎ≤ÑÏóêÏÑú ÏÇ¨Ïö©Ïûê pushenabled ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
    async function getUserPushEnabledStatus() {
      if (!myId || !token) return false; // Î°úÍ∑∏Ïù∏ ÏïàÎêú Í≤ΩÏö∞
      try {
        const res = await fetch(`/user-push-status/${myId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) {
          console.error('Ìë∏Ïãú ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', res.status);
          return false;
        }
        const data = await res.json();
        return data.pushEnabled;
      } catch (error) {
        console.error('Ìë∏Ïãú ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞ Ï§ë Ïò§Î•ò:', error);
        return false;
      }
    }

    // ÏÑúÎ≤ÑÏóê ÏÇ¨Ïö©Ïûê pushenabled ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ÌïòÍ∏∞
    async function updatePushEnabledStatus(enabled) {
      if (!myId || !token) return false;
      try {
        const res = await fetch('/update-push-status', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
          body: JSON.stringify({ userId: myId, enabled })
        });
        return res.ok;
      } catch (error) {
        console.error('Ìë∏Ïãú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•ò:', error);
        return false;
      }
    }

    // Ìë∏Ïãú ÏïåÎ¶º ÏºúÍ∏∞/ÎÅÑÍ∏∞ ÌÜ†Í∏Ä Ìï®Ïàò
    async function togglePushNotifications() {
      const pushButton = document.getElementById('push-toggle-btn');
      pushButton.disabled = true; // Ï≤òÎ¶¨ Ï§ë Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî

      if (isSubscribed) {
        await unsubscribeUser();
      } else {
        await subscribeUser();
      }
      
      pushButton.disabled = false; // Ï≤òÎ¶¨ ÏôÑÎ£å ÌõÑ Î≤ÑÌäº ÌôúÏÑ±Ìôî
    }

    // Ìë∏Ïãú Íµ¨ÎèÖ Ìï®Ïàò
    async function subscribeUser() {
      // 1. ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        console.log('ÏïåÎ¶º Í∂åÌïú Í±∞Î∂ÄÎê® / Permiso de notificaci√≥n denegado');
        alert('ÏïåÎ¶ºÏùÑ Î∞õÏúºÎ†§Î©¥ Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî! / ¬°Permite las notificaciones para recibirlas!');
        updatePushButton('üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones', false); // Î≤ÑÌäº ÏÉÅÌÉú ÏõêÎ≥µ
        return;
      }

      // 2. ÏÑúÎπÑÏä§ ÏõåÏª§ Ï§ÄÎπÑ ÌôïÏù∏
      if (!swRegistration) {
        console.error('ÏÑúÎπÑÏä§ ÏõåÏª§ Ï§ÄÎπÑ ÏïàÎê® / Service worker no listo.');
        alert('ÏïåÎ¶º ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ® Ìï¥Ï£ºÏÑ∏Ïöî. / Error al configurar notificaciones. Refresca la p√°gina.');
        return;
      }

      // 3. Ìë∏Ïãú Íµ¨ÎèÖ ÏãúÎèÑ
      try {
        const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey); // VAPID Í≥µÍ∞ú ÌÇ§ Î≥ÄÌôò
        const subscription = await swRegistration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: applicationServerKey
        });
        console.log('Ìë∏Ïãú Íµ¨ÎèÖ ÏÑ±Í≥µ / Usuario suscrito:', subscription);

        // 4. Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
        const success = await sendSubscriptionToServer(subscription);
        
        if (success) {
          // 5. ÏÑúÎ≤ÑÏóê pushenabled ÏÉÅÌÉú trueÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
          const enabledSuccess = await updatePushEnabledStatus(true);
          if (enabledSuccess) {
            isSubscribed = true;
            updatePushButton('üîî ÏïåÎ¶º ÎÅÑÍ∏∞ / Desactivar notificaciones', false);
            showNotification('ÏïåÎ¶ºÏù¥ ÏºúÏ°åÏñ¥Ïöî! / ¬°Notificaciones activadas!');
          } else {
            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå® Ïãú Íµ¨ÎèÖ Ï∑®ÏÜå
            await subscription.unsubscribe();
            console.log('ÏÑúÎ≤Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®Î°ú Íµ¨ÎèÖ Ï∑®ÏÜåÎê® / Suscripci√≥n cancelada por fallo al actualizar estado del servidor');
            alert('ÏïåÎ¶º ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. / Fallo al actualizar el estado de las notificaciones.');
            updatePushButton('üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones', false);
          }
        } else {
          // Íµ¨ÎèÖ Ï†ïÎ≥¥ Ï†ÑÏÜ° Ïã§Ìå® Ïãú Íµ¨ÎèÖ Ï∑®ÏÜå
          await subscription.unsubscribe();
          console.log('ÏÑúÎ≤Ñ Ï†ÑÏÜ° Ïã§Ìå®Î°ú Íµ¨ÎèÖ Ï∑®ÏÜåÎê® / Suscripci√≥n cancelada por fallo al enviar al servidor');
          alert('ÏÑúÎ≤ÑÏóê ÏïåÎ¶º Ï†ïÎ≥¥Î•º Ï†ÄÏû•ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. / No se pudo guardar la informaci√≥n de notificaci√≥n en el servidor.');
          updatePushButton('üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones', false);
        }

      } catch (err) {
        console.error('Ìë∏Ïãú Íµ¨ÎèÖ Ïã§Ìå® / Error al suscribir:', err);
        alert('ÏïåÎ¶º Íµ¨ÎèÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. / Ocurri√≥ un error al suscribirse a las notificaciones.');
        updatePushButton('üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones', false); // Ïò§Î•ò Ïãú Î≤ÑÌäº ÏÉÅÌÉú ÏõêÎ≥µ
      }
    }

    // Ìë∏Ïãú Íµ¨ÎèÖ Ï∑®ÏÜå Ìï®Ïàò
    async function unsubscribeUser() {
      if (!swRegistration) {
        console.error('ÏÑúÎπÑÏä§ ÏõåÏª§ Ï§ÄÎπÑ ÏïàÎê® / Service worker no listo.');
        return;
      }
      
      try {
        const subscription = await swRegistration.pushManager.getSubscription();
        if (subscription) {
          const successfulUnsubscribe = await subscription.unsubscribe();
          if (successfulUnsubscribe) {
            console.log('Ìë∏Ïãú Íµ¨ÎèÖ Ï∑®ÏÜå ÏÑ±Í≥µ / Desuscripci√≥n exitosa');
            
            // ÏÑúÎ≤ÑÏóêÏÑú Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÇ≠Ï†ú ÏöîÏ≤≠
            const success = await removeSubscriptionFromServer();
            
            // ÏÑúÎ≤ÑÏóê pushenabled ÏÉÅÌÉú falseÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
            const enabledSuccess = await updatePushEnabledStatus(false);

            if (enabledSuccess) { // ÏÑúÎ≤Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ ÏãúÏóêÎßå UI Î≥ÄÍ≤Ω
              isSubscribed = false;
              updatePushButton('üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones', false);
              showNotification('ÏïåÎ¶ºÏù¥ Í∫ºÏ°åÏñ¥Ïöî. / Notificaciones desactivadas.');
            } else {
              // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå® Ïãú ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º
              alert('ÏïåÎ¶º ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Íµ¨ÎèÖÏùÄ Ï∑®ÏÜåÎêòÏóàÏßÄÎßå, ÏÑúÎ≤Ñ ÏÉÅÌÉúÎäî Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏïòÏùÑ Ïàò ÏûàÏäµÎãàÎã§. / Fallo al actualizar el estado de las notificaciones. La suscripci√≥n se cancel√≥, pero el estado del servidor puede no haber cambiado.');
              // UIÎäî ÏùºÎã® Íµ¨ÎèÖ Ï∑®ÏÜå ÏÉÅÌÉúÎ°ú ÎëîÎã§
              isSubscribed = false; 
              updatePushButton('üîî ÏïåÎ¶º ÏºúÍ∏∞ / Activar notificaciones', false);
            }
            
          } else {
            console.error('Ìë∏Ïãú Íµ¨ÎèÖ Ï∑®ÏÜå Ïã§Ìå® (Î∏åÎùºÏö∞Ï†Ä) / Fallo al cancelar suscripci√≥n (navegador)');
          }
        }
      } catch (error) {
        console.error('Ìë∏Ïãú Íµ¨ÎèÖ Ï∑®ÏÜå Ï§ë Ïò§Î•ò / Error durante la desuscripci√≥n:', error);
        alert('ÏïåÎ¶º Íµ¨ÎèÖ Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. / Ocurri√≥ un error al cancelar la suscripci√≥n a las notificaciones.');
        updatePushButton('üîî ÏïåÎ¶º ÎÅÑÍ∏∞ / Desactivar notificaciones', false); // Ïò§Î•ò Ïãú Î≤ÑÌäº ÏÉÅÌÉú ÏõêÎ≥µ
      }
    }

    // Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÑúÎ≤Ñ Ï†ÑÏÜ° Ìï®Ïàò
    async function sendSubscriptionToServer(subscription) {
      if (!myId || !token) return false;
      try {
        const response = await fetch('/save-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` // Ïù∏Ï¶ù ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä
          },
          body: JSON.stringify({ userId: myId, subscription: subscription }),
        });

        if (!response.ok) {
          throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå® / Fallo en la respuesta del servidor');
        }
        const data = await response.json();
        console.log('Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÑúÎ≤Ñ Ï†ÄÏû• ÏÑ±Í≥µ / Suscripci√≥n guardada en el servidor:', data);
        return data.success;
      } catch (error) {
        console.error('Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÑúÎ≤Ñ Ï†ÑÏÜ° Ïã§Ìå® / Error al enviar suscripci√≥n al servidor:', error);
        return false;
      }
    }

    // ÏÑúÎ≤ÑÏóêÏÑú Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÇ≠Ï†ú Ìï®Ïàò
    async function removeSubscriptionFromServer() {
      if (!myId || !token) return false;
      try {
        const response = await fetch('/delete-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId: myId }),
        });

        if (!response.ok) {
          throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå® / Fallo en la respuesta del servidor');
        }
        const data = await response.json();
        console.log('ÏÑúÎ≤ÑÏóêÏÑú Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÇ≠Ï†ú ÏÑ±Í≥µ / Suscripci√≥n eliminada del servidor:', data);
        return data.success;
      } catch (error) {
        console.error('ÏÑúÎ≤ÑÏóêÏÑú Íµ¨ÎèÖ Ï†ïÎ≥¥ ÏÇ≠Ï†ú Ïã§Ìå® / Error al eliminar suscripci√≥n del servidor:', error);
        return false;
      }
    }

    // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
    function updatePushButton(text, disabled) {
      const pushButton = document.getElementById('push-toggle-btn');
      if (pushButton) {
        pushButton.textContent = text;
        pushButton.disabled = disabled;
      }
    }

    // VAPID Í≥µÍ∞ú ÌÇ§Î•º Uint8ArrayÎ°ú Î≥ÄÌôòÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Í∏∞Ï°¥ ÏïåÎ¶º ÌëúÏãú Ìï®Ïàò
    function showNotification(message) {
      if (soundEnabled && document.getElementById('notification')) {
        document.getElementById('notification').play().catch(err => console.log('ÏÜåÎ¶¨ Ïû¨ÏÉù ÏóêÎü¨ / Error al reproducir sonido:', err));
      }
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerText = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, 2000);
      }, 50);
    }

    // Î°úÍ∑∏ÏïÑÏõÉ, Ïú†Ï†Ä Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Îì± Í∏∞Ï°¥ Ìï®ÏàòÎì§ÏùÄ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
    async function logout() {
      fetch('/logout', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      // Î°úÍ∑∏ÏïÑÏõÉ Ï†ÑÏóê Ï≤òÎ¶¨Îêú Î©îÏãúÏßÄ ID Ï†ÄÏû•
      try {
        if (myId) {
          localStorage.setItem(`${myId}_processedMessageIds`, JSON.stringify(processedMessageIds));
          console.log('[DEBUG] Î°úÍ∑∏ÏïÑÏõÉ Ïãú Ï†ÄÏû•Îêú Ï≤òÎ¶¨Îêú Î©îÏãúÏßÄ ID Î™©Î°ù:', Object.keys(processedMessageIds).length, 'Í∞ú');
        }
      } catch (e) {
        console.error('Î©îÏãúÏßÄ ID Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', e);
      }
      
      // ÌÜ†ÌÅ∞ ÏÇ≠Ï†ú
      localStorage.removeItem('token');
      
      // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
      processedMessageIds = {};
      lastNotifiedMessageIds = {};
      userMonera = 0;
      currentRoom = null;
      
      window.location.reload();
    }

    async function updateUserList() {
      const res = await fetch('/users', {
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Cache-Control': 'no-cache' // Ï∫êÏãú Î∞©ÏßÄ
        }
      });
      const onlineUsers = await res.json();
      const resAll = await fetch('/all-users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const allUsers = await resAll.json();
      const onlineUserIds = onlineUsers.map(u => u.userId);
      const offlineUsers = allUsers.filter(u => !onlineUserIds.includes(u.userId) && u.userId !== myId);
      const onlineUsersDiv = document.getElementById('online-users-list');
      const offlineUsersDiv = document.getElementById('offline-users-list');
      onlineUsersDiv.innerHTML = '';
      offlineUsersDiv.innerHTML = '';
      onlineUsers
        .filter(user => user.userId !== myId)
        .forEach(user => {
          const div = document.createElement('div');
          div.className = 'message';
          div.innerHTML = `<img src="${user.profilePic}" class="profile-pic"><span>${user.userId}</span>`;
          const addButton = document.createElement('button');
          addButton.innerText = 'ÏπúÍµ¨ Ï∂îÍ∞Ä / A√±adir amigo';
          addButton.onclick = () => addFriend(user.userId);
          div.appendChild(addButton);
          onlineUsersDiv.appendChild(div);
        });
      offlineUsers.forEach(user => {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<img src="${user.profilePic}" class="profile-pic"><span>${user.userId}</span>`;
        const addButton = document.createElement('button');
        addButton.innerText = 'ÏπúÍµ¨ Ï∂îÍ∞Ä / A√±adir amigo';
        addButton.onclick = () => addFriend(user.userId);
        div.appendChild(addButton);
        offlineUsersDiv.appendChild(div);
      });
      updateFriendsList();
    }

    async function addFriend(friendId) {
      const res = await fetch('/friends', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ userId: myId, friendId })
      });
      const data = await res.json();
      if (data.success) {
        updateFriendsList();
        showNotification(`${friendId}ÎãòÏù¥ ÏπúÍµ¨Î°ú Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§! / ¬°${friendId} ha sido a√±adido como amigo!`);
      }
      else if (data.message) alert(`${friendId}Îäî Ïù¥ÎØ∏ ÏπúÍµ¨Ïïº! / ¬°${friendId} ya es amigo!`);
    }

    async function removeFriend(friendId) {
      const res = await fetch('/friends', {
        method: 'DELETE',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ userId: myId, friendId })
      });
      const data = await res.json();
      if (data.success) updateFriendsList();
    }

    async function updateFriendsList() {
      const resFriends = await fetch(`/friends/${myId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const friends = await resFriends.json();
      const resUsers = await fetch('/all-users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const allUsers = await resUsers.json();
      const friendsDiv = document.getElementById('friends');
      friendsDiv.innerHTML = '';
      friends.forEach(friend => {
        const friendData = allUsers.find(u => u.userId === friend);
        const profilePic = friendData ? friendData.profilePic : '/uploads/default-profile.png';
        const div = document.createElement('div');
        div.className = 'message';
        const chatButton = document.createElement('button');
        chatButton.innerText = friend;
        const roomId = [myId, friend].sort().join('-');
        chatButton.onclick = () => startChat(roomId);
        const removeButton = document.createElement('button');
        removeButton.innerText = 'ÏÇ≠Ï†ú / Eliminar';
        removeButton.onclick = () => removeFriend(friend);
        
        // Add Monera transfer functionality
        const transferDiv = document.createElement('div');
        transferDiv.className = 'transfer-monera';
        const transferInput = document.createElement('input');
        transferInput.type = 'number';
        transferInput.min = '1';
        transferInput.placeholder = 'Î™®ÎÑ§Îùº / Monera';
        const transferButton = document.createElement('button');
        transferButton.innerText = 'Î™®ÎÑ§Îùº Î≥¥ÎÇ¥Í∏∞ / Enviar Monera';
        transferButton.onclick = () => {
          const amount = parseInt(transferInput.value);
          if (isNaN(amount) || amount <= 0) {
            alert('Ïú†Ìö®Ìïú ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. / Ingrese una cantidad v√°lida.');
            return;
          }
          if (amount > userMonera) {
            alert('Î™®ÎÑ§ÎùºÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî! / ¬°No tienes suficiente Monera!');
            return;
          }
          transferMonera(friend, amount);
        };
        transferDiv.appendChild(transferInput);
        transferDiv.appendChild(transferButton);
        
        div.innerHTML = `<img src="${profilePic}" class="profile-pic">`;
        div.appendChild(chatButton);
        div.appendChild(removeButton);
        div.appendChild(transferDiv);
        friendsDiv.appendChild(div);
      });
    }

    async function updateRoomList() {
      const resRooms = await fetch(`/rooms/${myId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const roomData = await resRooms.json();
      const resUsers = await fetch('/all-users', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const allUsers = await resUsers.json();
      const roomList = document.getElementById('room-list');
      roomList.innerHTML = '';
      roomData.forEach(({ roomId, lastMessage, unreadCount }) => {
        const participants = roomId.split('-').filter(id => id !== '');
        const roomName = participants.filter(id => id !== myId).join(', ');
        const friendId = participants.find(id => id !== myId);
        const friendData = allUsers.find(u => u.userId === friendId);
        const profilePic = friendData ? friendData.profilePic : '/uploads/default-profile.png';
        const roomButton = document.createElement('button');
        roomButton.innerHTML = `<img src="${profilePic}" class="profile-pic">${roomName}ÏôÄÏùò ÎåÄÌôî / Chat con ${roomName}`;
        if (unreadCount > 0) roomButton.classList.add('unread');
        roomButton.onclick = () => startChat(roomId);
        const preview = document.createElement('div');
        preview.innerText = lastMessage ? lastMessage.message.split('\n')[0] : 'ÎåÄÌôî ÏóÜÏùå / Sin mensajes';
        const div = document.createElement('div');
        div.className = 'message';
        div.appendChild(roomButton);
        div.appendChild(preview);
        roomList.appendChild(div);
      });
    }

    async function updateSettingsProfile() {
      try {
        const res = await fetch('/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await res.json();
        const me = users.find(u => u.userId === myId);
        
        // ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Ï†ÄÏû•
        if (me) {
          userProfilePic = me.profilePic;
        }
        
        // ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ ÏòÅÏó≠ ÏóÖÎç∞Ïù¥Ìä∏
        const userProfileDiv = document.getElementById('user-profile');
        if (userProfileDiv) {
          userProfileDiv.innerHTML = `
            <div class="profile-image-container">
              <img class="profile-pic" src="${userProfilePic || 'default-profile.png'}" alt="Profile">
            </div>
            <div class="profile-info">
              <p class="profile-id">${myId}</p>
              <p class="profile-monera">Î™®ÎÑ§Îùº: ${userMonera} / Monera: ${userMonera}</p>
            </div>
          `;
        }
        
        // ÏÑ§Ï†ï ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏
        const profileDiv = document.getElementById('settings-profile');
        if (profileDiv) {
          profileDiv.innerHTML = `
            <img src="${userProfilePic || 'default-profile.png'}" class="profile-pic">
            <span>${myId}</span>
            <div class="monera-display">
              <span class="monera-icon">üí∞</span>
              <span id="settings-monera-count">${userMonera}</span> Î™®ÎÑ§Îùº / Monera
            </div>
          `;
        }
      } catch (error) {
        console.error('ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
      }
    }

    async function startChat(roomId) {
      currentRoom = roomId;
      const tabs = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabs.length; i++) tabs[i].style.display = 'none';
      document.getElementById('chat').style.display = 'block';
      document.getElementById('room-list').style.display = 'none';
      document.getElementById('chat-room').style.display = 'block';
      
      // Ï±ÑÌåÖÎ∞© Î≥ÄÍ≤Ω Ïãú Î©îÏãúÏßÄ Ï∂îÏ†Å Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
      latestMessageTimestamps[roomId] = null;
      oldestMessageTimestamps[roomId] = null;
      
      if (!displayedMessageIds[roomId]) {
        displayedMessageIds[roomId] = new Set();
      } else {
        // Ï±ÑÌåÖÎ∞©ÏùÑ Îã§Ïãú Ïó¥ Îïå Ï∂îÏ†Å ÏÑ∏Ìä∏ Ï¥àÍ∏∞Ìôî (Ï§ëÎ≥µ Î©îÏãúÏßÄ Î∞©ÏßÄ ÏúÑÌï¥)
        displayedMessageIds[roomId] = new Set();
      }
      
      // Î°úÎî© Ï§ë ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      isLoadingOlderMessages = isLoadingOlderMessages || {};
      isLoadingOlderMessages[roomId] = false;
      
      // Î©îÏãúÏßÄ ÏûÖÎ†•Ï∞Ω ÏÉâÏÉÅ Î∞è ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      setMessageColor('black', false);
      document.getElementById('message').style.color = 'black';
      
      // Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä (Îß® ÏúÑÎ°ú Ïä§ÌÅ¨Î°§ Ïãú Ïù¥Ï†Ñ Î©îÏãúÏßÄ Î°úÎìú)
      const chatMessages = document.getElementById('chat-messages');
      chatMessages.onscroll = handleChatScroll;
      
      // Ï¥àÍ∏∞ Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú
      await loadInitialChatHistory(roomId);
      
      // Ìè¥ÎßÅ ÏÑ§Ï†ï
      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = setInterval(() => {
        if (!isPollingPaused) pollNewMessages();
      }, 2000);
    }

    // Ï¥àÍ∏∞ Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎî© Ìï®Ïàò
    async function loadInitialChatHistory(roomId) {
      if (!roomId) return;
      
      try {
        // Ï±ÑÌåÖ Î©îÏãúÏßÄ Ïª®ÌÖåÏù¥ÎÑà Ï¥àÍ∏∞Ìôî
        const chat = document.getElementById('chat-messages');
        chat.innerHTML = '';
        
        // Ìï¥Îãπ Î∞©Ïùò displayedMessageIds Ï¥àÍ∏∞Ìôî
        displayedMessageIds[roomId] = new Set();
        
        // ÏÇ≠Ï†ú ÏãúÏ†ê ÌôïÏù∏ - Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
        const deletedRooms = JSON.parse(localStorage.getItem('deletedRooms') || '{}');
        const myDeleteTimestamp = deletedRooms[`${roomId}_${myId}`];
        
        // URL Íµ¨ÏÑ± (limit ÌååÎùºÎØ∏ÌÑ∞Îßå ÏÇ¨Ïö©)
        let url = `/chat/${roomId}/${myId}?limit=50`;
        
        // ÏÇ≠Ï†ú ÏãúÏ†ê Ï∂îÍ∞Ä (ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
        if (myDeleteTimestamp) {
          url += `&deleteTime=${encodeURIComponent(myDeleteTimestamp)}`;
        }
        
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const messages = await res.json();
        
        if (!messages || messages.length === 0) return;
        
        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
        let allUsers = null;
        try {
          const resUsers = await fetch('/all-users', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          allUsers = await resUsers.json();
        } catch (error) {
          console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
          // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
        }
        
        // Î©îÏãúÏßÄ ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÏÑúÎ≤ÑÏóêÏÑú ÎÇ¥Î¶ºÏ∞®ÏàúÏúºÎ°ú Î∞õÍ∏∞ ÎïåÎ¨∏Ïóê Îã§Ïãú Ïò§Î¶ÑÏ∞®ÏàúÏúºÎ°ú Ï†ïÎ†¨)
        const sortedMessages = [...messages].reverse();
        
        // Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        for (const data of sortedMessages) {
          const messageId = data.id || `${data.timestamp}-${data.from}`;
          
          // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÎäî Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
          if (displayedMessageIds[roomId].has(messageId)) {
            continue;
          }
          
          // DOMÏóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä (ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÑÎã¨)
          await appendSingleMessageToDOM(data, allUsers, 'append');
        }
        
        // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
        if (sortedMessages.length > 0) {
          // Í∞ÄÏû• ÏµúÏã† Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï†ÄÏû•
          const lastMessage = sortedMessages[sortedMessages.length - 1];
          latestMessageTimestamps[roomId] = lastMessage.timestamp;
          
          // Í∞ÄÏû• Ïò§ÎûòÎêú Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï†ÄÏû•
          const firstMessage = sortedMessages[0];
          oldestMessageTimestamps[roomId] = firstMessage.timestamp;
        }
        
        // Ï±ÑÌåÖÏ∞ΩÏùÑ Îß® ÏïÑÎûòÎ°ú Ïä§ÌÅ¨Î°§
        chat.scrollTop = chat.scrollHeight;
        
      } catch (error) {
        console.error('Ï¥àÍ∏∞ Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú Ïã§Ìå®:', error);
      }
    }
    
    // Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Ìï®Ïàò
    function handleChatScroll() {
      if (!currentRoom) return;
      
      const chat = document.getElementById('chat-messages');
      
      // Îß® ÏúÑ Í∑ºÏ≤òÎ°ú Ïä§ÌÅ¨Î°§ÌñàÎäîÏßÄ ÌôïÏù∏ (ÏÉÅÎã® 20px Ïù¥ÎÇ¥)
      if (chat.scrollTop < 20 && !isLoadingOlderMessages[currentRoom] && oldestMessageTimestamps[currentRoom]) {
        // Í≥ºÍ±∞ Î©îÏãúÏßÄ Î°úÎìú
        loadOlderMessages(currentRoom);
      }
    }
    
    // Í≥ºÍ±∞ Î©îÏãúÏßÄ Î°úÎìú Ìï®Ïàò
    async function loadOlderMessages(roomId) {
      if (!roomId || !oldestMessageTimestamps[roomId]) return;
      
      // Ïù¥ÎØ∏ Î°úÎî© Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ ÏöîÏ≤≠ Î∞©ÏßÄ
      if (isLoadingOlderMessages[roomId]) return;
      
      try {
        isLoadingOlderMessages[roomId] = true;
        
        // Î°úÎî© ÌëúÏãú
        const chat = document.getElementById('chat-messages');
        const loader = document.createElement('p');
        loader.className = 'message-loader';
        loader.innerHTML = 'Ïù¥Ï†Ñ Î©îÏãúÏßÄ Î°úÎìú Ï§ë... / Cargando mensajes anteriores...';
        chat.prepend(loader);
        
        // ÏÇ≠Ï†ú ÏãúÏ†ê ÌôïÏù∏ - Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
        const deletedRooms = JSON.parse(localStorage.getItem('deletedRooms') || '{}');
        const myDeleteTimestamp = deletedRooms[`${roomId}_${myId}`];
        
        // URL Íµ¨ÏÑ±
        let url = `/chat/${roomId}/${myId}?beforeTimestamp=${encodeURIComponent(oldestMessageTimestamps[roomId])}&limit=50`;
        
        // ÏÇ≠Ï†ú ÏãúÏ†ê Ï∂îÍ∞Ä (ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
        if (myDeleteTimestamp) {
          url += `&deleteTime=${encodeURIComponent(myDeleteTimestamp)}`;
        }
        
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const messages = await res.json();
        
        // Î°úÎî© ÌëúÏãú Ï†úÍ±∞
        if (loader.parentNode) {
          loader.parentNode.removeChild(loader);
        }
        
        if (!messages || messages.length === 0) {
          console.log('Îçî Ïù¥ÏÉÅ Ïù¥Ï†Ñ Î©îÏãúÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.');
          isLoadingOlderMessages[roomId] = false;
          return;
        }
        
        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
        let allUsers = null;
        try {
          const resUsers = await fetch('/all-users', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          allUsers = await resUsers.json();
        } catch (error) {
          console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
          // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
        }
        
        // Î©îÏãúÏßÄ ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÏÑúÎ≤ÑÏóêÏÑú ÎÇ¥Î¶ºÏ∞®ÏàúÏúºÎ°ú Î∞õÍ∏∞ ÎïåÎ¨∏Ïóê Îã§Ïãú Ïò§Î¶ÑÏ∞®ÏàúÏúºÎ°ú Ï†ïÎ†¨)
        const sortedMessages = [...messages].reverse();
        
        // ÌôîÎ©¥Ïóê Ï∂îÍ∞ÄÎê† ÏöîÏÜå height Í≥ÑÏÇ∞Ïö© Î≥ÄÏàò
        let newContentHeight = 0;
        const addedElements = [];
        
        // Î©îÏãúÏßÄ Ï∂îÍ∞Ä (Îß® ÏúÑÏóê Ï∂îÍ∞Ä)
        for (const data of sortedMessages) {
          const messageId = data.id || `${data.timestamp}-${data.from}`;
          
          // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÎäî Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
          if (displayedMessageIds[roomId].has(messageId)) {
            continue;
          }
          
          // DOMÏóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä (ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÑÎã¨)
          const element = await appendSingleMessageToDOM(data, allUsers, 'prepend');
          if (element) {
            addedElements.push(element);
          }
        }
        
        // Ï∂îÍ∞ÄÎêú ÏöîÏÜåÎì§Ïùò ÎÜíÏù¥ Í≥ÑÏÇ∞
        addedElements.forEach(el => {
          newContentHeight += el.offsetHeight;
        });
        
        // Ïä§ÌÅ¨Î°§ ÏúÑÏπò Ï°∞Ï†ï (ÏÇ¨Ïö©Ïûê Î∑∞ ÏïàÏ†ïÏÑ± Ïú†ÏßÄ)
        if (newContentHeight > 0) {
          chat.scrollTop = newContentHeight;
        }
        
        // Í∞ÄÏû• Ïò§ÎûòÎêú Î©îÏãúÏßÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
        if (sortedMessages.length > 0) {
          const firstMessage = sortedMessages[0];
          oldestMessageTimestamps[roomId] = firstMessage.timestamp;
        }
        
      } catch (error) {
        console.error('Ïù¥Ï†Ñ Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú Ïã§Ìå®:', error);
      } finally {
        isLoadingOlderMessages[roomId] = false;
      }
    }

    // ÏÉà Î©îÏãúÏßÄ Ìè¥ÎßÅ Ìï®Ïàò (Í∏∞Ï°¥ loadChatHistory Ìï®Ïàò ÎåÄÏ≤¥)
    async function pollNewMessages() {
      if (!currentRoom) return;
      
      // Ï¥àÍ∏∞ Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏúºÎ©¥ Î¶¨ÌÑ¥
      if (!latestMessageTimestamps[currentRoom]) return;

      try {
        // Ïä§ÌÅ¨Î°§ ÏúÑÏπò ÌôïÏù∏ (ÏÉà Î©îÏãúÏßÄÍ∞Ä Ïò§Î©¥ ÏûêÎèô Ïä§ÌÅ¨Î°§ Ïó¨Î∂Ä Í≤∞Ï†ï)
        const chat = document.getElementById('chat-messages');
        const wasScrolledToBottom = chat.scrollHeight - chat.scrollTop <= chat.clientHeight + 100;
        
        // ÏÇ≠Ï†ú ÏãúÏ†ê ÌôïÏù∏ - Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
        const deletedRooms = JSON.parse(localStorage.getItem('deletedRooms') || '{}');
        const myDeleteTimestamp = deletedRooms[`${currentRoom}_${myId}`];
        
        // URL Íµ¨ÏÑ± (since ÌååÎùºÎØ∏ÌÑ∞ ÏÇ¨Ïö©)
        let url = `/chat/${currentRoom}/${myId}?since=${encodeURIComponent(latestMessageTimestamps[currentRoom])}`;
        
        // ÏÇ≠Ï†ú ÏãúÏ†ê Ï∂îÍ∞Ä (ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
        if (myDeleteTimestamp) {
          url += `&deleteTime=${encodeURIComponent(myDeleteTimestamp)}`;
        }
        
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const messages = await res.json();
        
        if (!messages || messages.length === 0) return;
        
        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
        let allUsers = null;
        try {
          const resUsers = await fetch('/all-users', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          allUsers = await resUsers.json();
        } catch (error) {
          console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
          // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
        }
        
        // ÌòÑÏû¨ Ï±ÑÌåÖÎ∞©Ïùò displayedMessageIds Í∞ùÏ≤¥ Ï¥àÍ∏∞Ìôî (ÏóÜÎäî Í≤ΩÏö∞)
        if (!displayedMessageIds[currentRoom]) {
          displayedMessageIds[currentRoom] = new Set();
        }
        
        // ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄÎßå ÌïÑÌÑ∞ÎßÅ (Ï§ëÎ≥µ Î©îÏãúÏßÄ Ï†úÍ±∞)
        const newMessages = messages.filter(data => {
          // Î©îÏãúÏßÄ IDÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÏôÄ Î∞úÏã†Ïûê IDÎ°ú Ïú†ÎãàÌÅ¨ ID ÏÉùÏÑ±
          const messageId = data.id || `${data.timestamp}-${data.from}`;
          
          // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÏù∏ÏßÄ ÌôïÏù∏
          if (displayedMessageIds[currentRoom].has(messageId)) {
            return false; // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÎäî Ï†úÏô∏
          }
          
          return true;
        });
        
        // Î™®ÎÑ§Îùº Ï†ÅÎ¶Ω Î°úÏßÅ (ÏÉà Î©îÏãúÏßÄÏóê ÎåÄÌï¥ÏÑúÎßå)
        let newMessagesToAccrue = 0;
        const newMessageIds = [];
        
        newMessages.forEach(message => {
          // Î©îÏãúÏßÄ ID ÏÉùÏÑ± (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
          const messageId = message.id || `${message.timestamp}-${message.from}`;
          
          // ÎÇ¥Í∞Ä Î≥¥ÎÇ∏ Î©îÏãúÏßÄÍ∞Ä ÏïÑÎãàÍ≥†, Ïù¥Ï†ÑÏóê Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùÄ Î©îÏãúÏßÄÎßå Î™®ÎÑ§Îùº Ï†ÅÎ¶Ω ÎåÄÏÉÅ
          if (message.from !== myId && !processedMessageIds[messageId]) {
            newMessagesToAccrue++;
            newMessageIds.push(messageId);
          }
        });

        if (newMessages.length > 0) {
          console.log('[DEBUG] Ï±ÑÌåÖÎ∞©:', currentRoom, 'ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄ:', newMessages.length, 'Í∞ú');
        }
        
        // Ïã†Í∑ú Î©îÏãúÏßÄÍ∞Ä ÏûàÏùÑ Í≤ΩÏö∞ Î™®ÎÑ§Îùº Ï†ÅÎ¶Ω Î∞è Î©îÏãúÏßÄ ID Ï†ÄÏû•
        if (newMessagesToAccrue > 0) {
          earnMonera(newMessagesToAccrue).then(success => {
            if (success) {
              console.log('[DEBUG] Î™®ÎÑ§Îùº Ï†ÅÎ¶Ω:', newMessagesToAccrue, 'Í∞ú');
            }
          });
          
          // Ï≤òÎ¶¨Îêú Î©îÏãúÏßÄ ID Ï†ÄÏû•
          newMessageIds.forEach(id => {
            processedMessageIds[id] = true;
          });
          
          // localStorageÏóê Ï≤òÎ¶¨Îêú Î©îÏãúÏßÄ ID Ï†ÄÏû•
          try {
            localStorage.setItem(`${myId}_processedMessageIds`, JSON.stringify(processedMessageIds));
          } catch (e) {
            console.error('Î©îÏãúÏßÄ ID Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', e);
            
            // Ï†ÄÏû• Ïò§Î•ò Ïãú Ïò§ÎûòÎêú Îç∞Ïù¥ÌÑ∞Î•º Ï†ïÎ¶¨ ÌõÑ Îã§Ïãú ÏãúÎèÑ
            // ... (Í∏∞Ï°¥ ÏΩîÎìú Ïú†ÏßÄ)
          }
        }
        
        // ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄÍ∞Ä ÏûàÏùÑ ÎïåÎßå ÎßàÏßÄÎßâ Î©îÏãúÏßÄÏóê ÎåÄÌïú ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù
        if (newMessages.length > 0) {
          const lastMessage = newMessages[newMessages.length - 1];
          const lastMessageId = lastMessage.id || `${lastMessage.timestamp}-${lastMessage.from}`;
          
          // ÎßàÏßÄÎßâ Î©îÏãúÏßÄÍ∞Ä ÎÇ¥Í∞Ä Î≥¥ÎÇ∏ Í≤ÉÏù¥ ÏïÑÎãàÍ≥†, Ïù¥Ï†ÑÏóê ÏïåÎ¶ºÏùÑ Ïû¨ÏÉùÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞Îßå ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù
          if (lastMessage.from !== myId && lastNotifiedMessageIds[currentRoom] !== lastMessageId) {
            // ÎßàÏßÄÎßâ ÏïåÎ¶º Î©îÏãúÏßÄ ID ÏóÖÎç∞Ïù¥Ìä∏
            lastNotifiedMessageIds[currentRoom] = lastMessageId;
            
            // ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù
            if (soundEnabled) {
              const audio = document.getElementById('notification');
              if (audio) {
                audio.play().catch(err => console.log('ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù Ïã§Ìå® / Error al reproducir sonido:', err));
              }
            }
          }
        }
        
        // ÏÉà Î©îÏãúÏßÄÎì§ÏùÑ DOMÏóê Ï∂îÍ∞Ä
        for (const data of newMessages) {
          await appendSingleMessageToDOM(data, allUsers, 'append');
        }
        
        // ÎßàÏßÄÎßâ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
        if (newMessages.length > 0) {
          const lastMessage = newMessages[newMessages.length - 1];
          latestMessageTimestamps[currentRoom] = lastMessage.timestamp;
        }
        
        // Ïò§ÏßÅ Ïù¥Ï†ÑÏóê Ïä§ÌÅ¨Î°§Ïù¥ Îß® ÏïÑÎûòÏóê ÏûàÏóàÏùÑ ÎïåÎßå Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô
        if (wasScrolledToBottom) {
          chat.scrollTop = chat.scrollHeight;
        }
      } catch (error) {
        console.error('Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú Ïã§Ìå®:', error);
        // Ïò§Î•ò Î©îÏãúÏßÄÎ•º ÏïåÎ¶ºÏ∞ΩÏúºÎ°ú ÌëúÏãúÌïòÏßÄ ÏïäÍ≥† ÏΩòÏÜîÏóêÎßå Î°úÍ∑∏ ÎÇ®ÍπÄ
      }
    }

    function pausePolling() {
      isPollingPaused = true;
    }

    function resumePolling() {
      isPollingPaused = false;
    }

    async function loadAllChat() {
      try {
        // ÎßàÏßÄÎßâ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÌôïÏù∏
        const latestTimestamp = latestAllChatMessageTimestamp;
        
        // Ïä§ÌÅ¨Î°§ ÏúÑÏπò ÌôïÏù∏ (ÏÉà Î©îÏãúÏßÄÍ∞Ä Ïò§Î©¥ ÏûêÎèô Ïä§ÌÅ¨Î°§ Ïó¨Î∂Ä Í≤∞Ï†ï)
        const chat = document.getElementById('all-chat-messages');
        const wasScrolledToBottom = chat.scrollHeight - chat.scrollTop <= chat.clientHeight + 100;
        
        // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Í∏∞Î∞ò URL Íµ¨ÏÑ±
        let url = '/all-chat';
        if (latestTimestamp) {
          url += `?since=${encodeURIComponent(latestTimestamp)}`;
        }
        
        const resMessages = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const messages = await resMessages.json();
        
        // ÏÉà Î©îÏãúÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Îçî Ïù¥ÏÉÅ Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå
        if (!messages || messages.length === 0) return;
        
        const resUsers = await fetch('/all-users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const allUsers = await resUsers.json();
        
        // Ï†ÑÏ≤¥ Ï±ÑÌåÖÏùò displayedMessageIds Í∞ùÏ≤¥ Ï¥àÍ∏∞Ìôî (ÏóÜÎäî Í≤ΩÏö∞)
        if (!displayedMessageIds['all-chat']) {
          displayedMessageIds['all-chat'] = new Set();
        }
        
        // ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄÎßå ÌïÑÌÑ∞ÎßÅ (Ï§ëÎ≥µ Î©îÏãúÏßÄ Ï†úÍ±∞)
        const newMessages = messages.filter(data => {
          // Î©îÏãúÏßÄ IDÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÏôÄ Î∞úÏã†Ïûê IDÎ°ú Ïú†ÎãàÌÅ¨ ID ÏÉùÏÑ±
          const messageId = data.id || `${data.timestamp}-${data.from}`;
          
          // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÏù∏ÏßÄ ÌôïÏù∏
          if (displayedMessageIds['all-chat'].has(messageId)) {
            return false; // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÎäî Ï†úÏô∏
          }
          
          // ÏÉà Î©îÏãúÏßÄ IDÎ•º Ï∂îÏ†Å ÏÑ∏Ìä∏Ïóê Ï∂îÍ∞Ä
          displayedMessageIds['all-chat'].add(messageId);
          return true;
        });
        
        // Ï†ÑÏ≤¥ Ï±ÑÌåÖÏóêÏÑúÎäî Î™®ÎÑ§ÎùºÎ•º Ï†ÅÎ¶ΩÌïòÏßÄ ÏïäÏùå
        // ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù (ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄÍ∞Ä ÏûàÏùÑ ÎïåÎßå)
        if (newMessages.length > 0) {
          const lastMessage = newMessages[newMessages.length - 1];
          const lastMessageId = lastMessage.id || `${lastMessage.timestamp}-${lastMessage.from}`;
          
          // ÎßàÏßÄÎßâ Î©îÏãúÏßÄÍ∞Ä ÎÇ¥Í∞Ä Î≥¥ÎÇ∏ Í≤ÉÏù¥ ÏïÑÎãàÍ≥†, Ïù¥Ï†ÑÏóê ÏïåÎ¶ºÏùÑ Ïû¨ÏÉùÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞Îßå ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù
          if (lastMessage.from !== myId && lastNotifiedMessageIds['all-chat'] !== lastMessageId) {
            // ÎßàÏßÄÎßâ ÏïåÎ¶º Î©îÏãúÏßÄ ID ÏóÖÎç∞Ïù¥Ìä∏
            lastNotifiedMessageIds['all-chat'] = lastMessageId;
            
            // ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù
            if (soundEnabled) {
              const audio = document.getElementById('notification');
              if (audio) {
                audio.play().catch(err => console.log('ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù Ïã§Ìå® / Error al reproducir sonido:', err));
              }
            }
          }
        }
        
        // ÏÉà Î©îÏãúÏßÄÎì§ÏùÑ DOMÏóê Ï∂îÍ∞Ä
        for (const data of newMessages) {
          await appendSingleAllMessage(data, allUsers);
        }
        
        // ÎßàÏßÄÎßâ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
        if (newMessages.length > 0) {
          const lastMessage = newMessages[newMessages.length - 1];
          latestAllChatMessageTimestamp = lastMessage.timestamp;
        }
        
        // Ïò§ÏßÅ Ïù¥Ï†ÑÏóê Ïä§ÌÅ¨Î°§Ïù¥ Îß® ÏïÑÎûòÏóê ÏûàÏóàÏùÑ ÎïåÎßå Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô
        if (wasScrolledToBottom) {
          chat.scrollTop = chat.scrollHeight;
        }
      } catch (error) {
        console.error('Ï†ÑÏ≤¥ Ï±ÑÌåÖ Î°úÎìú Ïã§Ìå®:', error);
      }
    }

    async function sendMessage() {
      const message = document.getElementById('message').value;
      if (!currentRoom || !message) return;
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ 
            roomId: currentRoom, 
            from: myId, 
            message,
            color: selectedColor
          })
        });
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        const data = await res.json();
        if (data.success) {
          document.getElementById('message').value = '';
          // Reset color to black after sending
          setMessageColor('black', false);
          // Reset input style
          document.getElementById('message').style.color = 'black';
          
          // ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°Îêú Î©îÏãúÏßÄÎ•º DOMÏóê Ï¶âÏãú Ï∂îÍ∞Ä
          if (data.message) {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            let allUsers = null;
            try {
              const resUsers = await fetch('/all-users', {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              allUsers = await resUsers.json();
            } catch (error) {
              console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
              // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
            }
            
            await appendSingleMessageToDOM(data.message, allUsers, 'append');
            
            // Ï±ÑÌåÖÏ∞ΩÏùÑ Îß® ÏïÑÎûòÎ°ú Ïä§ÌÅ¨Î°§
            const chat = document.getElementById('chat-messages');
            chat.scrollTop = chat.scrollHeight;
            
            // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏ (Ìè¥ÎßÅÏù¥ Ïò¨Î∞îÎ•¥Í≤å ÎèôÏûëÌïòÎèÑÎ°ù)
            if (data.message.timestamp) {
              latestMessageTimestamps[currentRoom] = data.message.timestamp;
            }
          }
        } else {
          alert(data.message || 'Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå® / Error al enviar mensaje');
        }
      } catch (error) {
        console.error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
        alert('Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥ÏßÄ Î™ªÌñàÏñ¥Ïöî. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. / No se pudo enviar el mensaje. Por favor, verifica el estado del servidor.');
      }
    }

    async function sendAllMessage() {
      const message = document.getElementById('all-message').value;
      if (!message) return;
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ 
            roomId: 'all-chat', 
            from: myId, 
            message,
            color: allSelectedColor
          })
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const data = await res.json();
        if (data.success) {
          document.getElementById('all-message').value = '';
          // Reset color to black after sending
          setAllMessageColor('black', false);
          // Reset input style
          document.getElementById('all-message').style.color = 'black';
          
          // ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°Îêú Î©îÏãúÏßÄÎ•º DOMÏóê Ï¶âÏãú Ï∂îÍ∞Ä
          if (data.message) {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            let allUsers = null;
            try {
              const resUsers = await fetch('/all-users', {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              allUsers = await resUsers.json();
            } catch (error) {
              console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
              // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
            }
            
            await appendSingleAllMessage(data.message, allUsers);
            
            // Ï±ÑÌåÖÏ∞ΩÏùÑ Îß® ÏïÑÎûòÎ°ú Ïä§ÌÅ¨Î°§
            const chat = document.getElementById('all-chat-messages');
            chat.scrollTop = chat.scrollHeight;
            
            // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏ (Ìè¥ÎßÅÏù¥ Ïò¨Î∞îÎ•¥Í≤å ÎèôÏûëÌïòÎèÑÎ°ù)
            if (data.message.timestamp) {
              latestAllChatMessageTimestamp = data.message.timestamp;
            }
          }
        } else {
          alert(data.message || 'Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå® / Error al enviar mensaje');
        }
      } catch (error) {
        console.error('Ï†ÑÏ≤¥ Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
        alert('Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥ÏßÄ Î™ªÌñàÏñ¥Ïöî. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. / No se pudo enviar el mensaje. Por favor, verifica el estado del servidor.');
      }
    }

    async function sendFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!currentRoom || !file) return;
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('roomId', currentRoom);
      formData.append('from', myId);
      
      try {
        const res = await fetch('/upload', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const data = await res.json();
        if (data.success) {
          fileInput.value = '';
          
          // ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°Îêú ÌååÏùº Î©îÏãúÏßÄÎ•º DOMÏóê Ï¶âÏãú Ï∂îÍ∞Ä
          if (data.message) {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            let allUsers = null;
            try {
              const resUsers = await fetch('/all-users', {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              allUsers = await resUsers.json();
            } catch (error) {
              console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
              // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
            }
            
            await appendSingleMessageToDOM(data.message, allUsers, 'append');
            
            // Ï±ÑÌåÖÏ∞ΩÏùÑ Îß® ÏïÑÎûòÎ°ú Ïä§ÌÅ¨Î°§
            const chat = document.getElementById('chat-messages');
            chat.scrollTop = chat.scrollHeight;
            
            // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏ (Ìè¥ÎßÅÏù¥ Ïò¨Î∞îÎ•¥Í≤å ÎèôÏûëÌïòÎèÑÎ°ù)
            if (data.message.timestamp) {
              latestMessageTimestamps[currentRoom] = data.message.timestamp;
            }
          }
        } else {
          alert(data.message || 'ÌååÏùº Ï†ÑÏÜ° Ïã§Ìå® / Error al enviar archivo');
        }
      } catch (error) {
        console.error('ÌååÏùº Ï†ÑÏÜ° Ïã§Ìå®:', error);
        alert('ÌååÏùºÏùÑ Î≥¥ÎÇ¥ÏßÄ Î™ªÌñàÏñ¥Ïöî. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. / No se pudo enviar el archivo. Por favor, verifica el estado del servidor.');
      }
    }

    async function sendAllFile() {
      const fileInput = document.getElementById('all-fileInput');
      const file = fileInput.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('roomId', 'all-chat');
      formData.append('from', myId);
      
      try {
        const res = await fetch('/upload', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const data = await res.json();
        if (data.success) {
          fileInput.value = '';
          
          // Î≥ÄÍ≤Ω: loadAllChat() Ìò∏Ï∂ú ÎåÄÏã† appendSingleAllMessage Ìï®Ïàò ÏÇ¨Ïö©
          if (data.message) {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            let allUsers = null;
            try {
              const resUsers = await fetch('/all-users', {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              allUsers = await resUsers.json();
            } catch (error) {
              console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
              // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
            }
            
            await appendSingleAllMessage(data.message, allUsers);
          }
        } else {
          alert(data.message || 'ÌååÏùº Ï†ÑÏÜ° Ïã§Ìå® / Error al enviar archivo');
        }
      } catch (error) {
        console.error('Ï†ÑÏ≤¥ ÌååÏùº Ï†ÑÏÜ° Ïã§Ìå®:', error);
        alert('ÌååÏùºÏùÑ Î≥¥ÎÇ¥ÏßÄ Î™ªÌñàÏñ¥Ïöî. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. / No se pudo enviar el archivo. Por favor, verifica el estado del servidor.');
      }
    }

    async function uploadProfile() {
      const fileInput = document.getElementById('profileInput');
      const file = fileInput.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('profile', file);
      formData.append('userId', myId);
      
      try {
        const res = await fetch('/upload/profile', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();
        if (data.success) {
          alert('ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏñ¥Ïöî! / ¬°Foto de perfil cambiada!');
          updateUserList();
          updateFriendsList();
          updateRoomList();
          updateSettingsProfile();
          pollNewMessages();
          loadAllChat();
        } else {
          alert(data.message || 'ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑÏùÑ Î≥ÄÍ≤ΩÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî. / No se pudo cambiar la foto de perfil.');
        }
      } catch (error) {
        console.error('ÌîÑÎ°úÌïÑ ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
        alert('ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑÏùÑ Î≥ÄÍ≤ΩÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî. / No se pudo cambiar la foto de perfil.');
      }
    }

    function showEmojiPicker() {
      const picker = document.getElementById('emoji-picker');
      picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      if (picker.style.display !== 'block') return;
      
      picker.innerHTML = '';
      
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'emoji-close-btn';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = () => {
        picker.style.display = 'none';
      };
      picker.appendChild(closeBtn);
      
      // Create category selection
      const categories = document.createElement('div');
      categories.className = 'emoji-categories';
      Object.keys(emojiCategories).forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'emoji-category-btn' + (category === selectedCategory ? ' active' : '');
        btn.innerText = category === 'basic' ? 'Í∏∞Î≥∏ / B√°sico' : 
                        category === 'faces' ? 'ÌëúÏ†ï / Caras' : 
                        category === 'animals' ? 'ÎèôÎ¨º / Animales' : 
                        category === 'food' ? 'ÏùåÏãù / Comida' : 
                        category === 'activities' ? 'ÌôúÎèô / Actividades' : 'Ïó¨Ìñâ / Viajes';
        btn.onclick = (e) => {
          e.stopPropagation();
          
          // Update active class for categories
          document.querySelectorAll('.emoji-category-btn').forEach(b => {
            b.classList.remove('active');
          });
          btn.classList.add('active');
          
          selectedCategory = category;
          
          // Update emoji grid without closing picker
          updateEmojiGrid(picker);
        };
        categories.appendChild(btn);
      });
      picker.appendChild(categories);
      
      // Create emoji grid
      updateEmojiGrid(picker);
      
      picker.style.left = '50%';
      picker.style.top = '80%';
    }
    
    function updateEmojiGrid(picker) {
      // Í∏∞Ï°¥ Í∑∏Î¶¨Îìú Ï†úÍ±∞
      const existingGrid = picker.querySelector('.emoji-grid');
      if (existingGrid) {
        picker.removeChild(existingGrid);
      }
      
      const grid = document.createElement('div');
      grid.className = 'emoji-grid';
      
      emojiCategories[selectedCategory].forEach((emoji, index) => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn' + (selectedCategory !== 'basic' && index >= 8 ? ' premium-item' : '');
        btn.innerText = emoji;
        btn.onclick = () => {
          const messageInput = document.getElementById('message');
          const cursorPos = messageInput.selectionStart;
          const textBefore = messageInput.value.substring(0, cursorPos);
          const textAfter = messageInput.value.substring(cursorPos);
          
          if (selectedCategory !== 'basic' && index >= 8) {
            // ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïù¥Î™®ÏßÄ
            if (userMonera >= 5) {
              showConfirmDialog(
                `Î™®ÎÑ§Îùº 5Í∞úÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ïù¥Î™®ÏßÄÎ•º ÏÇ¨Ïö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå? / ¬øQuieres usar 5 Monera para usar este emoji?`,
                () => {
                  spendMonera(5).then(success => {
                    if (success) {
                      // Ïª§ÏÑú ÏúÑÏπòÏóê Ïù¥Î™®ÏßÄ ÏÇΩÏûÖ
                      messageInput.value = textBefore + emoji + textAfter;
                      
                      // Ïª§ÏÑú ÏúÑÏπòÎ•º Ïù¥Î™®ÏßÄ Îí§Î°ú Ïù¥Îèô
                      messageInput.selectionStart = cursorPos + emoji.length;
                      messageInput.selectionEnd = cursorPos + emoji.length;
                      messageInput.focus();
                      
                      // ÌîºÏª§ Îã´Í∏∞
                      picker.style.display = 'none';
                    }
                  });
                }
              );
            } else {
              alert('Î™®ÎÑ§ÎùºÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî! / ¬°No tienes suficiente Monera!');
            }
          } else {
            // Î¨¥Î£å Ïù¥Î™®ÏßÄ
            // Ïª§ÏÑú ÏúÑÏπòÏóê Ïù¥Î™®ÏßÄ ÏÇΩÏûÖ
            messageInput.value = textBefore + emoji + textAfter;
            
            // Ïª§ÏÑú ÏúÑÏπòÎ•º Ïù¥Î™®ÏßÄ Îí§Î°ú Ïù¥Îèô
            messageInput.selectionStart = cursorPos + emoji.length;
            messageInput.selectionEnd = cursorPos + emoji.length;
            messageInput.focus();
            
            // ÌîºÏª§ Îã´Í∏∞
            picker.style.display = 'none';
          }
        };
        grid.appendChild(btn);
      });
      
      picker.appendChild(grid);
    }

    function showEmojiPickerAll() {
      const picker = document.getElementById('emoji-picker-all');
      picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      if (picker.style.display !== 'block') return;
      
      picker.innerHTML = '';
      
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'emoji-close-btn';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = () => {
        picker.style.display = 'none';
      };
      picker.appendChild(closeBtn);
      
      // Create category selection
      const categories = document.createElement('div');
      categories.className = 'emoji-categories';
      Object.keys(emojiCategories).forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'emoji-category-btn' + (category === selectedCategory ? ' active' : '');
        btn.innerText = category === 'basic' ? 'Í∏∞Î≥∏ / B√°sico' : 
                        category === 'faces' ? 'ÌëúÏ†ï / Caras' : 
                        category === 'animals' ? 'ÎèôÎ¨º / Animales' : 
                        category === 'food' ? 'ÏùåÏãù / Comida' : 
                        category === 'activities' ? 'ÌôúÎèô / Actividades' : 'Ïó¨Ìñâ / Viajes';
        btn.onclick = (e) => {
          e.stopPropagation();
          
          // Update active class for categories
          document.querySelectorAll('#emoji-picker-all .emoji-category-btn').forEach(b => {
            b.classList.remove('active');
          });
          btn.classList.add('active');
          
          selectedCategory = category;
          
          // Update emoji grid without closing picker
          updateEmojiGridAll(picker);
        };
        categories.appendChild(btn);
      });
      picker.appendChild(categories);
      
      // Create emoji grid
      updateEmojiGridAll(picker);
      
      picker.style.left = '50%';
      picker.style.top = '80%';
    }
    
    function updateEmojiGridAll(picker) {
      // Í∏∞Ï°¥ Í∑∏Î¶¨Îìú Ï†úÍ±∞
      const existingGrid = picker.querySelector('.emoji-grid');
      if (existingGrid) {
        picker.removeChild(existingGrid);
      }
      
      const grid = document.createElement('div');
      grid.className = 'emoji-grid';
      
      emojiCategories[selectedCategory].forEach((emoji, index) => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn' + (selectedCategory !== 'basic' && index >= 8 ? ' premium-item' : '');
        btn.innerText = emoji;
        btn.onclick = () => {
          const messageInput = document.getElementById('all-message');
          const cursorPos = messageInput.selectionStart;
          const textBefore = messageInput.value.substring(0, cursorPos);
          const textAfter = messageInput.value.substring(cursorPos);
          
          if (selectedCategory !== 'basic' && index >= 8) {
            // ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïù¥Î™®ÏßÄ
            if (userMonera >= 5) {
              showConfirmDialog(
                `Î™®ÎÑ§Îùº 5Í∞úÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ïù¥Î™®ÏßÄÎ•º ÏÇ¨Ïö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå? / ¬øQuieres usar 5 Monera para usar este emoji?`,
                () => {
                  spendMonera(5).then(success => {
                    if (success) {
                      // Ïª§ÏÑú ÏúÑÏπòÏóê Ïù¥Î™®ÏßÄ ÏÇΩÏûÖ
                      messageInput.value = textBefore + emoji + textAfter;
                      
                      // Ïª§ÏÑú ÏúÑÏπòÎ•º Ïù¥Î™®ÏßÄ Îí§Î°ú Ïù¥Îèô
                      messageInput.selectionStart = cursorPos + emoji.length;
                      messageInput.selectionEnd = cursorPos + emoji.length;
                      messageInput.focus();
                      
                      // ÌîºÏª§ Îã´Í∏∞
                      picker.style.display = 'none';
                    }
                  });
                }
              );
            } else {
              alert('Î™®ÎÑ§ÎùºÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî! / ¬°No tienes suficiente Monera!');
            }
          } else {
            // Î¨¥Î£å Ïù¥Î™®ÏßÄ
            // Ïª§ÏÑú ÏúÑÏπòÏóê Ïù¥Î™®ÏßÄ ÏÇΩÏûÖ
            messageInput.value = textBefore + emoji + textAfter;
            
            // Ïª§ÏÑú ÏúÑÏπòÎ•º Ïù¥Î™®ÏßÄ Îí§Î°ú Ïù¥Îèô
            messageInput.selectionStart = cursorPos + emoji.length;
            messageInput.selectionEnd = cursorPos + emoji.length;
            messageInput.focus();
            
            // ÌîºÏª§ Îã´Í∏∞
            picker.style.display = 'none';
          }
        };
        grid.appendChild(btn);
      });
      
      picker.appendChild(grid);
    }

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = sendVoiceMessage;
      mediaRecorder.start();
      document.querySelector('button[onclick="startRecording()"]').disabled = true;
      document.querySelector('button[onclick="stopRecording()"]').disabled = false;
    }

    function stopRecording() {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      document.querySelector('button[onclick="startRecording()"]').disabled = false;
      document.querySelector('button[onclick="stopRecording()"]').disabled = true;
    }

    async function sendVoiceMessage() {
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      const formData = new FormData();
      formData.append('voice', audioBlob, 'voice.wav');
      formData.append('roomId', currentRoom);
      formData.append('from', myId);
      
      try {
        const res = await fetch('/upload/voice', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const data = await res.json();
        if (data.success) {
          // ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°Îêú ÏùåÏÑ± Î©îÏãúÏßÄÎ•º DOMÏóê Ï¶âÏãú Ï∂îÍ∞Ä
          if (data.message) {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            let allUsers = null;
            try {
              const resUsers = await fetch('/all-users', {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              allUsers = await resUsers.json();
            } catch (error) {
              console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
              // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
            }
            
            await appendSingleMessageToDOM(data.message, allUsers, 'append');
            
            // Ï±ÑÌåÖÏ∞ΩÏùÑ Îß® ÏïÑÎûòÎ°ú Ïä§ÌÅ¨Î°§
            const chat = document.getElementById('chat-messages');
            chat.scrollTop = chat.scrollHeight;
            
            // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏ (Ìè¥ÎßÅÏù¥ Ïò¨Î∞îÎ•¥Í≤å ÎèôÏûëÌïòÎèÑÎ°ù)
            if (data.message.timestamp) {
              latestMessageTimestamps[currentRoom] = data.message.timestamp;
            }
          }
        } else {
          alert(data.message || 'ÏùåÏÑ± Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå® / Error al enviar mensaje de voz');
        }
      } catch (error) {
        console.error('ÏùåÏÑ± Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
        alert('ÏùåÏÑ± Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥ÏßÄ Î™ªÌñàÏñ¥Ïöî. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. / No se pudo enviar el mensaje de voz. Por favor, verifica el estado del servidor.');
      }
    }

    async function startAllRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = sendAllVoiceMessage;
      mediaRecorder.start();
      document.querySelector('button[onclick="startAllRecording()"]').disabled = true;
      document.querySelector('button[onclick="stopAllRecording()"]').disabled = false;
    }

    function stopAllRecording() {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      document.querySelector('button[onclick="startAllRecording()"]').disabled = false;
      document.querySelector('button[onclick="stopAllRecording()"]').disabled = true;
    }

    async function sendAllVoiceMessage() {
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      const formData = new FormData();
      formData.append('voice', audioBlob, 'voice.wav');
      formData.append('roomId', 'all-chat');
      formData.append('from', myId);
      
      try {
        const res = await fetch('/upload/voice', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const data = await res.json();
        if (data.success) {
          // ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°Îêú ÏùåÏÑ± Î©îÏãúÏßÄÎ•º DOMÏóê Ï¶âÏãú Ï∂îÍ∞Ä
          if (data.message) {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            let allUsers = null;
            try {
              const resUsers = await fetch('/all-users', {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              allUsers = await resUsers.json();
            } catch (error) {
              console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
              // Í≥ÑÏÜç ÏßÑÌñâ (Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨Ïö©)
            }
            
            await appendSingleAllMessage(data.message, allUsers);
            
            // Ï±ÑÌåÖÏ∞ΩÏùÑ Îß® ÏïÑÎûòÎ°ú Ïä§ÌÅ¨Î°§
            const chat = document.getElementById('all-chat-messages');
            chat.scrollTop = chat.scrollHeight;
            
            // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏ (Ìè¥ÎßÅÏù¥ Ïò¨Î∞îÎ•¥Í≤å ÎèôÏûëÌïòÎèÑÎ°ù)
            if (data.message.timestamp) {
              latestAllChatMessageTimestamp = data.message.timestamp;
            }
          }
        } else {
          alert(data.message || 'ÏùåÏÑ± Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå® / Error al enviar mensaje de voz');
        }
      } catch (error) {
        console.error('Ï†ÑÏ≤¥ ÏùåÏÑ± Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
        alert('ÏùåÏÑ± Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥ÏßÄ Î™ªÌñàÏñ¥Ïöî. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. / No se pudo enviar el mensaje de voz. Por favor, verifica el estado del servidor.');
      }
    }

    async function clearRoom() {
      if (!currentRoom || !confirm('ÎåÄÌôî Í∏∞Î°ùÏùÑ ÏßÄÏö∏ÍπåÏöî? / ¬øBorrar historial de chat?')) return;
      
      try {
        // Ìè¥ÎßÅ ÏùºÏãú Ï§ëÏßÄ
        if (pollingInterval) clearInterval(pollingInterval);
        
        const res = await fetch(`/chat/delete/${currentRoom}/${myId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®: ${res.status}`);
        }
        
        const data = await res.json();
        
        if (data.success) {
          // Ï±ÑÌåÖÏ∞Ω Ï¶âÏãú ÎπÑÏö∞Í∏∞
          document.getElementById('chat-messages').innerHTML = '';
          
          // ÏÇ≠Ï†ú ÏãúÏ†ê ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï†ÄÏû• - ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Î∞õÏùÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏÇ¨Ïö©
          if (data.timestamp) {
            console.log(`Ï±ÑÌåÖ ÏÇ≠Ï†ú ÏãúÏ†ê Ï†ÄÏû•: ${data.timestamp}`);
            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏÇ≠Ï†ú ÏãúÏ†ê Ï†ÄÏû•
            const deletedRooms = JSON.parse(localStorage.getItem('deletedRooms') || '{}');
            deletedRooms[`${currentRoom}_${myId}`] = data.timestamp;
            localStorage.setItem('deletedRooms', JSON.stringify(deletedRooms));
          }
          
          // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Î¶¨ÏÖã
          latestMessageTimestamps[currentRoom] = null;
          oldestMessageTimestamps[currentRoom] = null;
          
          // ÌëúÏãúÎêú Î©îÏãúÏßÄ ID ÏÑ∏Ìä∏ Ï¥àÍ∏∞Ìôî
          if (displayedMessageIds[currentRoom]) {
            displayedMessageIds[currentRoom] = new Set();
          }
          
          // Ï¥àÍ∏∞ Î©îÏãúÏßÄ Î°úÎìú
          await loadInitialChatHistory(currentRoom);
          
          // Ìè¥ÎßÅ Ïû¨ÏãúÏûë
          pollingInterval = setInterval(() => {
            if (!isPollingPaused) pollNewMessages();
          }, 2000);
          
          console.log('ÎåÄÌôî ÏßÄÏö∞Í∏∞ ÏÑ±Í≥µ Î∞è Ï±ÑÌåÖ ÌôîÎ©¥ Í∞±Ïã† ÏôÑÎ£å');
        } else {
          alert(data.message || 'ÎåÄÌôî ÏßÄÏö∞Í∏∞ Ïã§Ìå® / No se pudo borrar el chat');
          
          // Ìè¥ÎßÅ Ïû¨ÏãúÏûë
          pollingInterval = setInterval(() => {
            if (!isPollingPaused) pollNewMessages();
          }, 2000);
        }
      } catch (error) {
        console.error('ÎåÄÌôî ÏßÄÏö∞Í∏∞ Ïã§Ìå®:', error);
        alert('ÎåÄÌôî ÏßÄÏö∞Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§ / Ocurri√≥ un error al borrar el chat');
        
        // Ìè¥ÎßÅ Ïû¨ÏãúÏûë
        pollingInterval = setInterval(() => {
          if (!isPollingPaused) pollNewMessages();
        }, 2000);
      }
    }

    function showTab(tabName) {
      const tabs = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabs.length; i++) tabs[i].style.display = 'none';
      document.getElementById(tabName).style.display = 'block';
      if (tabName === 'chat') {
        document.getElementById('room-list').style.display = 'block';
        document.getElementById('chat-room').style.display = 'none';
        updateRoomList();
        if (pollingInterval) clearInterval(pollingInterval);
      } else if (tabName === 'friends') {
        updateFriendsList();
      } else if (tabName === 'users') {
        updateUserList();
      } else if (tabName === 'all-chat') {
        loadAllChat();
        if (allChatInterval) clearInterval(allChatInterval);
        allChatInterval = setInterval(loadAllChat, 2000);
      } else if (tabName === 'settings') {
        // Hide all settings submenu divs
        document.querySelectorAll('.settings-sub').forEach(el => {
          el.style.display = 'none';
        });
        
        // Show the main settings content
        document.getElementById('settings-content').style.display = 'block';
        getMyMonera();
        updateSettingsProfile();
      }
    }

    function backToRooms() {
      document.getElementById('chat-room').style.display = 'none';
      document.getElementById('room-list').style.display = 'block';
      currentRoom = null;
      if (pollingInterval) clearInterval(pollingInterval);
      updateRoomList();
    }

    function showSettingsSubmenu(submenu) {
      // Hide all settings submenu divs
      document.querySelectorAll('.settings-sub').forEach(el => {
        el.style.display = 'none';
      });
      
      // Hide main settings content
      document.getElementById('settings-content').style.display = 'none';
      
      // Show the requested submenu
      if (submenu === 'profile') {
        document.getElementById('settings-profile-sub').style.display = 'block';
      } else {
        document.getElementById(`settings-${submenu}`).style.display = 'block';
      }
    }
    
    function backToSettings() {
      // Hide all settings submenu divs
      document.querySelectorAll('.settings-sub').forEach(el => {
        el.style.display = 'none';
      });
      
      // Show the main settings content
      document.getElementById('settings-content').style.display = 'block';
      getMyMonera();
      updateSettingsProfile();
    }

    function toggleSound() {
      soundEnabled = document.getElementById('sound-toggle').checked;
      localStorage.setItem('soundEnabled', soundEnabled);
      alert(`ÏÜåÎ¶¨Í∞Ä ${soundEnabled ? 'ÏºúÏ°åÏñ¥Ïöî / Sonido activado' : 'Í∫ºÏ°åÏñ¥Ïöî / Sonido desactivado'}`);
    }

    function loadSound() {
      const sound = localStorage.getItem('notificationSound') || 'default';
      const audio = document.getElementById('notification');
      
      // ÏÜåÎ¶¨ URL ÏÑ§Ï†ï
      if (sound === 'default') {
        audio.src = 'https://cdn.pixabay.com/audio/2024/11/29/audio_0b4f12f995.mp3';
      } else if (sound === 'bell') {
        audio.src = 'https://www.myinstants.com/media/sounds/bell.mp3';
      } else if (sound === 'ping') {
        audio.src = 'https://cdn.pixabay.com/audio/2024/11/29/audio_538916a9ed.mp3';
      }
      
      // ÏÜåÎ¶¨ ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î°úÎìú
      const soundEnabledStr = localStorage.getItem('soundEnabled');
      if (soundEnabledStr !== null) {
        soundEnabled = soundEnabledStr === 'true';
      }
      
      // Sound toggle checkbox ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      const soundToggle = document.getElementById('sound-toggle');
      if (soundToggle) {
        soundToggle.checked = soundEnabled;
      }
    }

    function setSound(type) {
      localStorage.setItem('notificationSound', type);
      loadSound();
      
      // ÏÜåÎ¶¨ ÎØ∏Î¶¨Îì£Í∏∞
      const audio = document.getElementById('notification');
      if (soundEnabled) {
        audio.play().catch(err => console.log('ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù Ïã§Ìå®:', err));
      }
      
      alert(`ÏïåÎ¶ºÏùåÏù¥ ${type}ÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏñ¥Ïöî! / ¬°Sonido de notificaci√≥n cambiado a ${type}!`);
    }

    function previewSound(type) {
      const audio = document.getElementById('notification');
      if (type === 'soft') audio.src = 'https://cdn.pixabay.com/audio/2024/11/29/audio_0b4f12f995.mp3';
      else if (type === 'bell') audio.src = 'https://www.myinstants.com/media/sounds/bell.mp3';
      else if (type === 'chime') audio.src = 'https://cdn.pixabay.com/audio/2024/11/29/audio_538916a9ed.mp3';
      audio.play();
    }

    // RGB Í∞íÏùÑ HEX Í∞íÏúºÎ°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
    function RGB2HEX(rgb) {
      if (!rgb) return '';
      if (rgb.startsWith('#')) return rgb;
      
      rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
      if (!rgb) return '';
      
      function hex(x) {
        return ("0" + parseInt(x).toString(16)).slice(-2);
      }
      return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
    }

    function setMessageColor(color, isPremium) {
      if (isPremium) {
        if (userMonera < 5) {
          alert('Î™®ÎÑ§ÎùºÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî! / ¬°No tienes suficiente Monera!');
          return;
        }
        
        showConfirmDialog(
          `Î™®ÎÑ§Îùº 5Í∞úÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏÉâÏÉÅÏùÑ Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå? / ¬øQuieres usar 5 Monera para cambiar el color?`,
          () => {
            spendMonera(5).then(success => {
              if (success) {
                // ÏÉâÏÉÅ ÏßÅÏ†ë ÏÑ§Ï†ï
                selectedColor = color;
                
                // ÏûÖÎ†•Ï∞ΩÏóê ÏßÅÏ†ë ÏÉâÏÉÅ Ï†ÅÏö©
                const messageInput = document.getElementById('message');
                messageInput.style.color = color;
                
                // Î≤ÑÌäº ÏÑ†ÌÉù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                const colorButtons = document.querySelectorAll('#chat .color-btn');
                colorButtons.forEach(btn => {
                  btn.classList.remove('selected');
                });
                
                // ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
                const selectedButton = Array.from(colorButtons).find(btn => {
                  return btn.style.backgroundColor.toLowerCase() === color.toLowerCase() || 
                         btn.style.backgroundColor === color ||
                         RGB2HEX(btn.style.backgroundColor) === color;
                });
                
                if (selectedButton) {
                  selectedButton.classList.add('selected');
                }
                
                // ÎØ∏Î¶¨Î≥¥Í∏∞ Ïà®Í∏∞Í∏∞
                document.getElementById('message-preview').style.display = 'none';
              }
            });
          }
        );
      } else {
        // ÏÉâÏÉÅ ÏßÅÏ†ë ÏÑ§Ï†ï
        selectedColor = color;
        
        // ÏûÖÎ†•Ï∞ΩÏóê ÏßÅÏ†ë ÏÉâÏÉÅ Ï†ÅÏö©
        const messageInput = document.getElementById('message');
        messageInput.style.color = color;
        
        // Î≤ÑÌäº ÏÑ†ÌÉù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        const colorButtons = document.querySelectorAll('#chat .color-btn');
        colorButtons.forEach(btn => {
          btn.classList.remove('selected');
        });
        
        // ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
        const selectedButton = Array.from(colorButtons).find(btn => {
          return btn.style.backgroundColor.toLowerCase() === color.toLowerCase() || 
                 btn.style.backgroundColor === color ||
                 RGB2HEX(btn.style.backgroundColor) === color;
        });
        
        if (selectedButton) {
          selectedButton.classList.add('selected');
        }
        
        // ÎØ∏Î¶¨Î≥¥Í∏∞ Ïà®Í∏∞Í∏∞
        document.getElementById('message-preview').style.display = 'none';
      }
    }
    
    function updateEmojiGrid(picker) {
      // Í∏∞Ï°¥ Í∑∏Î¶¨Îìú Ï†úÍ±∞
      const existingGrid = picker.querySelector('.emoji-grid');
      if (existingGrid) {
        picker.removeChild(existingGrid);
      }
      
      const grid = document.createElement('div');
      grid.className = 'emoji-grid';
      
      emojiCategories[selectedCategory].forEach((emoji, index) => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn' + (selectedCategory !== 'basic' && index >= 8 ? ' premium-item' : '');
        btn.innerText = emoji;
        btn.onclick = () => {
          const messageInput = document.getElementById('message');
          const cursorPos = messageInput.selectionStart;
          const textBefore = messageInput.value.substring(0, cursorPos);
          const textAfter = messageInput.value.substring(cursorPos);
          
          if (selectedCategory !== 'basic' && index >= 8) {
            // ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïù¥Î™®ÏßÄ
            if (userMonera >= 5) {
              showConfirmDialog(
                `Î™®ÎÑ§Îùº 5Í∞úÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ïù¥Î™®ÏßÄÎ•º ÏÇ¨Ïö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå? / ¬øQuieres usar 5 Monera para usar este emoji?`,
                () => {
                  spendMonera(5).then(success => {
                    if (success) {
                      // Ïª§ÏÑú ÏúÑÏπòÏóê Ïù¥Î™®ÏßÄ ÏÇΩÏûÖ
                      messageInput.value = textBefore + emoji + textAfter;
                      
                      // Ïª§ÏÑú ÏúÑÏπòÎ•º Ïù¥Î™®ÏßÄ Îí§Î°ú Ïù¥Îèô
                      messageInput.selectionStart = cursorPos + emoji.length;
                      messageInput.selectionEnd = cursorPos + emoji.length;
                      messageInput.focus();
                      
                      // ÌîºÏª§ Îã´Í∏∞
                      picker.style.display = 'none';
                    }
                  });
                }
              );
            } else {
              alert('Î™®ÎÑ§ÎùºÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî! / ¬°No tienes suficiente Monera!');
            }
          } else {
            // Î¨¥Î£å Ïù¥Î™®ÏßÄ
            // Ïª§ÏÑú ÏúÑÏπòÏóê Ïù¥Î™®ÏßÄ ÏÇΩÏûÖ
            messageInput.value = textBefore + emoji + textAfter;
            
            // Ïª§ÏÑú ÏúÑÏπòÎ•º Ïù¥Î™®ÏßÄ Îí§Î°ú Ïù¥Îèô
            messageInput.selectionStart = cursorPos + emoji.length;
            messageInput.selectionEnd = cursorPos + emoji.length;
            messageInput.focus();
            
            // ÌîºÏª§ Îã´Í∏∞
            picker.style.display = 'none';
          }
        };
        grid.appendChild(btn);
      });
      
      picker.appendChild(grid);
    }
    
    function updateMessagePreview() {
      // ÎØ∏Î¶¨Î≥¥Í∏∞ Í∏∞Îä•ÏùÑ ÎπÑÌôúÏÑ±ÌôîÌïòÏó¨ ÏûÖÎ†•Ï∞ΩÏóê ÏßÅÏ†ë ÏÉâÏÉÅÏù¥ Ï†ÅÏö©ÎêòÎèÑÎ°ù Ìï®
      document.getElementById('message-preview').style.display = 'none';
    }

    function setAllMessageColor(color, isPremium) {
      if (isPremium && userMonera < 5) {
        alert('Î™®ÎÑ§ÎùºÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî! / ¬°No tienes suficiente Monera!');
        return;
      }
      
      if (isPremium) {
        showConfirmDialog(
          `Î™®ÎÑ§Îùº 5Í∞úÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏÉâÏÉÅÏùÑ Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå? / ¬øQuieres usar 5 Monera para cambiar el color?`,
          () => {
            spendMonera(5).then(success => {
              if (success) {
                applyAllMessageColor(color);
              }
            });
          }
        );
      } else {
        applyAllMessageColor(color);
      }
    }
    
    function applyAllMessageColor(color) {
      allSelectedColor = color;
      
      // Update all-message input color directly
      const allMessageInput = document.getElementById('all-message');
      allMessageInput.style.color = color;
      
      // Update button selection
      const colorButtons = document.querySelectorAll('#all-chat .color-btn');
      colorButtons.forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
      const selectedButton = Array.from(colorButtons).find(btn => {
        return btn.style.backgroundColor.toLowerCase() === color.toLowerCase() || 
               btn.style.backgroundColor === color ||
               RGB2HEX(btn.style.backgroundColor) === color;
      });
      
      if (selectedButton) {
        selectedButton.classList.add('selected');
      }
      
      // ÎØ∏Î¶¨Î≥¥Í∏∞ Ïà®Í∏∞Í∏∞
      document.getElementById('all-message-preview').style.display = 'none';
    }
    
    function updateAllMessagePreview() {
      // ÎØ∏Î¶¨Î≥¥Í∏∞ Í∏∞Îä•ÏùÑ ÎπÑÌôúÏÑ±ÌôîÌïòÏó¨ ÏûÖÎ†•Ï∞ΩÏóê ÏßÅÏ†ë ÏÉâÏÉÅÏù¥ Ï†ÅÏö©ÎêòÎèÑÎ°ù Ìï®
      document.getElementById('all-message-preview').style.display = 'none';
    }

    async function getMyMonera() {
      const res = await fetch(`/monera/${myId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success) {
        userMonera = data.monera;
        // monera-count ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏ ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏
        const moneraCountElement = document.getElementById('monera-count');
        if (moneraCountElement) {
          moneraCountElement.innerText = userMonera;
        }
      }
    }

    async function earnMonera(amount) {
      try {
        const res = await fetch('/monera/earn', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId: myId, amount })
        });
        const data = await res.json();
        if (data.success) {
          userMonera += amount;
          // monera-count ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏ ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏
          const moneraCountElement = document.getElementById('monera-count');
          if (moneraCountElement) {
            moneraCountElement.innerText = userMonera;
          }
        }
      } catch (error) {
        console.error('Î™®ÎÑ§Îùº ÌöçÎìù Ï§ë Ïò§Î•ò:', error);
      }
    }

    async function spendMonera(amount) {
      try {
        const res = await fetch('/monera/spend', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId: myId, amount })
        });
        const data = await res.json();
        if (data.success) {
          userMonera -= amount;
          // monera-count ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏ ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏
          const moneraCountElement = document.getElementById('monera-count');
          if (moneraCountElement) {
            moneraCountElement.innerText = userMonera;
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('Î™®ÎÑ§Îùº ÏÇ¨Ïö© Ï§ë Ïò§Î•ò:', error);
        return false;
      }
    }

    async function transferMonera(toUserId, amount) {
      try {
        const res = await fetch('/monera/transfer', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ fromUserId: myId, toUserId, amount })
        });
        const data = await res.json();
        if (data.success) {
          userMonera -= amount;
          // monera-count ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏ ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏
          const moneraCountElement = document.getElementById('monera-count');
          if (moneraCountElement) {
            moneraCountElement.innerText = userMonera;
          }
          alert(`${amount} Î™®ÎÑ§ÎùºÎ•º ${toUserId}ÏóêÍ≤å Î≥¥ÎÉàÏäµÎãàÎã§! / ¬°Has enviado ${amount} Monera a ${toUserId}!`);
          return true;
        } else {
          alert(data.message || 'Î™®ÎÑ§Îùº Ï†ÑÏÜ° Ïã§Ìå® / Error al enviar Monera');
          return false;
        }
      } catch (error) {
        console.error('Î™®ÎÑ§Îùº Ï†ÑÏÜ° Ï§ë Ïò§Î•ò:', error);
        alert('Î™®ÎÑ§ÎùºÎ•º Î≥¥ÎÇ¥ÏßÄ Î™ªÌñàÏñ¥Ïöî. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. / No se pudo enviar Monera. Por favor, verifica el estado del servidor.');
        return false;
      }
    }

    function verifyAdminPassword() {
      const adminPassword = document.getElementById('admin-password').value;
      if (!adminPassword) {
        alert('Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî / Por favor, ingrese la contrase√±a de administrador');
        return;
      }
      
      // ÏßÅÏ†ë ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ (ÏÑúÎ≤Ñ API ÎåÄÏã†)
      if (adminPassword === '1210') {
        document.getElementById('admin-panel').style.display = 'block';
        showNotification('Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù ÏÑ±Í≥µ / Autenticaci√≥n de administrador exitosa');
        // Î™®ÎÑ§Îùº Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
        loadAllUsersMonera();
      } else {
        alert('Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§ / Contrase√±a de administrador incorrecta');
      }
    }
    
    async function loadAllUsersMonera() {
      try {
        const res = await fetch('/all-users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await res.json();
        
        const usersListDiv = document.getElementById('all-users-monera');
        usersListDiv.innerHTML = '';
        
        // Í∞Å ÏÇ¨Ïö©ÏûêÏùò Î™®ÎÑ§Îùº Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¥
        for (const user of users) {
          const moneraRes = await fetch(`/monera/${user.userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const moneraData = await moneraRes.json();
          const moneraAmount = moneraData.success ? moneraData.monera : 0;
          
          const userDiv = document.createElement('div');
          userDiv.className = 'user-monera-item';
          userDiv.innerHTML = `
            <span class="user-id">${user.userId}</span>
            <span class="user-monera">Î™®ÎÑ§Îùº: ${moneraAmount} / Monera: ${moneraAmount}</span>
          `;
          usersListDiv.appendChild(userDiv);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('ÏÇ¨Ïö©Ïûê Î™®ÎÑ§Îùº Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§ / Error al cargar la informaci√≥n de Monera del usuario');
      }
    }
    
    async function adminAddMonera() {
      const adminPassword = document.getElementById('admin-password').value;
      const userId = document.getElementById('admin-user-id').value;
      const amount = parseInt(document.getElementById('admin-monera-amount').value);
      
      if (!adminPassword || !userId || isNaN(amount)) {
        alert('Î™®Îì† ÌïÑÎìúÎ•º Ï±ÑÏõåÏ£ºÏÑ∏Ïöî / Por favor, rellene todos los campos');
        return;
      }
      
      if (adminPassword !== '1210') {
        alert('Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§ / Contrase√±a de administrador incorrecta');
        return;
      }
      
      try {
        const res = await fetch('/monera/admin/add', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId, amount })
        });
        
        const data = await res.json();
        if (data.success) {
          showNotification(`${userId}ÎãòÏóêÍ≤å ${amount} Î™®ÎÑ§ÎùºÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§! / ¬°Se han a√±adido ${amount} Monera a ${userId}!`);
          // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
          loadAllUsersMonera();
        } else {
          alert(data.message || 'Î™®ÎÑ§Îùº Ï∂îÍ∞Ä Ïã§Ìå® / Error al a√±adir Monera');
        }
      } catch (error) {
        console.error('Î™®ÎÑ§Îùº Ï∂îÍ∞Ä Ï§ë Ïò§Î•ò:', error);
        alert('Î™®ÎÑ§ÎùºÎ•º Ï∂îÍ∞ÄÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî. / No se pudo a√±adir Monera. Por favor, verifica el estado del servidor.');
      }
    }
    
    function setTheme(theme) {
      document.body.className = '';  // Í∏∞Ï°¥ ÌÅ¥ÎûòÏä§ Î™®Îëê Ï†úÍ±∞
      document.body.classList.add(`theme-${theme}`);
      localStorage.setItem('theme', theme);
      showNotification(`ÌÖåÎßàÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§: ${theme} / Tema cambiado: ${theme}`);
    }

    // Helper functions for UI
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    function showConfirmDialog(message, onConfirm) {
      // Remove any existing modal
      const existingModal = document.querySelector('.modal-overlay');
      if (existingModal) {
        document.body.removeChild(existingModal);
      }
      
      // Create modal elements
      const modalOverlay = document.createElement('div');
      modalOverlay.className = 'modal-overlay';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      
      const messageElement = document.createElement('p');
      messageElement.textContent = message;
      
      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'modal-buttons';
      
      const confirmButton = document.createElement('button');
      confirmButton.className = 'confirm-btn';
      confirmButton.textContent = 'ÌôïÏù∏ / Confirmar';
      confirmButton.onclick = () => {
        document.body.removeChild(modalOverlay);
        onConfirm();
      };
      
      const cancelButton = document.createElement('button');
      cancelButton.className = 'cancel-btn';
      cancelButton.textContent = 'Ï∑®ÏÜå / Cancelar';
      cancelButton.onclick = () => {
        document.body.removeChild(modalOverlay);
      };
      
      // Assemble modal
      buttonsContainer.appendChild(confirmButton);
      buttonsContainer.appendChild(cancelButton);
      modalContent.appendChild(messageElement);
      modalContent.appendChild(buttonsContainer);
      modalOverlay.appendChild(modalContent);
      
      // Show modal
      document.body.appendChild(modalOverlay);
    }

    async function openAllChat() {
      currentRoom = null;
      const tabs = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabs.length; i++) tabs[i].style.display = 'none';
      document.getElementById('all-chat').style.display = 'block';
      document.getElementById('all-chat-messages').innerHTML = '';
      
      // Ï†ÑÏ≤¥ Ï±ÑÌåÖ Ï†ÑÌôò Ïãú ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÏôÄ Î©îÏãúÏßÄ Ï∂îÏ†Å ÏÑ∏Ìä∏ Î¶¨ÏÖã
      latestAllChatMessageTimestamp = null;
      
      // Ï±ÑÌåÖÎ∞©ÏùÑ Îã§Ïãú Ïó¥ Îïå Ï∂îÏ†Å ÏÑ∏Ìä∏ Ï¥àÍ∏∞Ìôî (Ï§ëÎ≥µ Î©îÏãúÏßÄ Î∞©ÏßÄ ÏúÑÌï¥)
      if (displayedMessageIds['all-chat']) {
        displayedMessageIds['all-chat'] = new Set();
      }
      
      loadAllChat();
      if (allChatInterval) clearInterval(allChatInterval);
      allChatInterval = setInterval(loadAllChat, 2000);
    }

    async function loadAllChat() {
      try {
        // ÎßàÏßÄÎßâ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÌôïÏù∏
        const latestTimestamp = latestAllChatMessageTimestamp;
        
        // Ïä§ÌÅ¨Î°§ ÏúÑÏπò ÌôïÏù∏ (ÏÉà Î©îÏãúÏßÄÍ∞Ä Ïò§Î©¥ ÏûêÎèô Ïä§ÌÅ¨Î°§ Ïó¨Î∂Ä Í≤∞Ï†ï)
        const chat = document.getElementById('all-chat-messages');
        const wasScrolledToBottom = chat.scrollHeight - chat.scrollTop <= chat.clientHeight + 100;
        
        // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Í∏∞Î∞ò URL Íµ¨ÏÑ±
        let url = '/all-chat';
        if (latestTimestamp) {
          url += `?since=${encodeURIComponent(latestTimestamp)}`;
        }
        
        const resMessages = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const newMessages = await resMessages.json();
        
        // ÏÉà Î©îÏãúÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Îçî Ïù¥ÏÉÅ Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå
        if (!newMessages || newMessages.length === 0) return;
        
        const resUsers = await fetch('/all-users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const allUsers = await resUsers.json();
        
        // Ï†ÑÏ≤¥ Ï±ÑÌåÖÏóêÏÑúÎäî Î™®ÎÑ§ÎùºÎ•º Ï†ÅÎ¶ΩÌïòÏßÄ ÏïäÏùå
        // ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù (ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄÍ∞Ä ÏûàÏùÑ ÎïåÎßå)
        if (newMessages.length > 0) {
          const lastMessage = newMessages[newMessages.length - 1];
          const lastMessageId = lastMessage.id || `${lastMessage.timestamp}-${lastMessage.from}`;
          
          // ÎßàÏßÄÎßâ Î©îÏãúÏßÄÍ∞Ä ÎÇ¥Í∞Ä Î≥¥ÎÇ∏ Í≤ÉÏù¥ ÏïÑÎãàÍ≥†, Ïù¥Ï†ÑÏóê ÏïåÎ¶ºÏùÑ Ïû¨ÏÉùÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞Îßå ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù
          if (lastMessage.from !== myId && lastNotifiedMessageIds['all-chat'] !== lastMessageId) {
            // ÎßàÏßÄÎßâ ÏïåÎ¶º Î©îÏãúÏßÄ ID ÏóÖÎç∞Ïù¥Ìä∏
            lastNotifiedMessageIds['all-chat'] = lastMessageId;
            
            // ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù
            if (soundEnabled) {
              const audio = document.getElementById('notification');
              if (audio) {
                audio.play().catch(err => console.log('ÏïåÎ¶º ÏÜåÎ¶¨ Ïû¨ÏÉù Ïã§Ìå® / Error al reproducir sonido:', err));
              }
            }
          }
        }
        
        // ÏÉà Î©îÏãúÏßÄÎì§ÏùÑ DOMÏóê Ï∂îÍ∞Ä
        for (const data of newMessages) {
          await appendSingleAllMessage(data, allUsers);
        }
        
        // ÎßàÏßÄÎßâ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
        if (newMessages.length > 0) {
          const lastMessage = newMessages[newMessages.length - 1];
          latestAllChatMessageTimestamp = lastMessage.timestamp;
        }
        
        // Ïò§ÏßÅ Ïù¥Ï†ÑÏóê Ïä§ÌÅ¨Î°§Ïù¥ Îß® ÏïÑÎûòÏóê ÏûàÏóàÏùÑ ÎïåÎßå Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô
        if (wasScrolledToBottom) {
          chat.scrollTop = chat.scrollHeight;
        }
      } catch (error) {
        console.error('Ï†ÑÏ≤¥ Ï±ÑÌåÖ Î°úÎìú Ïã§Ìå®:', error);
      }
    }

    // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú appendSingleMessage Ìï®Ïàò
    async function appendSingleMessage(messageData) {
      const chat = document.getElementById('chat-messages');
      // Î©îÏãúÏßÄ Ï∂îÍ∞Ä Ï†Ñ Ïä§ÌÅ¨Î°§ ÏúÑÏπò ÌôïÏù∏ (ÏûêÎèô Ïä§ÌÅ¨Î°§ Ïó¨Î∂Ä Í≤∞Ï†ï ÏúÑÌï®)
      const wasScrolledToBottom = chat.scrollHeight - chat.scrollTop <= chat.clientHeight + 100;

      // ÌòÑÏû¨ Ï±ÑÌåÖÎ∞©Ïùò displayedMessageIds Í∞ùÏ≤¥ Ï¥àÍ∏∞Ìôî (ÏóÜÎäî Í≤ΩÏö∞)
      if (!displayedMessageIds[currentRoom]) {
        displayedMessageIds[currentRoom] = new Set();
      }
      
      // Î©îÏãúÏßÄ ID ÏÉùÏÑ± Î∞è Ï§ëÎ≥µ ÌôïÏù∏
      const messageId = messageData.id || `${messageData.timestamp}-${messageData.from}`;
      
      // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÏù∏ÏßÄ ÌôïÏù∏
      if (displayedMessageIds[currentRoom].has(messageId)) {
        console.log('Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄ Ï§ëÎ≥µ Î∞©ÏßÄ:', messageId);
        return; // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÎäî Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
      }
      
      // Î©îÏãúÏßÄ IDÎ•º Ï∂îÏ†Å ÏÑ∏Ìä∏Ïóê Ï∂îÍ∞Ä
      displayedMessageIds[currentRoom].add(messageId);

      // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      let profilePic = '/uploads/default-profile.png';
      try {
        const resUsers = await fetch('/all-users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const allUsers = await resUsers.json();
        const user = allUsers.find(u => u.userId === messageData.from);
        if (user && user.profilePic) {
          profilePic = user.profilePic;
        }
      } catch (error) {
        console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
        // Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏÇ¨Ïö©
        profilePic = messageData.from === myId ? userProfilePic : '/uploads/default-profile.png';
      }

      const p = document.createElement('p');
      p.className = 'message';
      const timestamp = new Date(messageData.timestamp).toLocaleString('ko-KR');
      const messageColor = messageData.color || 'black';

      // loadChatHistoryÏùò Î©îÏãúÏßÄ Ìè¨Îß∑ÌåÖ Î°úÏßÅ Ïû¨ÏÇ¨Ïö©
      if (messageData.type === 'text') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <span style="color: ${messageColor}">${messageData.message.replace(/\n/g, '<br>')}</span> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'image') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <img src="${messageData.message}" class="message-media"> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'video') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <video src="${messageData.message}" controls class="message-media"></video> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'voice') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <audio src="${messageData.message}" controls onplay="pausePolling()" onended="resumePolling()"></audio> <span class="timestamp">${timestamp}</span>`;
      }

      chat.appendChild(p);

      // Ïù¥Ï†ÑÏóê Ïä§ÌÅ¨Î°§Ïù¥ Îß® ÏïÑÎûòÏóê ÏûàÏóàÎã§Î©¥ Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô
      if (wasScrolledToBottom) {
        chat.scrollTop = chat.scrollHeight;
      }
    }

    // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú appendSingleAllMessage Ìï®Ïàò
    async function appendSingleAllMessage(messageData, allUsers) {
      const chat = document.getElementById('all-chat-messages');
      
      // Ï†ÑÏ≤¥ Ï±ÑÌåÖÏùò displayedMessageIds Í∞ùÏ≤¥ Ï¥àÍ∏∞Ìôî (ÏóÜÎäî Í≤ΩÏö∞)
      if (!displayedMessageIds['all-chat']) {
        displayedMessageIds['all-chat'] = new Set();
      }
      
      // Î©îÏãúÏßÄ ID ÏÉùÏÑ± Î∞è Ï§ëÎ≥µ ÌôïÏù∏
      const messageId = messageData.id || `${messageData.timestamp}-${messageData.from}`;
      
      // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÏù∏ÏßÄ ÌôïÏù∏
      if (displayedMessageIds['all-chat'].has(messageId)) {
        console.log('Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄ Ï§ëÎ≥µ Î∞©ÏßÄ (Ï†ÑÏ≤¥ Ï±ÑÌåÖ):', messageId);
        return; // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÎäî Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
      }
      
      // Î©îÏãúÏßÄ IDÎ•º Ï∂îÏ†Å ÏÑ∏Ìä∏Ïóê Ï∂îÍ∞Ä
      displayedMessageIds['all-chat'].add(messageId);
      
      // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      let profilePic = '/uploads/default-profile.png';
      if (allUsers) {
        const user = allUsers.find(u => u.userId === messageData.from);
        if (user && user.profilePic) {
          profilePic = user.profilePic;
        }
      } else {
        // Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏÇ¨Ïö©
        profilePic = messageData.from === myId ? userProfilePic : '/uploads/default-profile.png';
      }

      const p = document.createElement('p');
      p.className = 'message';
      const timestamp = new Date(messageData.timestamp).toLocaleString('ko-KR');
      const messageColor = messageData.color || 'black';

      // loadAllChatÏùò Î©îÏãúÏßÄ Ìè¨Îß∑ÌåÖ Î°úÏßÅ Ïû¨ÏÇ¨Ïö©
      if (messageData.type === 'text') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <span style="color: ${messageColor}">${messageData.message.replace(/\n/g, '<br>')}</span> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'image') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <img src="${messageData.message}" class="message-media"> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'video') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <video src="${messageData.message}" controls class="message-media"></video> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'voice') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <audio src="${messageData.message}" controls onplay="pausePolling()" onended="resumePolling()"></audio> <span class="timestamp">${timestamp}</span>`;
      }

      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    }

    // openChatRoom Ìï®Ïàò ÏàòÏ†ï
    async function openChatRoom(roomId) {
      // Ìè¥ÎßÅ Ï§ëÏßÄ
      if (pollingInterval) clearInterval(pollingInterval);
      if (allChatInterval) clearInterval(allChatInterval);
      
      // Ï±ÑÌåÖÎ∞© Î≥ÄÍ≤Ω Ïãú ÌôîÎ©¥ Ï†ÑÌôò
      document.getElementById('room-list').style.display = 'none';
      document.getElementById('chat-room').style.display = 'block';
      currentRoom = roomId;
      
      // Ï±ÑÌåÖÎ∞© Î≥ÄÍ≤Ω Ïãú Î©îÏãúÏßÄ Ï∂îÏ†Å ÏÑ∏Ìä∏ Ï¥àÍ∏∞Ìôî
      if (displayedMessageIds[roomId]) {
        // Ï±ÑÌåÖÎ∞©ÏùÑ Îã§Ïãú Ïó¥ Îïå Ï∂îÏ†Å ÏÑ∏Ìä∏ Ï¥àÍ∏∞Ìôî (Ï§ëÎ≥µ Î©îÏãúÏßÄ Î∞©ÏßÄ ÏúÑÌï¥)
        displayedMessageIds[roomId] = new Set();
      }
      
      // UI ÏóÖÎç∞Ïù¥Ìä∏
      document.getElementById('chat-room-id').innerText = roomId;
      
      // Ï¥àÍ∏∞ Ìè¥ÎßÅ ÏãúÏûë Ïãú timestamp ÏóÜÏùå (Ï†ÑÏ≤¥ Í∏∞Î°ù Î°úÎìú)
      latestMessageTimestamps[roomId] = null;
      oldestMessageTimestamps[roomId] = null;
      
      // Ï±ÑÌåÖ Î°úÎìú
      await loadInitialChatHistory(roomId);
      
      // Ìè¥ÎßÅ ÏãúÏûë
      pollingInterval = setInterval(() => {
        if (!isPollingPaused) pollNewMessages();
      }, 2000);
    }

    // Ìó¨Ìçº Ìï®Ïàò: Îã®Ïùº Î©îÏãúÏßÄÎ•º DOMÏóê Ï∂îÍ∞Ä
    // position ÌååÎùºÎØ∏ÌÑ∞: 'append' (Îß® ÏïÑÎûò Ï∂îÍ∞Ä) ÎòêÎäî 'prepend' (Îß® ÏúÑ Ï∂îÍ∞Ä)
    async function appendSingleMessageToDOM(messageData, allUsers, position = 'append') {
      if (!messageData || !currentRoom) return;
      
      const chat = document.getElementById('chat-messages');
      
      // Î©îÏãúÏßÄ ID ÏÉùÏÑ±
      const messageId = messageData.id || `${messageData.timestamp}-${messageData.from}`;
      
      // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÏù∏ÏßÄ ÌôïÏù∏
      if (document.querySelector(`.message[data-id="${messageId}"]`) || 
          (displayedMessageIds[currentRoom] && displayedMessageIds[currentRoom].has(messageId))) {
        return; // Ïù¥ÎØ∏ ÌëúÏãúÎêú Î©îÏãúÏßÄÎäî Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
      }
      
      // Î©îÏãúÏßÄ IDÎ•º Ï∂îÏ†Å ÏÑ∏Ìä∏Ïóê Ï∂îÍ∞Ä
      if (!displayedMessageIds[currentRoom]) {
        displayedMessageIds[currentRoom] = new Set();
      }
      displayedMessageIds[currentRoom].add(messageId);
      
      // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      let profilePic = '/uploads/default-profile.png';
      if (allUsers) {
        const user = allUsers.find(u => u.userId === messageData.from);
        if (user && user.profilePic) {
          profilePic = user.profilePic;
        }
      } else {
        // Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏÇ¨Ïö©
        profilePic = messageData.from === myId ? userProfilePic : '/uploads/default-profile.png';
      }
      
      // Î©îÏãúÏßÄ DOM ÏöîÏÜå ÏÉùÏÑ±
      const p = document.createElement('p');
      p.className = 'message';
      p.dataset.id = messageId; // Î©îÏãúÏßÄ IDÎ•º Îç∞Ïù¥ÌÑ∞ ÏÜçÏÑ±ÏúºÎ°ú Ï†ÄÏû•
      const timestamp = new Date(messageData.timestamp).toLocaleString('ko-KR');
      const messageColor = messageData.color || 'black';
      
      if (messageData.type === 'text') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <span style="color: ${messageColor}">${messageData.message.replace(/\n/g, '<br>')}</span> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'image') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <img src="${messageData.message}" class="message-media"> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'video') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <video src="${messageData.message}" controls class="message-media"></video> <span class="timestamp">${timestamp}</span>`;
      } else if (messageData.type === 'voice') {
        p.innerHTML = `<img src="${profilePic}" class="profile-pic"><strong>${messageData.from}:</strong> <audio src="${messageData.message}" controls onplay="pausePolling()" onended="resumePolling()"></audio> <span class="timestamp">${timestamp}</span>`;
      }
      
      // DOMÏóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä (ÏúÑÏπòÏóê Îî∞Îùº)
      if (position === 'prepend') {
        chat.prepend(p);
      } else {
        chat.appendChild(p);
      }
      
      return p; // Ï∂îÍ∞ÄÎêú ÏöîÏÜå Î∞òÌôò
    }
  </script>
</body>
</html>